<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>管理員後台 - 星火廣告</title>

  <!-- Icons + Font -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f19;
      --card:rgba(17,24,42,.86);
      --text:#ffffff;
      --muted:#ffffff;
      --line:rgba(255,255,255,.12);
      --accent:#32e0c4;
      --accent2:#6ea8ff;
      --danger:#ff5c7a;
      --gold:#FFD700;
      --radius:18px;
      --shadow:0 18px 60px rgba(0,0,0,.35);
      --font:"Zen Maru Gothic", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial;
    }

    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      font-family:var(--font);
      background:
        radial-gradient(1100px 500px at 20% -10%, rgba(50,224,196,.16), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(110,168,255,.16), transparent 55%),
        var(--bg);
      color:var(--text);
      font-size:24px;
    }

    .container{width:min(1100px, 92%); margin:0 auto;}
    .section{padding:44px 0;}
    .glass{
      background: var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }

    /* Navbar */
    .navbar{
      position:fixed; top:0; left:0; right:0; z-index:50;
      background: rgba(15, 23, 42, 0.75);
      border-bottom: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
    }
    .nav-container{
      width:min(1200px, 92%);
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 0;
      gap:16px;
      position:relative;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      text-decoration:none; color:var(--text);
      font-weight:800;
    }
    .brand img{
      width:56px; height:56px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      padding:7px;
      object-fit:contain;
      box-shadow: 0 10px 30px rgba(50,224,196,.14);
    }
    .nav-links{
      display:flex; flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
    }
    .nav-link{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 14px;
      border-radius:14px;
      color:var(--text);
      text-decoration:none;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      transition: transform .2s ease, border-color .2s ease, background .2s ease;
      font-size:20px;
      white-space:nowrap;
    }
    .nav-link:hover{
      transform: translateY(-2px);
      border-color: rgba(50,224,196,.45);
      background: rgba(50,224,196,.10);
    }
    .nav-link.danger{
      border-color: rgba(255,92,122,.35);
      background: rgba(255,92,122,.10);
    }
    .nav-link.danger:hover{
      border-color: rgba(255,92,122,.55);
      background: rgba(255,92,122,.18);
    }

    .menu-btn{
      display:none;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--text);
      border-radius:14px;
      padding:10px 14px;
      cursor:pointer;
      font-size:20px;
      line-height:1;
      transition: transform .2s ease, border-color .2s ease, background .2s ease;
    }
    .menu-btn:hover{
      transform: translateY(-2px);
      border-color: rgba(50,224,196,.45);
      background: rgba(50,224,196,.10);
    }

    /* Header */
    .dashboard-header{
      margin-top:92px;
      padding:54px 0 34px;
      position:relative;
      overflow:hidden;
    }
    .dashboard-header::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(900px 360px at 15% 20%, rgba(255,215,0,.10), transparent 60%),
        radial-gradient(900px 420px at 90% 30%, rgba(157,78,221,.12), transparent 55%),
        radial-gradient(900px 520px at 60% 110%, rgba(50,224,196,.10), transparent 60%);
      pointer-events:none;
    }

    /* ===== Loading skeleton (避免閃爍) ===== */
    .is-loading .skeleton{
      position: relative;
      color: transparent !important;
      user-select: none;
    }
    .is-loading .skeleton::before{
      content:"";
      display:block;
      height: 1em;
      border-radius: 12px;
      background: rgba(255,255,255,.10);
    }
    .is-loading .skeleton.wide::before{ width: 90%; }
    .is-loading .skeleton.mid::before{ width: 65%; }
    .is-loading .skeleton.narrow::before{ width: 40%; }
    .is-loading .skeleton::after{
      content:"";
      position:absolute; inset:0;
      border-radius: 12px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
      transform: translateX(-100%);
      animation: sk 1.1s infinite;
    }
    @keyframes sk { 100% { transform: translateX(100%); } }

    .section-head{ text-align:center; margin-bottom: 14px; }
    .section-sub{ margin: 0 auto 18px; max-width: 920px; opacity: .92; font-size: 20px; line-height: 1.7; text-align:center; }
    .card{
      padding:22px;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(17,24,42,.86);
      box-shadow: 0 10px 30px rgba(0,0,0,.28);
    }
    .btn{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 14px;border-radius:14px;
      color: rgba(255,255,255,.92);
      text-decoration:none;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      font-size:18px;
      font-weight:800;
      transition: transform .2s ease, border-color .2s ease, background .2s ease;
    }
    .btn:hover{
      transform: translateY(-2px);
      border-color: rgba(50,224,196,.45);
      background: rgba(50,224,196,.10);
    }
    .btn-primary{
      background: linear-gradient(135deg, rgba(50,224,196,.95), rgba(110,168,255,.95));
      border: 0;
      box-shadow: 0 10px 30px rgba(50,224,196,.14);
    }
    .btn-ghost{
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
      box-shadow: none;
    }
    .btn-ghost:hover{border-color: rgba(50,224,196,.45);}
    .btn-danger{
      border:1px solid rgba(255,92,122,.35);
      background: rgba(255,92,122,.12);
      box-shadow: none;
    }
    .btn-danger:hover{border-color: rgba(255,92,122,.55);}

    .chip{
      display:inline-flex;align-items:center;gap:10px;
      padding:8px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight:900;font-size:16px;
    }
    .chip-strong{
      border-color: rgba(255,215,0,.35);
      background: rgba(255,215,0,.10);
    }
    .chip-success{ border-color: rgba(90,255,190,.35) !important; background: rgba(90,255,190,.10) !important; }
    .chip-warn{ border-color: rgba(255,190,80,.35) !important; background: rgba(255,190,80,.10) !important; }
    .chip-danger{ border-color: rgba(255,92,122,.35) !important; background: rgba(255,92,122,.10) !important; }
    .chip .dot{ width:10px; height:10px; border-radius:999px; background: rgba(255,255,255,.55); display:inline-block; }
    .chip-success .dot{ background: rgba(90,255,190,.95) !important; }
    .chip-warn .dot{ background: rgba(255,190,80,.95) !important; }
    .chip-danger .dot{ background: rgba(255,92,122,.95) !important; }

    /* layout blocks */
    .hero-card{
      position:relative;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 16px;
      padding: 22px;
      border-radius: 26px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(17,24,42,.72);
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }
    .hero-title{margin:10px 0 8px; font-size:44px; font-weight:900;}
    .hero-sub{margin:0; opacity:.9; font-size:20px; line-height:1.7;}
    .hero-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .hero-kicker{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .profile-card{
      padding: 18px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }
    .profile-top{display:flex;gap:12px;align-items:center}
    .avatar{
      width:56px;height:56px;border-radius:18px;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }
    .profile-name{font-size:22px;font-weight:900}
    .profile-sub{font-size:16px;opacity:.8;margin-top:2px}
    .profile-stats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px}
    .pstat{padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,.10);background: rgba(255,255,255,.03)}
    .pstat-label{font-size:14px;opacity:.8}
    .pstat-value{font-size:22px;font-weight:900;margin-top:4px}
    .profile-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}

    .stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:16px}
    .stat-card{padding:16px;border-radius:22px;border:1px solid rgba(255,255,255,.10);background: rgba(255,255,255,.03);display:flex;gap:12px;align-items:center}
    .stat-icon{width:44px;height:44px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.06);display:grid;place-items:center}
    .stat-label{font-size:14px;opacity:.8}
    .stat-value{font-size:22px;font-weight:900;margin-top:2px}

    @media (max-width: 980px){
      .hero-card{grid-template-columns:1fr}
      .stats-row{grid-template-columns:1fr 1fr}
    }
    @media (max-width: 560px){
      .stats-row{grid-template-columns:1fr}
    }

    /* Social verify */
    .sv-grid{
      display:grid;
      grid-template-columns: .95fr 1.05fr;
      gap: 18px;
      align-items: start;
    }
    .sv-detail{
      padding: 18px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      min-height: 360px;
    }
    .sv-detail-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 12px;
    }
    .sv-detail-title{ font-size: 26px; font-weight: 900; }
    .sv-kv{
      display:grid;
      grid-template-columns: 170px 1fr;
      row-gap: 10px;
      column-gap: 12px;
      font-size: 18px;
      line-height: 1.6;
      margin-top: 10px;
    }
    .sv-kv .k{ opacity: .78; }
    .sv-kv .v{ font-weight: 800; word-break: break-word; }
    .sv-link{
      color: rgba(110,168,255,.96);
      text-decoration: none;
      border-bottom: 1px dashed rgba(110,168,255,.45);
      padding-bottom: 1px;
    }
    .sv-link:hover{ filter: brightness(1.12); }
    .sv-form{ margin-top: 14px; }
    .sv-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    @media (max-width: 980px){
      .sv-grid{ grid-template-columns: 1fr; }
      .sv-kv{ grid-template-columns: 150px 1fr; }
    }

    /* Toast */
    .toast-wrap{
      position: fixed;
      right: 18px;
      bottom: 18px;
      display:flex;
      flex-direction: column;
      gap: 10px;
      z-index: 99;
      max-width: min(520px, calc(100vw - 36px));
    }
    .toast{
      width: 100%;
      display:flex;
      gap: 12px;
      align-items:flex-start;
      padding: 14px 16px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(17,24,42,.92);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      font-size: 18px;
      line-height: 1.5;
    }
    .toast-icon{ margin-top: 2px; opacity: .95; }
    .toast-msg{ font-weight: 800; }
    .toast-close{
      margin-left: auto;
      border: 0;
      background: transparent;
      color: rgba(255,255,255,.86);
      cursor: pointer;
      padding: 6px 8px;
      border-radius: 12px;
    }
    .toast-close:hover{ background: rgba(255,255,255,.08); }
    .toast-success{ border-color: rgba(90,255,190,.35); }
    .toast-error{ border-color: rgba(255,92,122,.35); background: rgba(255,92,122,.10); }
    .toast-warn{ border-color: rgba(255,190,80,.35); background: rgba(255,190,80,.10); }
    .toast-info{ border-color: rgba(110,168,255,.28); }

    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:14px}
    .toolbar .left{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .field{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .input, .select{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
      min-height: 40px;
    }
    .input{min-width: 220px}
    .select{min-width: 160px}
    .table-wrap{overflow:auto;border-radius:16px;border:1px solid rgba(255,255,255,.10);background: rgba(255,255,255,.04)}
    table{width:100%;border-collapse:collapse;min-width:820px}
    th,td{padding:12px 14px;text-align:left;border-bottom:1px solid rgba(255,255,255,.08);font-size:14px}
    th{color: rgba(255,255,255,.78);font-weight:700}
    td{color: rgba(255,255,255,.90)}
    tr:hover td{background: rgba(255,255,255,.03)}
    .row-actions{display:flex;gap:8px;flex-wrap:wrap}
    .mini-btn{
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      font-weight:700;
      font-size: 13px;
      display:inline-flex;align-items:center;gap:8px;
    }
    .mini-btn:hover{filter:brightness(1.08)}
    .status-pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight:800;font-size:12px;color: rgba(255,255,255,.90);
      white-space:nowrap;
    }
    .status-dot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.55)}
    .muted{color: rgba(255,255,255,.70)}
    .empty{
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 16px;
      color: rgba(255,255,255,.78);
      line-height: 1.6;
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-container">
      <a class="brand" href="index.html">
        <img src="./picture/logo.png" alt="星火廣告 Logo">
        <span>星火廣告</span>
      </a>

      <button class="menu-btn" id="menuBtn" type="button"
        aria-label="開啟選單" aria-expanded="false" aria-controls="navLinks">
        <i class="fas fa-ellipsis-vertical"></i>
      </button>

      <div class="nav-links" id="navLinks">
        <a href="#top" class="nav-link"><i class="fas fa-gauge-high"></i> 總覽</a>
        <a href="#users" class="nav-link"><i class="fas fa-users"></i> 用戶</a>
        <a href="#social-verify" class="nav-link"><i class="fas fa-circle-check"></i> 社群審核</a>
        <a href="#dealers" class="nav-link"><i class="fas fa-car"></i> 車行</a>
        <a href="#quests" class="nav-link"><i class="fas fa-tasks"></i> 任務</a>
        <a href="#payouts" class="nav-link"><i class="fas fa-sack-dollar"></i> 提領</a>
        <a href="#logs" class="nav-link"><i class="fas fa-clipboard-list"></i> 紀錄</a>

        <span class="nav-sep"></span>

        <a href="dashboard.html" class="nav-link"><i class="fas fa-house-user"></i> 會員中心</a>
        <a href="dealers.html" class="nav-link"><i class="fas fa-shop"></i> 車行頁</a>
        <a href="index.html" class="nav-link"><i class="fas fa-house"></i> 返回首頁</a>

        <span class="nav-sep"></span>

        <a href="#" class="nav-link nav-user" id="navUser">
          <i class="fas fa-user-shield"></i> <span id="navUsername">admin</span>
        </a>
        <a href="#" class="nav-link nav-logout" id="logoutBtn">
          <i class="fas fa-right-from-bracket"></i> 登出
        </a>
      </div>
    </div>
  </nav>

  <!-- Header -->
  <section class="dashboard-header" id="top">
    <div class="container">
      <div class="hero-card">
        <div class="hero-left">
          <div class="hero-kicker">
            <span class="chip chip-strong"><i class="fas fa-crown"></i> Admin</span>

            <!-- ✅ 雲端同步狀態 Badge -->
            <span class="chip" id="syncBadge">
              <span class="dot"></span>
              <span id="syncText">尚未同步</span>
            </span>
          </div>

          <h1 class="hero-title">管理員後台</h1>
          <p class="hero-sub">
            用戶 / 車行 / 任務 / 結算 一站式管理。<span class="muted">（Admin 可進入所有頁面功能）</span>
          </p>

          <div class="hero-actions">
            <a class="btn btn-primary" href="#users"><i class="fas fa-users"></i> 管理用戶</a>
            <a class="btn" href="#dealers"><i class="fas fa-car"></i> 管理車行</a>
            <a class="btn" href="#quests"><i class="fas fa-tasks"></i> 管理任務</a>
          </div>
        </div>

        <div class="hero-right">
          <div class="profile-card">
            <div class="profile-top">
              <div class="avatar">
                <i class="fas fa-user-shield"></i>
              </div>
              <div class="profile-meta">
                <div class="profile-name"><span id="adminName" class="skeleton mid">管理員</span></div>
                <div class="profile-sub">
                  <span id="adminEmail" class="skeleton long">—</span>
                </div>
              </div>
            </div>

            <div class="profile-stats">
              <div class="pstat">
                <div class="pstat-label">總用戶</div>
                <div class="pstat-value"><span id="statUsers" class="skeleton mid">0</span></div>
              </div>
              <div class="pstat">
                <div class="pstat-label">總車行</div>
                <div class="pstat-value"><span id="statDealers" class="skeleton mid">0</span></div>
              </div>
              <div class="pstat">
                <div class="pstat-label">待審核</div>
                <div class="pstat-value"><span id="statPending" class="skeleton mid">0</span></div>
              </div>
              <div class="pstat">
                <div class="pstat-label">待提領</div>
                <div class="pstat-value"><span id="statPayouts" class="skeleton mid">0</span></div>
              </div>
            </div>

            <div class="profile-actions">
              <button class="btn btn-ghost" id="refreshBtn" type="button">
                <i class="fas fa-rotate"></i> 重新同步
              </button>
              <a class="btn btn-ghost" href="dashboard.html">
                <i class="fas fa-house-user"></i> 前往會員中心
              </a>
            </div>
          </div>
        </div>
      </div>

      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-user-plus"></i></div>
          <div class="stat-body">
            <div class="stat-label">今日新增用戶</div>
            <div class="stat-value"><span id="todayUsers" class="skeleton mid">0</span></div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-id-card"></i></div>
          <div class="stat-body">
            <div class="stat-label">待審核車行</div>
            <div class="stat-value"><span id="pendingDealers" class="skeleton mid">0</span></div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-bullhorn"></i></div>
          <div class="stat-body">
            <div class="stat-label">進行中任務</div>
            <div class="stat-value"><span id="activeQuests" class="skeleton mid">0</span></div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-hand-holding-dollar"></i></div>
          <div class="stat-body">
            <div class="stat-label">今日提領申請</div>
            <div class="stat-value"><span id="todayPayouts" class="skeleton mid">0</span></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Users -->
  <section class="section" id="users">
    <div class="container">
      <div class="section-head">
        <h2 class="section-title"><i class="fas fa-users"></i> 用戶管理</h2>
        <p class="section-sub">搜尋、檢視、角色調整（已串接）。停權/解鎖目前先保留 UI 預留。</p>
      </div>

      <div class="card">
        <div class="toolbar">
          <div class="left">
            <div class="field">
              <input class="input" id="userSearch" placeholder="搜尋 user_id / username / email / name" />
              <select class="select" id="userRoleFilter">
                <option value="">全部角色</option>
                <option value="admin">admin</option>
                <option value="dealer">dealer</option>
                <option value="partner">partner</option>
              </select>
              <select class="select" id="userStatusFilter">
                <option value="">全部狀態（預留）</option>
                <option value="active">正常</option>
                <option value="blocked">停權</option>
                <option value="pending">待補資料</option>
              </select>
            </div>
          </div>

          <div class="right">
            <button class="btn btn-ghost" id="usersRefreshBtn" type="button">
              <i class="fas fa-rotate"></i> 重新載入用戶
            </button>
            <button class="btn btn-primary" id="btnCreateUser" type="button">
              <i class="fas fa-user-plus"></i> 新增用戶（規劃）
            </button>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:220px">user_id</th>
                <th style="width:160px">username</th>
                <th style="width:240px">email</th>
                <th style="width:120px">role</th>
                <th style="width:140px">狀態（預留）</th>
                <th style="width:240px">操作</th>
              </tr>
            </thead>
            <tbody id="usersTbody">
              <tr>
                <td colspan="6">
                  <div class="empty" id="usersEmpty">
                    <div><b>尚未載入用戶資料</b></div>
                    <div class="muted">點「重新同步」或「重新載入用戶」。</div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div style="height:14px"></div>
        <div class="muted" id="usersHint">提示：同步後會載入前 200 筆。可用搜尋/角色篩選縮小結果。</div>
      </div>
    </div>
  </section>

  <!-- Social Verify -->
  <section class="section" id="social-verify">
    <div class="container">
      <div class="section-head">
        <h2 class="section-title"><i class="fas fa-circle-check"></i> 社群驗證審核</h2>
        <p class="section-sub">列出所有 <b>submitted</b> 待審核名單，點選後可檢視明細並進行通過/拒絕。</p>
      </div>

      <div class="card">
        <div class="toolbar">
          <div class="left">
            <div class="field">
              <input class="input" id="svSearch" placeholder="搜尋 user_id / username / email" />
              <select class="select" id="svPlatformFilter">
                <option value="">全部平台</option>
                <option value="ig">IG</option>
                <option value="fb">FB</option>
              </select>
            </div>
          </div>

          <div class="right">
            <button class="btn btn-primary" id="svRefreshBtn" type="button">
              <i class="fas fa-rotate"></i> 重新載入待審
            </button>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="sv-grid">
          <div class="sv-col">
            <div class="table-wrap">
              <table style="min-width:760px">
                <thead>
                  <tr>
                    <th style="width:220px">user_id</th>
                    <th style="width:160px">username</th>
                    <th style="width:120px">平台</th>
                    <th style="width:140px">粉絲</th>
                    <th style="width:190px">送審時間</th>
                    <th style="width:120px">操作</th>
                  </tr>
                </thead>
                <tbody id="svTbody">
                  <tr>
                    <td colspan="6">
                      <div class="empty" id="svEmpty">
                        <div><b>尚未載入待審名單</b></div>
                        <div class="muted">點「重新同步」或「重新載入待審」取得最新待審清單。</div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div style="height:10px"></div>
            <div class="muted" id="svHint">提示：此區只顯示 social_status=submitted 的使用者。</div>
          </div>

          <div class="sv-col">
            <div class="sv-detail" id="svDetail">
              <div class="sv-detail-head">
                <div>
                  <div class="sv-detail-title">審核明細</div>
                  <div class="muted" id="svDetailSub">請先從左側點選一位待審使用者</div>
                </div>
                <span class="status-pill" id="svStatusPill" style="display:none">
                  <span class="status-dot" id="svStatusDot"></span>
                  <span id="svStatusText">submitted</span>
                </span>
              </div>

              <div class="sv-kv" id="svKv" style="display:none">
                <div class="k">user_id</div><div class="v" id="svUserId">-</div>
                <div class="k">username</div><div class="v" id="svUsername">-</div>
                <div class="k">email</div><div class="v" id="svEmail">-</div>
                <div class="k">followers</div><div class="v" id="svFollowers">-</div>
                <div class="k">avg_views_7d</div><div class="v" id="svViews">-</div>
                <div class="k">IG</div><div class="v"><a class="sv-link" id="svIg" href="#" target="_blank" rel="noopener">-</a></div>
                <div class="k">FB</div><div class="v"><a class="sv-link" id="svFb" href="#" target="_blank" rel="noopener">-</a></div>
                <div class="k">截圖</div><div class="v"><a class="sv-link" id="svShot" href="#" target="_blank" rel="noopener">-</a></div>
                <div class="k">user_type</div><div class="v" id="svUserType">-</div>
                <div class="k">region</div><div class="v" id="svRegion">-</div>
                <div class="k">brand_desc</div><div class="v" id="svBrand">-</div>
                <div class="k">audience_desc</div><div class="v" id="svAudience">-</div>
                <div class="k">送審時間</div><div class="v" id="svSubmittedAt">-</div>
              </div>

              <div class="sv-form" id="svForm" style="display:none">
                <div class="field">
                  <label class="muted" style="min-width:120px">primary_platform</label>
                  <select class="select" id="svPlatform">
                    <option value="">請選平台</option>
                    <option value="ig">ig</option>
                    <option value="fb">fb</option>
                  </select>
                </div>

                <div class="field">
                  <label class="muted" style="min-width:120px">influence_tier</label>
                  <select class="select" id="svTier">
                    <option value="">請選 Tier</option>
                    <option value="C">C</option>
                    <option value="B">B</option>
                    <option value="A">A</option>
                    <option value="S">S</option>
                  </select>
                </div>

                <div class="sv-actions">
                  <button class="btn btn-primary" id="svApproveBtn" type="button">
                    <i class="fas fa-check"></i> 通過
                  </button>
                  <button class="btn btn-danger" id="svRejectBtn" type="button">
                    <i class="fas fa-xmark"></i> 拒絕
                  </button>
                </div>

                <div class="muted" id="svAdminNote" style="margin-top:10px">
                  通過時可設定平台/Tier；拒絕會關閉權限（can_take_tasks / can_withdraw）。
                </div>
              </div>

              <div class="empty" id="svDetailEmpty">
                <div><b>尚未選擇待審使用者</b></div>
                <div class="muted">從左側名單點選「檢視」，即可在此看到明細並審核。</div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- （下方 dealers/quests/payouts/logs 先保留原本預留，不影響本輪重點） -->
  <section class="section" id="dealers">
    <div class="container">
      <div class="section-head">
        <h2 class="section-title"><i class="fas fa-car"></i> 車行管理</h2>
        <p class="section-sub">此區維持 UI 預留（本輪先專注：用戶管理 + 社群審核）。</p>
      </div>
      <div class="card">
        <div class="empty">
          <div><b>尚未串接</b></div>
          <div class="muted">下一輪要做車行審核時再補對應節點。</div>
        </div>
      </div>
    </div>
  </section>

  <section class="section" id="quests">
    <div class="container">
      <div class="section-head">
        <h2 class="section-title"><i class="fas fa-tasks"></i> 任務管理</h2>
        <p class="section-sub">此區維持 UI 預留。</p>
      </div>
      <div class="card">
        <div class="empty"><b>尚未串接</b></div>
      </div>
    </div>
  </section>

  <section class="section" id="payouts">
    <div class="container">
      <div class="section-head">
        <h2 class="section-title"><i class="fas fa-sack-dollar"></i> 提領/結算</h2>
        <p class="section-sub">此區維持 UI 預留。</p>
      </div>
      <div class="card">
        <div class="empty"><b>尚未串接</b></div>
      </div>
    </div>
  </section>

  <section class="section" id="logs">
    <div class="container">
      <div class="section-head">
        <h2 class="section-title"><i class="fas fa-clipboard-list"></i> 操作紀錄</h2>
        <p class="section-sub">此區維持 UI 預留。</p>
      </div>
      <div class="card">
        <div class="empty"><b>尚未串接</b></div>
      </div>
    </div>
  </section>

  <div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

  <script>
    function requireLogin(){
      const token = localStorage.getItem('xinghuo_token');
      const u = JSON.parse(localStorage.getItem('xinghuo_user') || 'null');
      if (!token || !u) {
        location.href = './login.html';
        return null;
      }
      return { token, user: u };
    }

    function guardAdmin(user){
      const role = (user && user.role) ? String(user.role).toLowerCase() : '';
      if (role !== 'admin') {
        location.href = './dashboard.html';
      }
    }

    const $ = (sel) => document.querySelector(sel);
    const escapeHtml = (s) => String(s ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');

    function showToast(message, type='info'){
      const wrap = $('#toastWrap');
      if(!wrap) return;
      const iconMap = {
        success:'fa-circle-check',
        error:'fa-triangle-exclamation',
        warn:'fa-circle-exclamation',
        info:'fa-circle-info'
      };
      const el = document.createElement('div');
      el.className = 'toast ' + (type ? ('toast-' + type) : 'toast-info');
      el.innerHTML = `
        <div class="toast-icon"><i class="fas ${iconMap[type] || 'fa-circle-info'}"></i></div>
        <div class="toast-body">
          <div class="toast-msg">${escapeHtml(message)}</div>
        </div>
        <button class="toast-close" aria-label="關閉"><i class="fas fa-xmark"></i></button>
      `;
      wrap.appendChild(el);
      const close = () => el.remove();
      el.querySelector('.toast-close')?.addEventListener('click', close);
      setTimeout(close, 4200);
    }

    function setSyncBadge(state){
      const badge = $('#syncBadge');
      const text = $('#syncText');
      if(!badge || !text) return;
      badge.classList.remove('chip-success','chip-warn','chip-danger');
      if(state === 'syncing'){
        text.textContent = '同步中';
        badge.classList.add('chip-warn');
      } else if(state === 'ok'){
        text.textContent = '已同步';
        badge.classList.add('chip-success');
      } else if(state === 'fail'){
        text.textContent = '失敗';
        badge.classList.add('chip-danger');
      } else {
        text.textContent = '尚未同步';
      }
    }

    function setSkeleton(on){
      document.body.classList.toggle("is-loading", !!on);
      const ids = [
        '#adminName','#adminEmail',
        '#statUsers','#statDealers','#statPending','#statPayouts',
        '#todayUsers','#pendingDealers','#activeQuests','#todayPayouts'
      ];
      ids.forEach(id => {
        const el = $(id);
        if(!el) return;
        if(on) el.classList.add('skeleton');
        else el.classList.remove('skeleton');
      });
    }

    (function initMenu(){
      const btn = $('#menuBtn');
      const links = $('#navLinks');
      if(!btn || !links) return;
      btn.addEventListener('click', () => {
        const open = links.classList.toggle('open');
        btn.setAttribute('aria-expanded', open ? 'true' : 'false');
      });
      links.querySelectorAll('a.nav-link').forEach(a => {
        a.addEventListener('click', () => {
          links.classList.remove('open');
          btn.setAttribute('aria-expanded','false');
        });
      });
    })();

    function logout(){
      localStorage.removeItem('xinghuo_token');
      localStorage.removeItem('xinghuo_user');
      localStorage.removeItem('xinghuo_my_quests');
      location.href = './index.html';
    }
    $('#logoutBtn')?.addEventListener('click', (e)=>{ e.preventDefault(); logout(); });

    async function adminApi(token, payload){
      const res = await fetch('/.netlify/functions/admin', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(payload || {})
      });
      if(!res.ok){
        const t = await res.text().catch(()=> '');
        throw new Error('admin api ' + res.status + ': ' + (t || res.statusText));
      }
      return await res.json();
    }

    // ===== Users (Admin) =====
    let USERS_CACHE = [];
    let USERS_TOTAL = 0;
    let USERS_OFFSET = 0;
    const USERS_LIMIT = 200;

    async function fetchUsersList(token, { q = "", role = "", limit = USERS_LIMIT, offset = 0 } = {}){
      return adminApi(token, { action: 'users_list', q, role, limit, offset });
    }

    async function fetchUserDetail(token, target_user_id){
      return adminApi(token, { action: 'users_get', target_user_id });
    }

    async function updateUserRole(token, target_user_id, role){
      return adminApi(token, { action: 'users_update_role', target_user_id, role });
    }

    function getUsersQueryState(){
      const q = ($('#userSearch')?.value || '').trim();
      const role = ($('#userRoleFilter')?.value || '').trim().toLowerCase();
      return { q, role };
    }

    async function loadUsers({ silent = false } = {}){
      const auth = requireLogin();
      if(!auth) return;
      guardAdmin(auth.user);

      const { q, role } = getUsersQueryState();

      if(!silent) showToast('載入用戶中…', 'info');

      try{
        const out = await fetchUsersList(auth.token, { q, role, limit: USERS_LIMIT, offset: USERS_OFFSET });
        USERS_CACHE = out?.items || [];
        USERS_TOTAL = Number(out?.total || 0);
        renderUsers(USERS_CACHE);

        const hint = $('#usersHint');
        if(hint){
          hint.textContent = `已載入 ${USERS_CACHE.length} 筆（total ${USERS_TOTAL}）。目前先顯示前 ${USERS_LIMIT} 筆，可用搜尋/角色篩選縮小結果。`;
        }
      } catch(err){
        USERS_CACHE = [];
        USERS_TOTAL = 0;
        renderUsers([]);
        showToast('載入用戶失敗：' + (err?.message || err), 'error');
      }
    }

    function formatUserForAlert(userObj){
      const keys = Object.keys(userObj || {});
      keys.sort();
      const lines = keys.map(k => `${k}: ${userObj[k]}`);
      return lines.join('\n');
    }

    async function onUserView(userId){
      const auth = requireLogin();
      if(!auth) return;
      guardAdmin(auth.user);

      try{
        const out = await fetchUserDetail(auth.token, userId);
        const user = out?.user || {};
        alert(formatUserForAlert(user));
      } catch(err){
        showToast('讀取用戶資料失敗：' + (err?.message || err), 'error');
      }
    }

    async function onUserChangeRole(userId, currentRole){
      const auth = requireLogin();
      if(!auth) return;
      guardAdmin(auth.user);

      const next = prompt('輸入新角色（admin / dealer / partner）', (currentRole || '').toLowerCase());
      if(next == null) return;
      const role = String(next).trim().toLowerCase();
      if(!['admin','dealer','partner'].includes(role)){
        showToast('角色不合法：請輸入 admin / dealer / partner', 'warn');
        return;
      }

      if(!confirm(`確定要把 ${userId} 的角色改成 ${role} 嗎？`)) return;

      try{
        await updateUserRole(auth.token, userId, role);
        showToast('角色已更新', 'success');
        await loadUsers({ silent: true });
      } catch(err){
        showToast('更新角色失敗：' + (err?.message || err), 'error');
      }
    }

    function wireUserRowActions(){
      const tbody = $('#usersTbody');
      if(!tbody) return;

      tbody.querySelectorAll('tr[data-userid]').forEach(tr => {
        const uid = tr.getAttribute('data-userid');
        if(!uid) return;

        const btnView = tr.querySelector('button[data-act="view"]');
        const btnRole = tr.querySelector('button[data-act="role"]');
        const btnBlock = tr.querySelector('button[data-act="block"]');

        btnView?.addEventListener('click', () => onUserView(uid));

        btnRole?.addEventListener('click', () => {
          const roleCell = tr.querySelector('td:nth-child(4)')?.textContent || '';
          onUserChangeRole(uid, roleCell);
        });

        btnBlock?.addEventListener('click', () => {
          showToast('停權/解鎖：目前為 UI 預留（需要先定義 users sheet 欄位/規則）', 'info');
        });
      });
    }

    let usersReloadTimer = null;
    function scheduleUsersReload(){
      if(usersReloadTimer) clearTimeout(usersReloadTimer);
      usersReloadTimer = setTimeout(() => loadUsers({ silent: true }), 320);
    }

    // ===== Social verify (Admin) =====
    let SV_LIST = [];
    let SV_SELECTED_USER_ID = "";

    async function fetchSocialSubmitted(token){
      return adminApi(token, { action: 'social_list_submitted' });
    }
    async function fetchSocialDetail(token, target_user_id){
      return adminApi(token, { action: 'social_get', target_user_id });
    }
    async function socialApprove(token, target_user_id, primary_platform, influence_tier){
      return adminApi(token, {
        action: 'social_approve',
        target_user_id,
        data: { primary_platform, influence_tier }
      });
    }
    async function socialReject(token, target_user_id){
      return adminApi(token, { action: 'social_reject', target_user_id });
    }

    function normalizePlatformForUI(item){
      const s = (item?.primary_platform || item?.suggest_platform || '').toLowerCase();
      if(s === 'instagram') return 'ig';
      if(s === 'facebook') return 'fb';
      return s;
    }

    function renderSocialList(list){
      const tbody = $('#svTbody');
      if(!tbody) return;

      const q = ($('#svSearch')?.value || '').trim().toLowerCase();
      const pf = ($('#svPlatformFilter')?.value || '').trim().toLowerCase();

      const filtered = (list || []).filter(it => {
        const text = `${it.user_id||''} ${it.username||''} ${it.email||''}`.toLowerCase();
        let ok = !q || text.includes(q);
        if(ok && pf){
          const p = normalizePlatformForUI(it);
          ok = p === pf;
        }
        return ok;
      });

      if(!filtered.length){
        tbody.innerHTML = `
          <tr><td colspan="6">
            <div class="empty">
              <div><b>目前沒有待審名單</b></div>
              <div class="muted">當使用者 submit 後（social_status=submitted）才會出現在此處。</div>
            </div>
          </td></tr>
        `;
        return;
      }

      tbody.innerHTML = filtered.map(it => {
        const p = normalizePlatformForUI(it) || '-';
        const submittedAt = it.social_submitted_at ? new Date(it.social_submitted_at).toLocaleString() : '-';
        const followers = (it.followers_count ?? '').toString() || '-';
        return `
          <tr data-userid="${escapeHtml(it.user_id || '')}">
            <td>${escapeHtml(it.user_id || '')}</td>
            <td>${escapeHtml(it.username || '')}</td>
            <td><span class="status-pill"><span class="status-dot" style="background:rgba(110,168,255,.95)"></span>${escapeHtml(p)}</span></td>
            <td>${escapeHtml(followers)}</td>
            <td>${escapeHtml(submittedAt)}</td>
            <td>
              <button class="mini-btn" data-act="sv_view" data-userid="${escapeHtml(it.user_id || '')}">
                <i class="fas fa-eye"></i> 檢視
              </button>
            </td>
          </tr>
        `;
      }).join('');

      tbody.querySelectorAll('button[data-act="sv_view"]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const uid = btn.getAttribute('data-userid');
          if(uid) await openSocialDetail(uid);
        });
      });
    }

    function setPill(status){
      const pill = $('#svStatusPill');
      const dot = $('#svStatusDot');
      const text = $('#svStatusText');
      if(!pill || !dot || !text) return;
      pill.style.display = 'inline-flex';
      text.textContent = status || '-';
      let color = 'rgba(255,255,255,.55)';
      if(status === 'submitted') color = 'rgba(255,190,80,.95)';
      if(status === 'approved') color = 'rgba(90,255,190,.95)';
      if(status === 'rejected') color = 'rgba(255,92,122,.95)';
      dot.style.background = color;
    }

    function fillLink(aEl, url){
      if(!aEl) return;
      const u = (url || '').trim();
      if(!u){
        aEl.textContent = '-';
        aEl.href = '#';
        aEl.style.pointerEvents = 'none';
        aEl.style.opacity = '.75';
        return;
      }
      aEl.textContent = u;
      aEl.href = u;
      aEl.style.pointerEvents = '';
      aEl.style.opacity = '1';
    }

    async function openSocialDetail(userId){
      const auth = requireLogin();
      if(!auth) return;
      guardAdmin(auth.user);

      SV_SELECTED_USER_ID = userId;
      $('#svDetailSub').textContent = '載入中…';
      $('#svDetailEmpty').style.display = 'none';
      $('#svKv').style.display = 'none';
      $('#svForm').style.display = 'none';
      $('#svStatusPill').style.display = 'none';

      try{
        const data = await fetchSocialDetail(auth.token, userId);
        const s = data?.social || {};
        setPill(s.social_status || 'submitted');

        $('#svUserId').textContent = data.user_id || userId;
        $('#svUsername').textContent = data.username || '-';
        $('#svEmail').textContent = data.email || '-';
        $('#svFollowers').textContent = s.followers_count || '-';
        $('#svViews').textContent = s.avg_views_7d || '-';
        fillLink($('#svIg'), s.ig_url || '');
        fillLink($('#svFb'), s.fb_url || '');
        fillLink($('#svShot'), s.social_screenshot_url || '');
        $('#svUserType').textContent = s.user_type || '-';
        $('#svRegion').textContent = s.region || '-';
        $('#svBrand').textContent = s.brand_desc || '-';
        $('#svAudience').textContent = s.audience_desc || '-';
        $('#svSubmittedAt').textContent = s.social_submitted_at ? new Date(s.social_submitted_at).toLocaleString() : '-';

        const suggest = normalizePlatformForUI(s) || normalizePlatformForUI(data) || '';
        $('#svPlatform').value = suggest || '';
        $('#svTier').value = '';

        $('#svDetailSub').textContent = '請確認資料後進行審核（僅 submitted 可審）';
        $('#svKv').style.display = '';
        $('#svForm').style.display = '';
      } catch(err){
        $('#svDetailEmpty').style.display = '';
        $('#svDetailSub').textContent = '讀取失敗（請稍後再試）';
        showToast('讀取待審明細失敗：' + (err?.message || err), 'error');
      }
    }

    async function loadSocialSubmitted(){
      const auth = requireLogin();
      if(!auth) return;
      guardAdmin(auth.user);

      const hint = $('#svHint');
      if(hint) hint.textContent = '載入中…';
      try{
        const out = await fetchSocialSubmitted(auth.token);
        SV_LIST = out?.items || [];
        renderSocialList(SV_LIST);

        const pendingEl = $('#statPending');
        if(pendingEl) pendingEl.textContent = String(SV_LIST.length);

        if(hint) hint.textContent = `提示：此區只顯示 social_status=submitted 的使用者（目前 ${SV_LIST.length} 筆）。`;
      } catch(err){
        SV_LIST = [];
        renderSocialList([]);
        if(hint) hint.textContent = '載入失敗：請確認你已佈署最新 Netlify Functions。';
        showToast('載入待審清單失敗：' + (err?.message || err), 'warn');
      }
    }

    function wireSocialVerifyUI(){
      $('#svSearch')?.addEventListener('input', ()=>renderSocialList(SV_LIST));
      $('#svPlatformFilter')?.addEventListener('change', ()=>renderSocialList(SV_LIST));
      $('#svRefreshBtn')?.addEventListener('click', loadSocialSubmitted);

      $('#svApproveBtn')?.addEventListener('click', async ()=>{
        const auth = requireLogin();
        if(!auth) return;
        guardAdmin(auth.user);

        if(!SV_SELECTED_USER_ID){
          showToast('請先選擇一位待審使用者', 'info');
          return;
        }
        const platform = ($('#svPlatform')?.value || '').trim();
        const tier = ($('#svTier')?.value || '').trim();
        if(!platform){ showToast('請選擇 primary_platform', 'warn'); return; }
        if(!tier){ showToast('請選擇 influence_tier', 'warn'); return; }

        try{
          await socialApprove(auth.token, SV_SELECTED_USER_ID, platform, tier);
          showToast('已通過審核（approved）', 'success');
          await loadSocialSubmitted();
          await openSocialDetail(SV_SELECTED_USER_ID);
        } catch(err){
          showToast('通過失敗：' + (err?.message || err), 'error');
        }
      });

      $('#svRejectBtn')?.addEventListener('click', async ()=>{
        const auth = requireLogin();
        if(!auth) return;
        guardAdmin(auth.user);

        if(!SV_SELECTED_USER_ID){
          showToast('請先選擇一位待審使用者', 'info');
          return;
        }
        try{
          await socialReject(auth.token, SV_SELECTED_USER_ID);
          showToast('已拒絕（rejected）', 'success');
          await loadSocialSubmitted();
          await openSocialDetail(SV_SELECTED_USER_ID);
        } catch(err){
          showToast('拒絕失敗：' + (err?.message || err), 'error');
        }
      });
    }

    function renderUsers(users=[]){
      const tbody = $('#usersTbody');
      if(!tbody) return;
      if(!users.length){
        tbody.innerHTML = `
          <tr><td colspan="6">
            <div class="empty">
              <div><b>目前沒有資料</b></div>
              <div class="muted">你可以先用 UI；確認 Netlify Functions 已佈署後再同步。</div>
            </div>
          </td></tr>
        `;
        return;
      }

      tbody.innerHTML = users.map(u => {
        const role = (u.role || '').toLowerCase();
        const statusLabel = '正常（預留）';
        const dotColor = 'rgba(90,255,190,.95)';
        return `
          <tr data-userid="${escapeHtml(u.user_id || '')}">
            <td>${escapeHtml(u.user_id || '')}</td>
            <td>${escapeHtml(u.username || '')}</td>
            <td>${escapeHtml(u.email || '')}</td>
            <td><span class="status-pill"><span class="status-dot" style="background:${dotColor}"></span>${escapeHtml(role || '-')}</span></td>
            <td><span class="status-pill"><span class="status-dot" style="background:${dotColor}"></span>${statusLabel}</span></td>
            <td>
              <div class="row-actions">
                <button class="mini-btn" data-act="view"><i class="fas fa-eye"></i> 檢視</button>
                <button class="mini-btn" data-act="role"><i class="fas fa-user-tag"></i> 改角色</button>
                <button class="mini-btn" data-act="block"><i class="fas fa-ban"></i> 停權</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      wireUserRowActions();
    }

    function applySnapshotUI(snapshot){
      const s = snapshot?.stats || {};
      const set = (id, val) => { const el = $(id); if(el) el.textContent = String(val ?? 0); };
      set('#statUsers', s.users);
      set('#statDealers', s.dealers);
      set('#statPending', s.pending);
      set('#statPayouts', s.payouts);
      set('#todayUsers', s.todayUsers);
      set('#pendingDealers', s.pendingDealers);
      set('#activeQuests', s.activeQuests);
      set('#todayPayouts', s.todayPayouts);

      USERS_CACHE = snapshot?.users || [];
      USERS_TOTAL = Number(snapshot?.stats?.users || 0);
      renderUsers(USERS_CACHE);
    }

    async function syncAll(){
      const auth = requireLogin();
      if(!auth) return;
      guardAdmin(auth.user);

      $('#navUsername').textContent = auth.user.username || auth.user.name || 'admin';
      $('#adminName').textContent = auth.user.name || auth.user.username || '管理員';
      $('#adminEmail').textContent = auth.user.email || '-';

      setSkeleton(true);
      setSyncBadge('syncing');

      try{
        const snap = await adminApi(auth.token, { action: 'snapshot' });
        applySnapshotUI(snap);
        await loadSocialSubmitted();
        setSyncBadge('ok');
        showToast('同步完成', 'success');
      } catch (err){
        setSyncBadge('fail');
        showToast('同步失敗：請確認 Netlify Functions 已佈署', 'warn');
        applySnapshotUI({ stats: { users:0, dealers:0, pending:0, payouts:0, todayUsers:0, pendingDealers:0, activeQuests:0, todayPayouts:0 }, users: [] });
      } finally{
        setSkeleton(false);
      }
    }

    function wireFilters(){
      function filterUsers(){
        const q = ($('#userSearch')?.value || '').trim().toLowerCase();
        const role = ($('#userRoleFilter')?.value || '').trim().toLowerCase();
        const st = ($('#userStatusFilter')?.value || '').trim().toLowerCase();
        const rows = Array.from($('#usersTbody')?.querySelectorAll('tr') || []);
        rows.forEach(r => {
          const text = (r.textContent || '').toLowerCase();
          let ok = !q || text.includes(q);
          if(ok && role) ok = text.includes(role);
          if(ok && st) ok = ok; // 預留
          r.style.display = ok ? '' : 'none';
        });
      }

      $('#userSearch')?.addEventListener('input', () => { filterUsers(); scheduleUsersReload(); });
      $('#userRoleFilter')?.addEventListener('change', () => { filterUsers(); scheduleUsersReload(); });
      $('#userStatusFilter')?.addEventListener('change', filterUsers);
    }

    $('#refreshBtn')?.addEventListener('click', syncAll);
    $('#usersRefreshBtn')?.addEventListener('click', () => loadUsers({ silent: false }));
    $('#btnCreateUser')?.addEventListener('click', ()=>showToast('此功能為 UI 預留，後端串接後即可使用。','info'));

    (function init(){
      const auth = requireLogin();
      if(!auth) return;
      guardAdmin(auth.user);
      wireFilters();
      wireSocialVerifyUI();
      syncAll();
    })();
  </script>
</body>
</html>
