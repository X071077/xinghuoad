<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>管理員審核 - 星火廣告</title>
  <style>
    :root{--bg:#0b0f19;--text:rgba(255,255,255,.92);--muted:rgba(255,255,255,.7);--line:rgba(255,255,255,.1)}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .bar{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);padding:12px 14px;border-radius:14px;background:rgba(255,255,255,.04)}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.04);color:var(--text);cursor:pointer}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    .card{border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.04);padding:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input{padding:10px 10px;border-radius:10px;border:1px solid var(--line);background:rgba(0,0,0,.25);color:var(--text)}
    img{max-width:100%;border-radius:12px;border:1px solid var(--line)}
    a{color:#9bd3ff}
    .muted{color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <div>
        <div style="font-weight:900">Admin 審核</div>
        <div class="muted">只顯示 SUBMITTED 的回傳</div>
      </div>
      <div class="row">
        <button class="btn" id="reload">重新載入</button>
        <button class="btn" id="logout">登出</button>
      </div>
    </div>

    <div id="list" class="grid"></div>
  </div>

<script type="module">
  function getToken(){ return localStorage.getItem("xinghuo_token") || ""; }
  function getUser(){ try{return JSON.parse(localStorage.getItem("xinghuo_user")||"null");}catch{return null;} }
  function requireLogin(){
    const t=getToken(), u=getUser();
    if(!t||!u){ location.href="login.html"; return null; }
    return {t,u};
  }
  const ctx=requireLogin(); if(!ctx) throw new Error("no login");

  document.getElementById("logout").onclick=()=>{
    localStorage.removeItem("xinghuo_token");
    localStorage.removeItem("xinghuo_user");
    localStorage.removeItem("xinghuo_my_quests");
    location.href="index.html";
  };

  async function loadConfig(){
    const r=await fetch("/.netlify/functions/public-config");
    const j=await r.json();
    if(!j.ok) throw new Error(j.error||"public-config failed");
    window.SUPABASE_URL=j.supabaseUrl;
  }
  await loadConfig();

  function publicUrl(bucketPath){
    // bucketPath 形如：public-assets/tasks/xxx.jpg
    const s=String(bucketPath||"").trim();
    if(!s) return "";
    const parts=s.split("/");
    const bucket=parts.shift();
    const path=parts.join("/");
    return `${window.SUPABASE_URL}/storage/v1/object/public/${bucket}/${path}`;
  }

  async function signView(path){
    const r=await fetch("/.netlify/functions/storage-sign-view",{
      method:"POST",
      headers:{ "Content-Type":"application/json","Authorization":"Bearer "+getToken() },
      body: JSON.stringify({ path })
    });
    const j=await r.json();
    if(!r.ok||!j.ok) throw new Error(j.error||"sign view failed");
    return j.signedViewUrl;
  }

  async function listAll(){
    // 先用 tasks-list 拿 tasks（admin 看全部），再自己讀 submissions + claims
    // 為了簡化：這裡直接打兩個 endpoints（你現在有的）
    const [tasksR, claimsR, subsR] = await Promise.all([
      fetch("/.netlify/functions/tasks-list",{ headers:{Authorization:"Bearer "+getToken()} }),
      fetch("/.netlify/functions/_admin-claims",{ headers:{Authorization:"Bearer "+getToken()} }).catch(()=>null),
      fetch("/.netlify/functions/_admin-subs",{ headers:{Authorization:"Bearer "+getToken()} }).catch(()=>null),
    ]);

    // 注意：這兩支 _admin-* 我下一輪可以給你更乾淨的「admin-list」一支搞定
    // 你先用下面 fallback：直接用 tasks-list + 再用 Google Sheets function（目前未提供）會麻煩
    // 所以我先在這頁做最小可用：若 _admin-* 沒有，就先提示你要補這兩支 function。

    const tasksJ = await tasksR.json().catch(()=>({}));
    if(!tasksR.ok||!tasksJ.ok) throw new Error(tasksJ.error||"tasks-list failed");

    if(!claimsR || !subsR){
      throw new Error("缺少 admin 列表 endpoints（我下一則會補：admin-list.js）");
    }

    const claimsJ = await claimsR.json().catch(()=>({}));
    const subsJ = await subsR.json().catch(()=>({}));
    if(!claimsJ.ok) throw new Error(claimsJ.error||"_admin-claims failed");
    if(!subsJ.ok) throw new Error(subsJ.error||"_admin-subs failed");

    return { tasks: tasksJ.tasks, claims: claimsJ.claims, subs: subsJ.subs };
  }

  function el(tag, attrs={}, html=""){
    const e=document.createElement(tag);
    for(const [k,v] of Object.entries(attrs)){
      if(k==="class") e.className=v;
      else e.setAttribute(k,v);
    }
    e.innerHTML=html;
    return e;
  }

  async function render(){
    const box=document.getElementById("list");
    box.innerHTML = `<div class="muted">載入中…</div>`;

    try{
      const {tasks, claims, subs} = await listAll();

      const tasksById = new Map(tasks.map(t=>[String(t.task_id), t]));
      const subsByClaim = new Map(subs.map(s=>[String(s.claim_id), s]));

      const submitted = claims.filter(c=>String(c.status)==="SUBMITTED");

      if(submitted.length===0){
        box.innerHTML = `<div class="muted">目前沒有待審核回傳</div>`;
        return;
      }

      box.innerHTML="";
      for(const c of submitted){
        const t = tasksById.get(String(c.task_id)) || {};
        const s = subsByClaim.get(String(c.claim_id)) || {};
        const card = el("div",{class:"card"});

        const shareImgUrl = publicUrl(s.share_screenshot_path);
        const shareLink = String(s.share_link||"");

        card.appendChild(el("div",{},`
          <div style="font-weight:900">claim_id：${c.claim_id}</div>
          <div class="muted">task_id：${c.task_id}｜user_id：${c.user_id}</div>
          <div class="muted">車輛資訊：${(t.vehicle_text||"").toString().slice(0,80)}...</div>
        `));

        if(shareLink){
          card.appendChild(el("div",{class:"muted"},`轉發連結：<a href="${shareLink}" target="_blank">${shareLink}</a>`));
        }

        if(shareImgUrl){
          const img = new Image();
          img.src = shareImgUrl;
          img.alt = "share screenshot";
          img.style.marginTop="10px";
          card.appendChild(img);
        }

        // insights（admin-only）
        if(s.insights_screenshot_path){
          const btn = el("button",{class:"btn",style:"margin-top:10px"}, "載入瀏覽量截圖（admin-only）");
          btn.onclick = async ()=>{
            btn.disabled=true;
            try{
              // s.insights_screenshot_path 形如：admin-only/proof/...
              const parts = String(s.insights_screenshot_path).split("/");
              parts.shift(); // remove bucket
              const path = parts.join("/");
              const url = await signView(path);
              const img = new Image();
              img.src = url;
              img.alt = "insights";
              img.style.marginTop="10px";
              card.appendChild(img);
              btn.remove();
            }catch(e){
              alert(e.message||"載入失敗");
              btn.disabled=false;
            }
          };
          card.appendChild(btn);
        }

        // 審核操作
        const control = el("div",{class:"row",style:"margin-top:12px"},`
          <input id="coin_${c.claim_id}" placeholder="coin" value="0" style="width:90px">
          <input id="xp_${c.claim_id}" placeholder="xp" value="0" style="width:90px">
          <input id="pt_${c.claim_id}" placeholder="point" value="0" style="width:90px">
          <input id="note_${c.claim_id}" placeholder="退件原因(可留空)" style="width:260px">
        `);

        const approve = el("button",{class:"btn"},"通過");
        approve.onclick = async ()=>{
          approve.disabled=true;
          try{
            const coin = Number(document.getElementById(`coin_${c.claim_id}`).value||0);
            const xp = Number(document.getElementById(`xp_${c.claim_id}`).value||0);
            const point = Number(document.getElementById(`pt_${c.claim_id}`).value||0);
            const review_note = String(document.getElementById(`note_${c.claim_id}`).value||"");
            const r=await fetch("/.netlify/functions/tasks-review",{
              method:"POST",
              headers:{ "Content-Type":"application/json","Authorization":"Bearer "+getToken() },
              body: JSON.stringify({ claim_id:c.claim_id, decision:"APPROVE", coin,xp,point, review_note })
            });
            const j=await r.json();
            if(!r.ok||!j.ok) throw new Error(j.error||"review failed");
            alert("已通過並發放（若填了數量）");
            render();
          }catch(e){
            alert(e.message||"失敗");
            approve.disabled=false;
          }
        };

        const reject = el("button",{class:"btn"},"退回");
        reject.onclick = async ()=>{
          reject.disabled=true;
          try{
            const review_note = String(document.getElementById(`note_${c.claim_id}`).value||"");
            const r=await fetch("/.netlify/functions/tasks-review",{
              method:"POST",
              headers:{ "Content-Type":"application/json","Authorization":"Bearer "+getToken() },
              body: JSON.stringify({ claim_id:c.claim_id, decision:"REJECT", review_note })
            });
            const j=await r.json();
            if(!r.ok||!j.ok) throw new Error(j.error||"reject failed");
            alert("已退回");
            render();
          }catch(e){
            alert(e.message||"失敗");
            reject.disabled=false;
          }
        };

        control.appendChild(approve);
        control.appendChild(reject);
        card.appendChild(control);

        box.appendChild(card);
      }

    }catch(e){
      box.innerHTML = `<div class="muted">載入失敗：${e.message||"未知錯誤"}</div>`;
    }
  }

  document.getElementById("reload").onclick=render;
  render();
</script>
</body>
</html>
