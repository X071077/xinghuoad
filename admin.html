<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>管理員後台 - 星火廣告</title>

  <!-- Icons + Font -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f19;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.04);
      --line:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.74);
      --shadow:0 18px 60px rgba(0,0,0,.28);
      --radius:16px;
      --max:1200px;

      --primary:#7c5cff;
      --primary2:#4aa3ff;
      --good:#3ddc97;
      --warn:#ffbe4d;
      --bad:#ff465a;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:"Zen Maru Gothic", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      background: radial-gradient(1100px 600px at 20% -10%, rgba(124,92,255,.25), transparent 60%),
                  radial-gradient(900px 600px at 110% 30%, rgba(74,163,255,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }

    a{ color:inherit; text-decoration:none; }
    .container{ width:min(var(--max), 92vw); margin:0 auto; }

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:50;
      background: rgba(11,15,25,.72);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .topbar-inner{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 0;
      gap:14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800;
      letter-spacing:.4px;
    }
    .brand img{
      width:36px; height:36px;
      border-radius:10px;
      box-shadow:0 12px 30px rgba(0,0,0,.35);
      background:rgba(255,255,255,.08);
      object-fit:contain;
    }
    .nav{
      display:flex; align-items:center; gap:10px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(255,255,255,.05);
      font-weight:700;
      color:var(--muted);
    }
    .pill b{ color:var(--text); }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      transition:transform .12s ease, background .12s ease, border-color .12s ease;
      font-weight:800;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.18); }
    .btn:active{ transform: translateY(0); }
    .btn-primary{
      border-color: rgba(124,92,255,.55);
      background: linear-gradient(135deg, rgba(124,92,255,.9), rgba(74,163,255,.55));
      box-shadow:0 16px 40px rgba(124,92,255,.24);
    }
    .btn-primary:hover{ border-color: rgba(124,92,255,.8); background: linear-gradient(135deg, rgba(124,92,255,.98), rgba(74,163,255,.65)); }
    .btn-ghost{
      background: rgba(255,255,255,.03);
    }

    /* Layout */
    main{ padding: 26px 0 70px; }
    .grid{
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .sidebar{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,.04);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:sticky; top:78px;
    }
    @media (max-width: 980px){
      .sidebar{ position:relative; top:auto; }
    }
    .side-head{
      padding:16px 16px 12px;
      border-bottom:1px solid var(--line);
    }
    .side-title{
      margin:0;
      font-size: 16px;
      font-weight:900;
      letter-spacing:.3px;
    }
    .side-sub{ margin:6px 0 0; color:var(--muted); font-size:12px; }
    .side-links{
      display:flex; flex-direction:column;
      padding:10px;
      gap:8px;
    }
    .side-link{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid transparent;
      color:var(--muted);
      font-weight:800;
      cursor:pointer;
      transition:.12s ease;
      user-select:none;
    }
    .side-link:hover{ background: rgba(255,255,255,.05); color:var(--text); }
    .side-link.active{
      background: rgba(124,92,255,.12);
      border-color: rgba(124,92,255,.35);
      color: var(--text);
    }
    .side-link i{ width:18px; text-align:center; }

    .content{
      display:flex;
      flex-direction:column;
      gap:18px;
    }

    .section{
      scroll-margin-top: 96px;
    }
    .section-head{
      margin-bottom:10px;
    }
    .section-title{
      margin:0 0 6px;
      font-size: 18px;
      font-weight: 950;
      letter-spacing:.2px;
    }
    .section-sub{
      margin:0;
      font-size: 12.5px;
      color: var(--muted);
      line-height: 1.5;
    }

    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,.05);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .stats{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:12px;
      padding:14px;
    }
    @media (max-width: 980px){
      .stats{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    .stat{
      padding:14px 14px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.1);
      background: rgba(255,255,255,.04);
    }
    .stat .k{
      color: var(--muted);
      font-size: 12px;
      font-weight:800;
      display:flex; align-items:center; gap:8px;
    }
    .stat .v{
      margin-top:8px;
      font-size: 22px;
      font-weight: 950;
      letter-spacing:.3px;
    }
    .stat .hint{
      margin-top:6px;
      font-size: 12px;
      color: var(--muted);
    }

    .toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 14px;
      border-bottom:1px solid var(--line);
      flex-wrap:wrap;
    }
    .toolbar .left{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .toolbar .right{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .field{
      display:flex; align-items:center; gap:8px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 8px 10px;
      flex-wrap:wrap;
    }
    .input, .select{
      background: transparent;
      border:0;
      outline:none;
      color: var(--text);
      font-weight:800;
      font-family: inherit;
      font-size: 13px;
      min-width: 220px;
    }
    .select{ min-width: 160px; }
    .input::placeholder{ color: rgba(255,255,255,.42); font-weight:800; }

    .textarea{
      width:100%;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 14px;
      padding: 10px 12px;
      color: var(--text);
      font-weight: 850;
      font-family: inherit;
      font-size: 13px;
      outline: none;
      resize: vertical;
      min-height: 70px;
      line-height: 1.6;
    }
    .textarea::placeholder{ color: rgba(255,255,255,.42); }

    .table-wrap{ padding: 0 14px 14px; overflow:auto; }
    table{
      width:100%;
      border-collapse:collapse;
      min-width: 720px;
    }
    th, td{
      border-bottom:1px solid rgba(255,255,255,.10);
      padding: 12px 10px;
      text-align:left;
      font-size: 13px;
      vertical-align:middle;
    }
    th{
      color: rgba(255,255,255,.72);
      font-weight: 950;
      font-size: 12px;
      letter-spacing:.3px;
      background: rgba(255,255,255,.03);
    }
    tr:hover td{ background: rgba(255,255,255,.02); }

    .row-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .mini-btn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 8px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      color: var(--text);
      font-weight: 900;
      font-size: 12px;
      transition:.12s ease;
      user-select:none;
    }
    .mini-btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.2); }
    .mini-btn.good{ border-color: rgba(61,220,151,.38); background: rgba(61,220,151,.10); }
    .mini-btn.bad{ border-color: rgba(255,70,90,.42); background: rgba(255,70,90,.10); }
    .mini-btn.warn{ border-color: rgba(255,190,77,.42); background: rgba(255,190,77,.10); }

    .status-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      font-weight: 950;
      font-size: 12px;
      color: rgba(255,255,255,.85);
      white-space:nowrap;
    }
    .status-dot{
      width:8px; height:8px;
      border-radius:999px;
      background: rgba(255,255,255,.7);
      box-shadow:0 0 0 3px rgba(255,255,255,.08);
    }

    .muted{ color: var(--muted); }
    .empty{
      padding: 22px;
      border:1px dashed rgba(255,255,255,.18);
      border-radius: 16px;
      background: rgba(255,255,255,.03);
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(10,13,20,.86);
      border: 1px solid rgba(255,255,255,.16);
      padding: 12px 14px;
      border-radius: 14px;
      color: var(--text);
      font-weight: 900;
      box-shadow: 0 22px 60px rgba(0,0,0,.45);
      z-index: 999;
      opacity: 0;
      pointer-events:none;
      transition: .18s ease;
      max-width: min(640px, 90vw);
      display:flex; align-items:center; gap:10px;
    }
    .toast.show{ opacity:1; pointer-events:auto; }
    .toast .tag{
      font-size: 12px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
    }

    /* Modal */
    .modal-mask{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 2000;
      padding: 18px;
    }
    .modal-mask.show{ display:flex; }

    .modal{
      width: min(720px, 92vw);
      max-height: 90vh;
      border:1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      background: rgba(12,16,26,.92);
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal-head{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding: 14px 16px;
      border-bottom:1px solid rgba(255,255,255,.12);
    }
    .modal-title{
      margin:0;
      font-size: 15px;
      font-weight: 950;
    }
    .modal-close{
      width: 40px; height: 40px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      color: var(--text);
      font-size: 16px;
      font-weight: 950;
    }

    .modal-body{
      padding: 14px 16px 18px;
      max-height: calc(90vh - 64px);
      overflow: auto;
    }

    .kv{
      display:grid;
      grid-template-columns: 130px 1fr;
      gap:8px;
      padding:8px 0;
      border-bottom:1px dashed rgba(255,255,255,.12);
    }
    .kv:last-child{ border-bottom:0; }
    .kv .k{ color: rgba(255,255,255,.68); font-weight: 950; font-size: 11px; }
    .kv .v{ font-weight: 850; font-size: 12px; color: rgba(255,255,255,.9); word-break:break-all; }

    @media (max-width: 520px){
      .kv{ grid-template-columns: 1fr; }
    }

    .preview-img{
      margin-top:10px;
      width:100%;
      max-height:360px;
      object-fit:contain;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }

    /* Skeleton */
    .skeleton{
      background: linear-gradient(90deg, rgba(255,255,255,.05), rgba(255,255,255,.10), rgba(255,255,255,.05));
      background-size: 200% 100%;
      animation: sk 1.1s ease infinite;
      border-radius: 12px;
    }
    @keyframes sk{
      0%{ background-position: 200% 0; }
      100%{ background-position: -200% 0; }
    }
    .sk-line{ height: 12px; }
    .sk-line.wide{ width: 220px; }
    .sk-line.mid{ width: 160px; }
    .sk-line.narrow{ width: 120px; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="container topbar-inner">
      <div class="brand">
        <img src="picture/logo.png" alt="logo" />
        <div>星火廣告｜Admin</div>
      </div>
      <div class="nav">
        <div class="pill"><i class="fa-solid fa-user-shield"></i> <b id="navUsername">admin</b></div>
        <button class="btn" id="refreshBtn" type="button"><i class="fas fa-rotate"></i> 重新同步</button>
        <button class="btn btn-primary" id="logoutBtn" type="button"><i class="fas fa-right-from-bracket"></i> 登出</button>
      </div>
    </div>
  </div>

  <main>
    <div class="container grid">
      <aside class="sidebar">
        <div class="side-head">
          <h3 class="side-title">管理選單</h3>
          <p class="side-sub">用戶 / Dealer / 任務 / 社群審核</p>
        </div>
        <div class="side-links" id="sideLinks">
          <div class="side-link active" data-target="#overview"><i class="fas fa-chart-pie"></i> 總覽</div>
          <div class="side-link" data-target="#users"><i class="fas fa-users"></i> 用戶管理</div>
          <div class="side-link" data-target="#dealers"><i class="fas fa-car"></i> Dealer 管理</div>
          <div class="side-link" data-target="#quests"><i class="fas fa-bullseye"></i> 任務管理</div>
          <div class="side-link" data-target="#reviews"><i class="fas fa-clipboard-check"></i> 審核中心</div>
          <div class="side-link" data-target="#social-verify"><i class="fas fa-circle-check"></i> 社群驗證審核</div>
        </div>
      </aside>

      <section class="content">
        <!-- Overview -->
        <section class="section" id="overview">
          <div class="section-head">
            <h2 class="section-title"><i class="fas fa-chart-pie"></i> 後台總覽</h2>
            <p class="section-sub">顯示目前平台統計資訊（users / dealers / 待審核社群驗證等）。</p>
          </div>

          <div class="card">
            <div class="stats">
              <div class="stat">
                <div class="k"><i class="fas fa-users"></i> Users</div>
                <div class="v" id="statUsers">0</div>
                <div class="hint">總用戶數</div>
              </div>
              <div class="stat">
                <div class="k"><i class="fas fa-car"></i> Dealers</div>
                <div class="v" id="statDealers">0</div>
                <div class="hint">刊登廣告客戶</div>
              </div>
              <div class="stat">
                <div class="k"><i class="fas fa-circle-check"></i> Pending</div>
                <div class="v" id="statPending">0</div>
                <div class="hint">社群驗證待審</div>
              </div>
              <div class="stat">
                <div class="k"><i class="fas fa-coins"></i> Payouts</div>
                <div class="v" id="statPayouts">0</div>
                <div class="hint">今日出款（預留）</div>
              </div>

              <div class="stat">
                <div class="k"><i class="fas fa-user-plus"></i> Today Users</div>
                <div class="v" id="todayUsers">0</div>
                <div class="hint">今日新增（預留）</div>
              </div>
              <div class="stat">
                <div class="k"><i class="fas fa-hourglass-half"></i> Pending Dealers</div>
                <div class="v" id="pendingDealers">0</div>
                <div class="hint">待審 Dealer</div>
              </div>
              <div class="stat">
                <div class="k"><i class="fas fa-bullseye"></i> Active Quests</div>
                <div class="v" id="activeQuests">0</div>
                <div class="hint">進行中任務（預留）</div>
              </div>
              <div class="stat">
                <div class="k"><i class="fas fa-sack-dollar"></i> Today Payouts</div>
                <div class="v" id="todayPayouts">0</div>
                <div class="hint">今日出款（預留）</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Users -->
        <section class="section" id="users">
          <div class="container">
            <div class="section-head">
              <h2 class="section-title"><i class="fas fa-users"></i> 用戶管理</h2>
              <p class="section-sub">搜尋、檢視、角色調整、停權/解鎖（停權先預留）。</p>
            </div>

            <div class="card">
              <div class="toolbar">
                <div class="left">
                  <div class="field">
                    <input class="input" id="userSearch" placeholder="搜尋 user_id / username / email / name" />
                    <select class="select" id="userRoleFilter">
                      <option value="">全部角色</option>
                      <option value="admin">admin</option>
                      <option value="dealer">dealer</option>
                      <option value="partner">partner</option>
                    </select>
                    <select class="select" id="userStatusFilter">
                      <option value="">全部狀態</option>
                      <option value="active">正常</option>
                      <option value="pending">待補資料</option>
                      <option value="blocked">停權</option>
                    </select>
                  </div>
                </div>
                <div class="right">
                  <button class="btn btn-ghost" id="usersRefreshBtn" type="button" title="重新抽樣 5 筆（清除搜尋/篩選）">
                    <i class="fas fa-shuffle"></i> 重新抽樣 5 筆
                  </button>
                  <button class="btn btn-primary" id="btnCreateUser" type="button">
                    <i class="fas fa-user-plus"></i> 新增用戶（規劃）
                  </button>
                </div>
              </div>

              <div style="height:12px"></div>

              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th style="width:220px">user_id</th>
                      <th style="width:160px">username</th>
                      <th style="width:240px">email</th>
                      <th style="width:120px">role</th>
                      <th style="width:140px">狀態</th>
                      <th style="width:240px">操作</th>
                    </tr>
                  </thead>
                  <tbody id="usersTbody">
                    <tr>
                      <td colspan="6">
                        <div class="empty" id="usersEmpty">
                          <div><b>尚未載入用戶資料</b></div>
                          <div class="muted">點「重新同步」或等待後端串接（/.netlify/functions/admin）。</div>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div style="height:14px"></div>
              <div class="muted" id="usersHint">提示：預設隨機顯示 5 筆用戶；需要時用搜尋（user_id / username / email / name）或角色篩選查詢（最多顯示 50 筆）。</div>
            </div>
          </div>
        </section>

        <!-- Social Verify -->
        
        <!-- Reviews Center -->
        <section class="section" id="reviews" style="display:none;">
          <div class="section-head">
            <h2 class="title"><i class="fas fa-clipboard-check"></i> 審核中心</h2>
            <div class="muted">集中處理「刊登審核」與「任務提交審核」。</div>
          </div>

          <div class="grid2">
            <div class="card">
              <div class="card-head">
                <div class="card-title">刊登審核（dealer_listings）</div>
                <div class="card-actions">
                  <button class="btn ghost" id="btnReloadListingPending"><i class="fas fa-rotate"></i> 重新載入</button>
                </div>
              </div>
              <div class="table-wrap">
                <table class="table">
                  <thead>
                    <tr>
                      <th>submitted_at</th>
                      <th>listing_id</th>
                      <th>dealer_id</th>
                      <th>title</th>
                      <th>budget</th>
                      <th>reward</th>
                      <th style="width:260px;">操作</th>
                    </tr>
                  </thead>
                  <tbody id="listingPendingTbody">
                    <tr><td colspan="7" class="muted">尚未載入</td></tr>
                  </tbody>
                </table>
              </div>
              <div class="muted" style="margin-top:10px; font-size:12px;">
                * Approve 會將刊登狀態設為 active（第一次審核），Reject 會標記 need_fix 並保留原因。
              </div>
            </div>

            <div class="card">
              <div class="card-head">
                <div class="card-title">任務提交審核（quest_submissions）</div>
                <div class="card-actions">
                  <button class="btn ghost" id="btnReloadSubmissionPending"><i class="fas fa-rotate"></i> 重新載入</button>
                </div>
              </div>

              <div class="table-wrap">
                <table class="table">
                  <thead>
                    <tr>
                      <th>submitted_at</th>
                      <th>submission_id</th>
                      <th>quest_id</th>
                      <th>user_id</th>
                      <th>proof</th>
                      <th style="width:320px;">操作</th>
                    </tr>
                  </thead>
                  <tbody id="submissionPendingTbody">
                    <tr><td colspan="6" class="muted">尚未載入</td></tr>
                  </tbody>
                </table>
              </div>

              <div class="muted" style="margin-top:10px; font-size:12px;">
                * Approve 需輸入 payout_amount（TWD）。Reject 會標記 rejected 並保留原因。
              </div>
            </div>
          </div>
        </section>
<section class="section" id="social-verify">
          <div class="container">
            <div class="section-head">
              <h2 class="section-title"><i class="fas fa-circle-check"></i> 社群驗證審核</h2>
              <p class="section-sub">列出所有 <b>submitted</b> 待審核名單，點選後可檢視明細並進行通過/補件/拒絕。</p>
            </div>

            <div class="card">
              <div class="toolbar">
                <div class="left">
                  <div class="field">
                    <input class="input" id="svSearch" placeholder="搜尋 user_id / username / email" />
                    <select class="select" id="svPlatformFilter">
                      <option value="">平台（全部）</option>
                      <option value="ig">IG</option>
                      <option value="fb">FB</option>
                    </select>
                    <select class="select" id="svTierFilter">
                      <option value="">Tier（全部）</option>
                      <option value="s">S</option>
                      <option value="a">A</option>
                      <option value="b">B</option>
                      <option value="c">C</option>
                    </select>
                  </div>
                </div>
                <div class="right">
                  <button class="btn btn-primary" id="svRefreshBtn" type="button">
                    <i class="fas fa-rotate"></i> 重新載入待審
                  </button>
                </div>
              </div>

              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th style="width:220px">user_id</th>
                      <th style="width:160px">username</th>
                      <th style="width:240px">email</th>
                      <th style="width:110px">平台</th>
                      <th style="width:120px">粉絲數</th>
                      <th style="width:140px">submitted_at</th>
                      <th style="width:240px">操作</th>
                    </tr>
                  </thead>
                  <tbody id="svTbody">
                    <tr>
                      <td colspan="7">
                        <div class="empty">
                          <div><b>尚未載入待審資料</b></div>
                          <div class="muted">點「重新載入待審」或「重新同步」。</div>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="table-wrap" style="padding-top:0;">
                <div class="muted" style="padding: 0 14px 14px;">提示：此區塊已與後端 admin.cjs 串接（social_list_submitted / social_get / approve / need_fix / reject）。</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Dealers -->
        <section class="section" id="dealers">
          <div class="container">
            <div class="section-head">
              <h2 class="section-title"><i class="fas fa-car"></i> Dealer 管理</h2>
              <p class="section-sub">列表、審核、補件、拒絕（已串接 dealers Sheet）。</p>
            </div>

            <div class="card">
              <div class="toolbar">
                <div class="left">
                  <div class="field">
                    <input class="input" id="dealerSearch" placeholder="搜尋 dealer_name / email / user_id / dealer_id" />
                    <select class="select" id="dealerVerifyFilter">
                      <option value="">審核狀態（全部）</option>
                      <option value="submitted">submitted</option>
                      <option value="approved">approved</option>
                      <option value="rejected">rejected</option>
                      <option value="need_fix">need_fix</option>
                    </select>
                  </div>
                </div>
                <div class="right">
                  <button class="btn" id="dealersRefreshBtn" type="button"><i class="fas fa-rotate"></i> 重新載入</button>
                  <button class="btn btn-primary" id="btnCreateDealer" type="button">
                    <i class="fas fa-car-side"></i> 新增 Dealer（規劃）
                  </button>
                </div>
              </div>

              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th style="width:180px">dealer_id</th>
                      <th style="width:220px">dealer_name</th>
                      <th style="width:240px">email</th>
                      <th style="width:180px">user_id</th>
                      <th style="width:120px">dealer_status</th>
                      <th style="width:160px">submitted_at</th>
                      <th style="width:260px">操作</th>
                    </tr>
                  </thead>
                  <tbody id="dealersTbody">
                    <tr>
                      <td colspan="7">
                        <div class="empty">
                          <div><b>尚未載入 Dealer</b></div>
                          <div class="muted">點「重新載入」或「重新同步」。</div>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="muted" style="padding: 0 14px 14px;" id="dealersHint">
                提示：預設顯示（最多 50 筆）；可用搜尋/狀態篩選。
              </div>
            </div>
          </div>
        </section>

        <!-- Quests -->
        <section class="section" id="quests">
          <div class="container">
            <div class="section-head">
              <h2 class="section-title"><i class="fas fa-bullseye"></i> 任務管理</h2>
              <p class="section-sub">建立任務、上下架、審核（目前仍為 UI 預留）。</p>
            </div>

            <div class="card">
              <div class="toolbar">
                <div class="left">
                  <div class="muted">提示：此區塊為 UI 預留，待任務系統串接。</div>
                </div>
                <div class="right">
                  <button class="btn btn-primary" id="btnCreateQuest" type="button">
                    <i class="fas fa-plus"></i> 建立任務（規劃）
                  </button>
                </div>
              </div>

              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th style="width:220px">quest_id</th>
                      <th style="width:240px">title</th>
                      <th style="width:120px">status</th>
                      <th style="width:160px">reward</th>
                      <th style="width:240px">操作</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="5">
                        <div class="empty">
                          <div><b>目前沒有資料</b></div>
                          <div class="muted">此區塊為 UI 預留，後端串接後即可使用。</div>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

            </div>
          </div>
        </section>

      </section>
    </div>
  </main>

  <!-- Modal: Social verify detail -->
  <div class="modal-mask" id="svModalMask" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-head">
        <h3 class="modal-title" id="svModalTitle">社群驗證審核</h3>
        <button class="modal-close" id="svModalClose" type="button" aria-label="Close"><i class="fas fa-xmark"></i></button>
      </div>
      <div class="modal-body" id="svModalBody">
        <div class="skeleton sk-line wide"></div>
        <div style="height:10px"></div>
        <div class="skeleton sk-line mid"></div>
        <div style="height:10px"></div>
        <div class="skeleton sk-line wide"></div>
      </div>
    </div>
  </div>

  <!-- Modal: User detail / role -->
  <div class="modal-mask" id="userModalMask" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-head">
        <h3 class="modal-title" id="userModalTitle">用戶</h3>
        <button class="modal-close" id="userModalClose" type="button" aria-label="Close"><i class="fas fa-xmark"></i></button>
      </div>
      <div class="modal-body" id="userModalBody">
        <div class="skeleton sk-line wide"></div>
        <div style="height:10px"></div>
        <div class="skeleton sk-line mid"></div>
        <div style="height:10px"></div>
        <div class="skeleton sk-line wide"></div>
      </div>
    </div>
  </div>

  <!-- ✅ Modal: Dealer detail -->
  <div class="modal-mask" id="dealerModalMask" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-head">
        <h3 class="modal-title" id="dealerModalTitle">Dealer</h3>
        <button class="modal-close" id="dealerModalClose" type="button" aria-label="Close"><i class="fas fa-xmark"></i></button>
      </div>
      <div class="modal-body" id="dealerModalBody">
        <div class="skeleton sk-line wide"></div>
        <div style="height:10px"></div>
        <div class="skeleton sk-line mid"></div>
        <div style="height:10px"></div>
        <div class="skeleton sk-line wide"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"><span class="tag" id="toastTag">INFO</span><span id="toastText"></span></div>

  <script>
    const $ = (sel) => document.querySelector(sel);

    function escapeHtml(s){
      return String(s ?? '').replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }

    function isHttpUrl(u){
      const s = String(u || '').trim();
      return /^https?:\/\//i.test(s);
    }

    function linkOrDash(url){
      const u = String(url || '').trim();
      if(!u) return '-';
      if(!isHttpUrl(u)) return escapeHtml(u);
      return `<a href="${escapeHtml(u)}" target="_blank" rel="noopener noreferrer" style="text-decoration:underline;">開啟連結</a>`;
    }

    function getAuth(){
      const token = localStorage.getItem('xinghuo_token') || '';
      const userRaw = localStorage.getItem('xinghuo_user') || '';
      let user = null;
      try{ user = userRaw ? JSON.parse(userRaw) : null; }catch(e){}
      return { token, user };
    }

    function requireLogin(){
      const a = getAuth();
      if(!a.token || !a.user){
        location.href = 'login.html';
        return null;
      }
      return a;
    }

    function guardAdmin(user){
      const role = (user?.role || '').toLowerCase();
      if(role !== 'admin'){
        location.href = 'dashboard.html';
        return false;
      }
      return true;
    }

    function showToast(msg, type='info'){
      const toast = $('#toast');
      const tag = $('#toastTag');
      const text = $('#toastText');
      if(!toast || !tag || !text) return;
      text.textContent = msg;
      tag.textContent = String(type || 'info').toUpperCase();
      toast.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>toast.classList.remove('show'), 2400);
    }

    // ===== Sidebar navigation =====
    (function sideNav(){
      const links = Array.from(document.querySelectorAll('#sideLinks .side-link'));
      links.forEach(l=>{
        l.addEventListener('click', ()=>{
          links.forEach(x=>x.classList.remove('active'));
          l.classList.add('active');
          const t = l.dataset.target;
          const el = t ? document.querySelector(t) : null;
          if(el) el.scrollIntoView({ behavior:'smooth', block:'start' });
        });
      });
    })();

    // ===== Logout =====
    $('#logoutBtn')?.addEventListener('click', ()=>{
      localStorage.removeItem('xinghuo_token');
      localStorage.removeItem('xinghuo_user');
      localStorage.removeItem('xinghuo_my_quests');
      location.href = 'index.html';
    });

    async function adminApi(token, payload){
      const res = await fetch('/.netlify/functions/admin', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(payload || {})
      });
      if(!res.ok){
        const t = await res.text().catch(()=> '');
        throw new Error('admin api ' + res.status + ': ' + (t || res.statusText));
      }
      return await res.json();
    }

    // ===== Caches =====
    let USERS_CACHE = [];
    let USERS_TOTAL = 0;

    let SV_LIST = [];
    let SV_SELECTED_USER_ID = "";

    let DEALERS_LIST = [];
    let DEALERS_TOTAL = 0;
    let DEALER_SELECTED_ID = "";

    function applySnapshotUI(snapshot){
      const s = snapshot?.stats || {};
      const set = (id, val) => { const el = $(id); if(el) el.textContent = String(val ?? 0); };
      set('#statUsers', s.users);
      set('#statDealers', s.dealers);
      set('#statPending', s.pending);
      set('#statPayouts', s.payouts);
      set('#todayUsers', s.todayUsers);
      set('#pendingDealers', s.pendingDealers);
      set('#activeQuests', s.activeQuests);
      set('#todayPayouts', s.todayPayouts);

      USERS_CACHE = (snapshot?.users || []);
      USERS_TOTAL = Number(s.users || 0);
      renderUsers(USERS_CACHE);
      const uh = $('#usersHint');
      if(uh) uh.textContent = `已隨機抽樣 ${USERS_CACHE.length} 筆（total ${USERS_TOTAL}）。需要時用搜尋/角色篩選查詢。`;

      // overview 只顯示預覽
      renderDealers(snapshot?.dealers || [], { preview:true });
    }

    async function syncAll(){
      const auth = requireLogin();
      if(!auth) return;
      guardAdmin(auth.user);

      $('#navUsername').textContent = auth.user.username || auth.user.name || 'admin';

      try{
        const snap = await adminApi(auth.token, { action:'snapshot' });
        if(!snap?.ok) throw new Error(snap?.error || 'snapshot_failed');
        applySnapshotUI(snap);

        await loadSubmittedList({ silent:true });
        await loadDealers({ silent:true });
      }catch(err){
        console.error(err);
        showToast('後端尚未串接完成：你仍可先使用介面', 'warn');
        applySnapshotUI({
          stats: { users:0, dealers:0, pending:0, payouts:0, todayUsers:0, pendingDealers:0, activeQuests:0, todayPayouts:0 },
          users: [],
          dealers: []
        });
      }
    }

    // =========================
    // Users
    // =========================
    function renderUsers(users=[]){
      const tbody = $('#usersTbody');
      if(!tbody) return;
      if(!users.length){
        tbody.innerHTML = `
          <tr><td colspan="6">
            <div class="empty">
              <div><b>目前沒有資料</b></div>
              <div class="muted">你可以先用 UI；串接完成後這裡會自動顯示。</div>
            </div>
          </td></tr>
        `;
        return;
      }

      tbody.innerHTML = users.map(u => {
        const role = (u.role || '').toLowerCase();
        const status = (u.status || 'active').toLowerCase();
        const statusLabel = status === 'blocked' ? '停權' : (status === 'pending' ? '待補資料' : '正常');
        const dotColor = status === 'blocked' ? 'rgba(255,70,90,.95)' : (status === 'pending' ? 'rgba(255,190,80,.95)' : 'rgba(90,255,190,.95)');

        return `
          <tr data-userid="${escapeHtml(u.user_id || '')}">
            <td>${escapeHtml(u.user_id || '')}</td>
            <td title="${escapeHtml(u.name || '')}">${escapeHtml(u.username || '')}</td>
            <td>${escapeHtml(u.email || '')}</td>
            <td><span class="status-pill"><span class="status-dot" style="background:${dotColor}"></span>${escapeHtml(role || '-')}</span></td>
            <td><span class="status-pill"><span class="status-dot" style="background:${dotColor}"></span>${statusLabel}</span></td>
            <td>
              <div class="row-actions">
                <button class="mini-btn" data-act="view"><i class="fas fa-eye"></i> 查看</button>
                <button class="mini-btn warn" data-act="role"><i class="fas fa-user-gear"></i> 角色</button>
                <button class="mini-btn bad" data-act="block"><i class="fas fa-ban"></i> 停權</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      tbody.querySelectorAll('tr[data-userid] .mini-btn').forEach(btn => {
        btn.addEventListener('click', (e)=>{
          const tr = e.target.closest('tr[data-userid]');
          const uid = tr?.dataset?.userid || '';
          const act = e.target.closest('.mini-btn')?.dataset?.act || '';
          if(!uid) return;

          if(act === 'view'){
            openUserModal('view', uid);
          }else if(act === 'role'){
            const u = (USERS_CACHE || []).find(x => String(x.user_id||'') === String(uid));
            openUserModal('role', uid, u?.role || '');
          }else if(act === 'block'){
            showToast('停權/解鎖（預留：欄位未定）','info');
          }
        });
      });
    }

    // ===== User Modal (view / role) =====
    function openUserModal(mode, user_id, currentRole=''){
      const mask = $('#userModalMask');
      const title = $('#userModalTitle');
      const body = $('#userModalBody');

      if(title) title.textContent = mode === 'role' ? `角色調整：${user_id}` : `用戶資料：${user_id}`;
      if(body){
        body.innerHTML = `
          <div class="skeleton sk-line wide"></div>
          <div style="height:10px"></div>
          <div class="skeleton sk-line mid"></div>
          <div style="height:10px"></div>
          <div class="skeleton sk-line wide"></div>
        `;
      }
      if(mask) mask.classList.add('show');

      if(mode === 'role'){
        loadUserDetailAndRenderRole(user_id, currentRole).catch(err=>{
          console.error(err);
          showToast('載入用戶失敗：' + (err?.message || ''), 'error');
        });
      }else{
        loadUserDetailAndRenderView(user_id).catch(err=>{
          console.error(err);
          showToast('載入用戶失敗：' + (err?.message || ''), 'error');
        });
      }
    }

    function closeUserModal(){
      const mask = $('#userModalMask');
      if(mask) mask.classList.remove('show');
    }

    $('#userModalClose')?.addEventListener('click', closeUserModal);
    $('#userModalMask')?.addEventListener('click', (e)=>{
      if(e.target?.id === 'userModalMask') closeUserModal();
    });

    async function fetchUser(user_id){
      const auth = requireLogin();
      if(!auth) throw new Error('not_logged_in');
      guardAdmin(auth.user);

      const out = await adminApi(auth.token, { action:'users_get', target_user_id: user_id });
      if(!out?.ok) throw new Error(out?.error || 'users_get_failed');
      return out.user || {};
    }

    function kvRow(k, v){
      return `<div class="kv"><div class="k">${escapeHtml(k)}</div><div class="v">${escapeHtml(v ?? '')}</div></div>`;
    }

    async function loadUserDetailAndRenderView(user_id){
      const user = await fetchUser(user_id);
      const body = $('#userModalBody');
      if(!body) return;

      const fields = [
        ['user_id', user.user_id],
        ['username', user.username],
        ['name', user.name],
        ['email', user.email],
        ['role', user.role],
        ['level', user.level],
        ['xp_total', user.xp_total],
        ['social_status', user.social_status],
        ['primary_platform', user.primary_platform],
        ['influence_tier', user.influence_tier],
        ['can_take_tasks', user.can_take_tasks],
        ['can_withdraw', user.can_withdraw],
        ['social_submitted_at', user.social_submitted_at],
        ['verified_at', user.verified_at],
        ['verified_by', user.verified_by],
      ];

      body.innerHTML = `
        ${fields.map(([k,v]) => kvRow(k, v)).join('')}
        <div style="height:14px"></div>
        <div class="row-actions">
          <button class="mini-btn" id="userCopyBtn"><i class="fas fa-copy"></i> 複製 user_id</button>
          <button class="mini-btn warn" id="userGoRoleBtn"><i class="fas fa-user-gear"></i> 改角色</button>
        </div>
      `;

      $('#userCopyBtn')?.addEventListener('click', async ()=>{
        try{
          await navigator.clipboard.writeText(String(user.user_id || user_id || ''));
          showToast('已複製 user_id', 'info');
        }catch(e){
          showToast('複製失敗（瀏覽器權限限制）', 'warn');
        }
      });

      $('#userGoRoleBtn')?.addEventListener('click', ()=>{
        openUserModal('role', user_id, user.role || '');
      });
    }

    async function loadUserDetailAndRenderRole(user_id, currentRole=''){
      const user = await fetchUser(user_id);
      const body = $('#userModalBody');
      if(!body) return;

      const roleNow = (user.role || currentRole || '').toLowerCase();

      body.innerHTML = `
        ${kvRow('user_id', user.user_id || user_id)}
        ${kvRow('username', user.username)}
        ${kvRow('name', user.name)}
        ${kvRow('email', user.email)}
        <div style="height:10px"></div>

        <div class="field" style="justify-content:space-between; width:100%;">
          <div class="muted" style="font-weight:900; font-size:12px;">選擇新角色</div>
          <select class="select" id="userRoleSelect" style="min-width:200px;">
            <option value="admin">admin</option>
            <option value="dealer">dealer</option>
            <option value="partner">partner</option>
          </select>
        </div>

        <div style="height:12px"></div>
        <div class="row-actions">
          <button class="mini-btn warn" id="userRoleSaveBtn"><i class="fas fa-floppy-disk"></i> 儲存角色</button>
          <button class="mini-btn" id="userRoleBackBtn"><i class="fas fa-arrow-left"></i> 返回查看</button>
        </div>
        <div style="height:8px"></div>
        <div class="muted" style="font-size:12px;">提醒：此操作會直接更新 users Sheet 的 role 欄位。</div>
      `;

      const sel = $('#userRoleSelect');
      if(sel){
        sel.value = ['admin','dealer','partner'].includes(roleNow) ? roleNow : 'partner';
      }

      $('#userRoleBackBtn')?.addEventListener('click', ()=>{
        openUserModal('view', user_id);
      });

      $('#userRoleSaveBtn')?.addEventListener('click', async ()=>{
        const auth = requireLogin();
        if(!auth) return;
        const role = ($('#userRoleSelect')?.value || '').trim().toLowerCase();
        if(!['admin','dealer','partner'].includes(role)){
          showToast('角色不合法', 'error');
          return;
        }
        try{
          showToast('更新角色中…', 'info');
          const out = await adminApi(auth.token, { action:'users_update_role', target_user_id: user_id, role });
          if(!out?.ok) throw new Error(out?.error || 'update_role_failed');

          (USERS_CACHE || []).forEach(x=>{
            if(String(x.user_id||'') === String(user_id)) x.role = role;
          });
          renderUsers(USERS_CACHE);

          showToast('已更新角色', 'info');
          openUserModal('view', user_id);
        }catch(e){
          console.error(e);
          showToast('更新失敗：' + (e?.message || ''), 'error');
        }
      });
    }

    // =========================
    // Social Verify
    // =========================
    function openSocialDetail(user_id){
      SV_SELECTED_USER_ID = user_id || '';
      if(!SV_SELECTED_USER_ID) return;
      const mask = $('#svModalMask');
      const title = $('#svModalTitle');
      const body = $('#svModalBody');
      if(title) title.textContent = '社群驗證審核：' + SV_SELECTED_USER_ID;
      if(body){
        body.innerHTML = `
          <div class="skeleton sk-line wide"></div>
          <div style="height:10px"></div>
          <div class="skeleton sk-line mid"></div>
          <div style="height:10px"></div>
          <div class="skeleton sk-line wide"></div>
        `;
      }
      if(mask) mask.classList.add('show');
      loadSocialDetail(SV_SELECTED_USER_ID).catch((e)=>{
        console.error(e);
        showToast('載入明細失敗：' + (e?.message || ''), 'error');
      });
    }

    function closeSocialDetail(){
      const mask = $('#svModalMask');
      if(mask) mask.classList.remove('show');
      SV_SELECTED_USER_ID = "";
    }

    $('#svModalClose')?.addEventListener('click', closeSocialDetail);
    $('#svModalMask')?.addEventListener('click', (e)=>{
      if(e.target?.id === 'svModalMask') closeSocialDetail();
    });

    async function loadSubmittedList({ silent=false } = {}){
      const auth = requireLogin();
      if(!auth) return;
      guardAdmin(auth.user);

      if(!silent) showToast('載入待審名單…','info');

      const out = await adminApi(auth.token, { action:'social_list_submitted' });
      if(!out?.ok) throw new Error(out?.error || 'social_list_failed');

      SV_LIST = out.items || [];
      renderSVList(SV_LIST);
    }

    async function loadSocialDetail(user_id){
      const auth = requireLogin();
      if(!auth) return;
      guardAdmin(auth.user);

      const out = await adminApi(auth.token, { action:'social_get', target_user_id: user_id });
      if(!out?.ok) throw new Error(out?.error || 'social_get_failed');

      const body = $('#svModalBody');
      if(!body) return;

      const social = out.social || {};
      const userInfo = {
        user_id: out.user_id || user_id,
        username: out.username || '',
        email: out.email || ''
      };

      const screenshotUrl = String(social.social_screenshot_url || '').trim();

      body.innerHTML = `
        <div class="kv"><div class="k">user_id</div><div class="v">${escapeHtml(userInfo.user_id)}</div></div>
        <div class="kv"><div class="k">username</div><div class="v">${escapeHtml(userInfo.username)}</div></div>
        <div class="kv"><div class="k">email</div><div class="v">${escapeHtml(userInfo.email)}</div></div>

        <div class="kv"><div class="k">social_status</div><div class="v">${escapeHtml(social.social_status || '')}</div></div>
        <div class="kv"><div class="k">user_type</div><div class="v">${escapeHtml(social.user_type || '')}</div></div>
        <div class="kv"><div class="k">region</div><div class="v">${escapeHtml(social.region || '')}</div></div>

        <div class="kv"><div class="k">primary_platform</div><div class="v">${escapeHtml(social.primary_platform || '')}</div></div>
        <div class="kv"><div class="k">influence_tier</div><div class="v">${escapeHtml(social.influence_tier || '')}</div></div>
        <div class="kv"><div class="k">ig_url</div><div class="v">${linkOrDash(social.ig_url || '')}</div></div>
        <div class="kv"><div class="k">fb_url</div><div class="v">${linkOrDash(social.fb_url || '')}</div></div>
        <div class="kv"><div class="k">followers_count</div><div class="v">${escapeHtml(social.followers_count || '')}</div></div>
        <div class="kv"><div class="k">avg_views_7d</div><div class="v">${escapeHtml(social.avg_views_7d || '')}</div></div>

        <div class="kv"><div class="k">social_screenshot_url</div><div class="v">${linkOrDash(screenshotUrl)}</div></div>
        ${screenshotUrl && isHttpUrl(screenshotUrl) ? `<img class="preview-img" src="${escapeHtml(screenshotUrl)}" alt="screenshot preview" />` : ''}

        <div class="kv"><div class="k">social_submitted_at</div><div class="v">${escapeHtml(social.social_submitted_at || '')}</div></div>
        <div class="kv"><div class="k">verified_at</div><div class="v">${escapeHtml(social.verified_at || '')}</div></div>
        <div class="kv"><div class="k">verified_by</div><div class="v">${escapeHtml(social.verified_by || '')}</div></div>

        ${(social.need_fix_reason !== undefined) ? `<div class="kv"><div class="k">need_fix_reason</div><div class="v">${escapeHtml(social.need_fix_reason || '')}</div></div>` : ''}
        ${(social.need_fix_at !== undefined) ? `<div class="kv"><div class="k">need_fix_at</div><div class="v">${escapeHtml(social.need_fix_at || '')}</div></div>` : ''}

        <div style="height:14px"></div>

        <div class="field" style="justify-content:space-between; width:100%;">
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <label class="muted" style="font-weight:900; font-size:12px;">審核設定（可覆寫）</label>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <select class="select" id="svSetPlatform" style="min-width:160px;">
              <option value="">（自動推斷）</option>
              <option value="ig">ig</option>
              <option value="fb">fb</option>
            </select>
            <select class="select" id="svSetTier" style="min-width:160px;">
              <option value="">（沿用提交）</option>
              <option value="s">s</option>
              <option value="a">a</option>
              <option value="b">b</option>
              <option value="c">c</option>
            </select>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="muted" style="font-weight:900; font-size:12px; margin-bottom:8px;">
          補件原因（會寫入 need_fix_reason；若你的 Sheet 有該欄位）
        </div>
        <textarea class="textarea" id="svNeedFixReason" placeholder="例：請提供可辨識的粉絲數截圖 / 請補上 IG 或 FB 連結 / 7日平均觀看數請填數字..."></textarea>

        <div style="height:12px"></div>

        <div class="row-actions">
          <button class="mini-btn good" id="svApproveBtn"><i class="fas fa-check"></i> 通過</button>
          <button class="mini-btn warn" id="svNeedFixBtn"><i class="fas fa-file-circle-exclamation"></i> 補件</button>
          <button class="mini-btn bad" id="svRejectBtn"><i class="fas fa-xmark"></i> 拒絕</button>
        </div>

        <div style="height:8px"></div>
        <div class="muted" style="font-size:12px;">通過：social_status=approved、level=1、can_take_tasks/can_withdraw=true；補件：social_status=need_fix、level=0、權限=false；拒絕：social_status=rejected、level=0、權限=false。</div>
      `;

      const p = $('#svSetPlatform');
      const t = $('#svSetTier');
      if(p && (social.suggest_platform || '')) p.value = String(social.suggest_platform || '');
      if(t && (social.influence_tier || '')) t.value = String(social.influence_tier || '');

      const reasonEl = $('#svNeedFixReason');
      if(reasonEl && (social.need_fix_reason || '')) reasonEl.value = String(social.need_fix_reason || '');

      $('#svApproveBtn')?.addEventListener('click', async ()=>{
        const auth2 = requireLogin();
        if(!auth2) return;
        const primary_platform = ($('#svSetPlatform')?.value || '').trim();
        const influence_tier = ($('#svSetTier')?.value || '').trim();
        try{
          showToast('審核中（通過）…','info');
          const out2 = await adminApi(auth2.token, { action:'social_approve', target_user_id: user_id, primary_platform, influence_tier });
          if(!out2?.ok) throw new Error(out2?.error || 'approve_failed');
          showToast('已通過','info');
          closeSocialDetail();
          await syncAll();
        }catch(e){
          console.error(e);
          showToast('通過失敗：' + (e?.message || ''), 'error');
        }
      });

      $('#svNeedFixBtn')?.addEventListener('click', async ()=>{
        const auth2 = requireLogin();
        if(!auth2) return;

        const reason = ($('#svNeedFixReason')?.value || '').trim();

        try{
          const msg = reason
            ? `確定要標記為「補件」嗎？\n\n補件原因：\n${reason}`
            : '確定要標記為「補件」嗎？（你尚未填補件原因）';
          if(!confirm(msg)) return;

          showToast('審核中（補件）…','info');
          const out2 = await adminApi(auth2.token, { action:'social_need_fix', target_user_id: user_id, reason });
          if(!out2?.ok) throw new Error(out2?.error || 'need_fix_failed');
          showToast('已標記補件','info');
          closeSocialDetail();
          await syncAll();
        }catch(e){
          console.error(e);
          showToast('補件失敗：' + (e?.message || ''), 'error');
        }
      });

      $('#svRejectBtn')?.addEventListener('click', async ()=>{
        const auth2 = requireLogin();
        if(!auth2) return;
        try{
          if(!confirm('確定要「拒絕」嗎？')) return;
          showToast('審核中（拒絕）…','info');
          const out2 = await adminApi(auth2.token, { action:'social_reject', target_user_id: user_id });
          if(!out2?.ok) throw new Error(out2?.error || 'reject_failed');
          showToast('已拒絕','info');
          closeSocialDetail();
          await syncAll();
        }catch(e){
          console.error(e);
          showToast('拒絕失敗：' + (e?.message || ''), 'error');
        }
      });
    }

    function renderSVList(items=[]){
      const tbody = $('#svTbody');
      if(!tbody) return;
      if(!items.length){
        tbody.innerHTML = `
          <tr><td colspan="7">
            <div class="empty">
              <div><b>目前沒有 submitted 待審</b></div>
              <div class="muted">當有用戶 submit 後，這裡就會出現。</div>
            </div>
          </td></tr>
        `;
        return;
      }

      tbody.innerHTML = items.map(it => {
        const platform = (it.primary_platform || it.suggest_platform || '').toLowerCase();
        return `
          <tr data-uid="${escapeHtml(it.user_id || '')}">
            <td>${escapeHtml(it.user_id || '')}</td>
            <td>${escapeHtml(it.username || '')}</td>
            <td>${escapeHtml(it.email || '')}</td>
            <td>${escapeHtml(platform || '-')}</td>
            <td>${escapeHtml(it.followers_count || '')}</td>
            <td>${escapeHtml(it.social_submitted_at || '')}</td>
            <td>
              <div class="row-actions">
                <button class="mini-btn" data-act="detail"><i class="fas fa-magnifying-glass"></i> 明細</button>
                <button class="mini-btn good" data-act="approve"><i class="fas fa-check"></i> 通過</button>
                <button class="mini-btn warn" data-act="needfix"><i class="fas fa-file-circle-exclamation"></i> 補件</button>
                <button class="mini-btn bad" data-act="reject"><i class="fas fa-xmark"></i> 拒絕</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      tbody.querySelectorAll('tr[data-uid] .mini-btn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const tr = e.target.closest('tr[data-uid]');
          const uid = tr?.dataset?.uid || '';
          if(!uid) return;
          openSocialDetail(uid);
        });
      });
    }

    function wireSocialVerifyUI(){
      $('#svRefreshBtn')?.addEventListener('click', ()=> loadSubmittedList({ silent:false }));
      $('#svSearch')?.addEventListener('input', ()=>{
        const q = ($('#svSearch')?.value || '').trim().toLowerCase();
        const p = ($('#svPlatformFilter')?.value || '').trim().toLowerCase();
        const t = ($('#svTierFilter')?.value || '').trim().toLowerCase();

        const filtered = (SV_LIST || []).filter(it=>{
          const hay = `${it.user_id||''} ${it.username||''} ${it.email||''}`.toLowerCase();
          if(q && !hay.includes(q)) return false;

          const pNow = String(it.primary_platform || it.suggest_platform || '').toLowerCase();
          if(p && pNow !== p) return false;

          if(t && String(it.influence_tier||'').toLowerCase() !== t) return false;
          return true;
        });
        renderSVList(filtered);
      });
      $('#svPlatformFilter')?.addEventListener('change', ()=> $('#svSearch')?.dispatchEvent(new Event('input')));
      $('#svTierFilter')?.addEventListener('change', ()=> $('#svSearch')?.dispatchEvent(new Event('input')));
    }

    // =========================
    // Dealers
    // =========================
    function dealerDotColor(status){
      const s = String(status||'').toLowerCase();
      if(s === 'approved') return 'rgba(90,255,190,.95)';
      if(s === 'submitted') return 'rgba(255,190,80,.95)';
      if(s === 'need_fix') return 'rgba(255,190,80,.95)';
      if(s === 'rejected') return 'rgba(255,70,90,.95)';
      return 'rgba(255,255,255,.65)';
    }

    function renderDealers(items=[], { preview=false } = {}){
      const tbody = $('#dealersTbody');
      if(!tbody) return;

      if(preview){
        // overview preview: 若你剛好正在 dealers 區，仍可看到完整列表，由 loadDealers 會覆蓋
      }

      if(!items.length){
        tbody.innerHTML = `
          <tr><td colspan="7">
            <div class="empty">
              <div><b>目前沒有 Dealer 資料</b></div>
              <div class="muted">確認 dealers Sheet 是否有資料，或點「重新載入」。</div>
            </div>
          </td></tr>
        `;
        const hint = $('#dealersHint');
        if(hint) hint.textContent = '提示：目前沒有資料。';
        return;
      }

      tbody.innerHTML = items.map(d => {
        const st = String(d.dealer_status || '').toLowerCase();
        const dot = dealerDotColor(st);
        return `
          <tr data-dealerid="${escapeHtml(d.dealer_id || '')}">
            <td>${escapeHtml(d.dealer_id || '')}</td>
            <td>${escapeHtml(d.dealer_name || '')}</td>
            <td>${escapeHtml(d.email || '')}</td>
            <td>${escapeHtml(d.user_id || '')}</td>
            <td>
              <span class="status-pill">
                <span class="status-dot" style="background:${dot}"></span>
                ${escapeHtml(st || '-')}
              </span>
            </td>
            <td>${escapeHtml(d.submitted_at || '')}</td>
            <td>
              <div class="row-actions">
                <button class="mini-btn" data-act="detail"><i class="fas fa-magnifying-glass"></i> 明細</button>
                <button class="mini-btn good" data-act="approve"><i class="fas fa-check"></i> 通過</button>
                <button class="mini-btn warn" data-act="needfix"><i class="fas fa-file-circle-exclamation"></i> 補件</button>
                <button class="mini-btn bad" data-act="reject"><i class="fas fa-xmark"></i> 拒絕</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      tbody.querySelectorAll('tr[data-dealerid] .mini-btn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const tr = e.target.closest('tr[data-dealerid]');
          const did = tr?.dataset?.dealerid || '';
          if(!did) return;
          openDealerDetail(did);
        });
      });
    }

    function getDealersQueryState(){
      const q = ($('#dealerSearch')?.value || '').trim();
      const status = ($('#dealerVerifyFilter')?.value || '').trim().toLowerCase();
      return { q, status };
    }

    async function loadDealers({ silent=true } = {}){
      const auth = requireLogin();
      if(!auth) return;
      guardAdmin(auth.user);

      const { q, status } = getDealersQueryState();
      const hint = $('#dealersHint');

      try{
        if(!silent) showToast('載入 Dealer…','info');
        const out = await adminApi(auth.token, { action:'dealers_list', q, status, limit: 50, offset: 0 });
        if(!out?.ok) throw new Error(out?.error || 'dealers_list_failed');

        DEALERS_LIST = out.items || [];
        DEALERS_TOTAL = Number(out.total || DEALERS_LIST.length || 0);

        renderDealers(DEALERS_LIST);
        if(hint) hint.textContent = `已載入 ${DEALERS_LIST.length} 筆（符合 ${DEALERS_TOTAL}）。(最多顯示 50 筆)`;
      }catch(e){
        console.error(e);
        showToast('Dealer 載入失敗（確認 dealers Sheet 欄位是否正確）', 'error');
      }
    }

    // Dealer Modal
    function openDealerDetail(dealer_id){
      DEALER_SELECTED_ID = dealer_id || '';
      if(!DEALER_SELECTED_ID) return;

      const mask = $('#dealerModalMask');
      const title = $('#dealerModalTitle');
      const body = $('#dealerModalBody');
      if(title) title.textContent = 'Dealer 審核：' + DEALER_SELECTED_ID;
      if(body){
        body.innerHTML = `
          <div class="skeleton sk-line wide"></div>
          <div style="height:10px"></div>
          <div class="skeleton sk-line mid"></div>
          <div style="height:10px"></div>
          <div class="skeleton sk-line wide"></div>
        `;
      }
      if(mask) mask.classList.add('show');

      loadDealerDetail(DEALER_SELECTED_ID).catch(err=>{
        console.error(err);
        showToast('載入 Dealer 失敗：' + (err?.message || ''), 'error');
      });
    }

    function closeDealerDetail(){
      const mask = $('#dealerModalMask');
      if(mask) mask.classList.remove('show');
      DEALER_SELECTED_ID = "";
    }

    $('#dealerModalClose')?.addEventListener('click', closeDealerDetail);
    $('#dealerModalMask')?.addEventListener('click', (e)=>{
      if(e.target?.id === 'dealerModalMask') closeDealerDetail();
    });

    async function loadDealerDetail(dealer_id){
      const auth = requireLogin();
      if(!auth) return;
      guardAdmin(auth.user);

      const out = await adminApi(auth.token, { action:'dealers_get', target_dealer_id: dealer_id });
      if(!out?.ok) throw new Error(out?.error || 'dealers_get_failed');

      const d = out.dealer || {};
      const body = $('#dealerModalBody');
      if(!body) return;

      body.innerHTML = `
        ${kvRow('dealer_id', d.dealer_id || dealer_id)}
        ${kvRow('dealer_name', d.dealer_name || '')}
        ${kvRow('email', d.email || '')}
        ${kvRow('user_id', d.user_id || '')}
        ${kvRow('dealer_status', d.dealer_status || '')}
        ${kvRow('submitted_at', d.submitted_at || '')}
        ${kvRow('verified_at', d.verified_at || '')}
        ${kvRow('verified_by', d.verified_by || '')}
        ${kvRow('need_fix_reason', d.need_fix_reason || '')}
        ${kvRow('need_fix_at', d.need_fix_at || '')}

        <div style="height:12px"></div>
        <div class="muted" style="font-weight:900; font-size:12px; margin-bottom:8px;">
          補件原因（need_fix_reason）
        </div>
        <textarea class="textarea" id="dealerNeedFixReason" placeholder="例：請補上公司資料/統編/可聯絡電話/店家名稱需完整..."></textarea>

        <div style="height:12px"></div>
        <div class="row-actions">
          <button class="mini-btn good" id="dealerApproveBtn"><i class="fas fa-check"></i> 通過</button>
          <button class="mini-btn warn" id="dealerNeedFixBtn"><i class="fas fa-file-circle-exclamation"></i> 補件</button>
          <button class="mini-btn bad" id="dealerRejectBtn"><i class="fas fa-xmark"></i> 拒絕</button>
        </div>
        <div style="height:8px"></div>
        <div class="muted" style="font-size:12px;">規則：只允許 submitted → approved/need_fix/rejected。</div>
      `;

      const r = $('#dealerNeedFixReason');
      if(r && (d.need_fix_reason || '')) r.value = String(d.need_fix_reason || '');

      $('#dealerApproveBtn')?.addEventListener('click', async ()=>{
        const auth2 = requireLogin();
        if(!auth2) return;
        try{
          if(!confirm('確定要「通過」這筆 Dealer 嗎？')) return;
          showToast('審核中（通過）…','info');
          const out2 = await adminApi(auth2.token, { action:'dealers_approve', target_dealer_id: dealer_id });
          if(!out2?.ok) throw new Error(out2?.error || 'dealers_approve_failed');
          showToast('已通過','info');
          closeDealerDetail();
          await syncAll();
        }catch(e){
          console.error(e);
          showToast('通過失敗：' + (e?.message || ''), 'error');
        }
      });

      $('#dealerNeedFixBtn')?.addEventListener('click', async ()=>{
        const auth2 = requireLogin();
        if(!auth2) return;
        const reason = ($('#dealerNeedFixReason')?.value || '').trim();
        try{
          const msg = reason
            ? `確定要標記為「補件」嗎？\n\n補件原因：\n${reason}`
            : '確定要標記為「補件」嗎？（你尚未填補件原因）';
          if(!confirm(msg)) return;

          showToast('審核中（補件）…','info');
          const out2 = await adminApi(auth2.token, { action:'dealers_need_fix', target_dealer_id: dealer_id, reason });
          if(!out2?.ok) throw new Error(out2?.error || 'dealers_need_fix_failed');
          showToast('已標記補件','info');
          closeDealerDetail();
          await syncAll();
        }catch(e){
          console.error(e);
          showToast('補件失敗：' + (e?.message || ''), 'error');
        }
      });

      $('#dealerRejectBtn')?.addEventListener('click', async ()=>{
        const auth2 = requireLogin();
        if(!auth2) return;
        try{
          if(!confirm('確定要「拒絕」這筆 Dealer 嗎？')) return;
          showToast('審核中（拒絕）…','info');
          const out2 = await adminApi(auth2.token, { action:'dealers_reject', target_dealer_id: dealer_id });
          if(!out2?.ok) throw new Error(out2?.error || 'dealers_reject_failed');
          showToast('已拒絕','info');
          closeDealerDetail();
          await syncAll();
        }catch(e){
          console.error(e);
          showToast('拒絕失敗：' + (e?.message || ''), 'error');
        }
      });
    }

    // =========================
    // Wire filters / reload
    // =========================
    let _usersReloadTimer = null;
    let _dealersReloadTimer = null;

    function getUsersQueryState(){
      const q = ($('#userSearch')?.value || '').trim();
      const role = ($('#userRoleFilter')?.value || '').trim().toLowerCase();
      return { q, role };
    }

    async function loadUsers({ silent = true } = {}){
      const auth = requireLogin();
      if(!auth) return;
      guardAdmin(auth.user);

      const { q, role } = getUsersQueryState();
      const hint = $('#usersHint');

      try{
        if(!silent) showToast('正在載入用戶資料…','info');

        let out;
        if(!q && !role){
          out = await adminApi(auth.token, { action: 'users_preview' });
          USERS_CACHE = (out?.items || []);
          USERS_TOTAL = Number(out?.total || 0);
          if(hint) hint.textContent = `已隨機抽樣 ${USERS_CACHE.length} 筆（total ${USERS_TOTAL}）。需要時用搜尋/角色篩選查詢。`;
        }else{
          out = await adminApi(auth.token, { action: 'users_list', q, role, limit: 50, offset: 0 });
          USERS_CACHE = (out?.items || []);
          USERS_TOTAL = Number(out?.total || 0);
          if(hint) hint.textContent = `已載入 ${USERS_CACHE.length} 筆（符合 ${USERS_TOTAL}）。(最多顯示 50 筆)`;
        }

        renderUsers(USERS_CACHE);
      }catch(err){
        console.error(err);
        showToast('用戶資料載入失敗（請確認 /.netlify/functions/admin 已部署）', 'error');
      }
    }

    function scheduleUsersReload(){
      clearTimeout(_usersReloadTimer);
      _usersReloadTimer = setTimeout(() => loadUsers({ silent: true }), 450);
    }

    function scheduleDealersReload(){
      clearTimeout(_dealersReloadTimer);
      _dealersReloadTimer = setTimeout(() => loadDealers({ silent: true }), 450);
    }

    function wireFilters(){
      $('#userSearch')?.addEventListener('input', () => scheduleUsersReload());
      $('#userRoleFilter')?.addEventListener('change', () => scheduleUsersReload());
      $('#userStatusFilter')?.addEventListener('change', () => { /* 預留 */ });

      $('#dealerSearch')?.addEventListener('input', () => scheduleDealersReload());
      $('#dealerVerifyFilter')?.addEventListener('change', () => scheduleDealersReload());
    }

    // actions
    $('#refreshBtn')?.addEventListener('click', syncAll);
    $('#dealersRefreshBtn')?.addEventListener('click', ()=> loadDealers({ silent:false }));

    $('#btnCreateQuest')?.addEventListener('click', ()=>showToast('此功能為 UI 預留，後端串接後即可使用。','info'));
    $('#btnCreateUser')?.addEventListener('click', ()=>showToast('此功能為 UI 預留，後端串接後即可使用。','info'));
    $('#btnCreateDealer')?.addEventListener('click', ()=>showToast('此功能為 UI 預留（後續可做 dealer 申請流程）。','info'));

    $('#usersRefreshBtn')?.addEventListener('click', () => {
      const qEl = $('#userSearch');
      const rEl = $('#userRoleFilter');
      const sEl = $('#userStatusFilter');
      if(qEl) qEl.value = '';
      if(rEl) rEl.value = '';
      if(sEl) sEl.value = '';
      loadUsers({ silent: false });
    });

    function wireSocialVerifyUIInit(){
      wireSocialVerifyUI();
      $('#svRefreshBtn')?.addEventListener('click', ()=> loadSubmittedList({ silent:false }));
    }

    // init
    (function init(){
      // Reviews center
      
      const auth = requireLogin();
      if(!auth) return;
      guardAdmin(auth.user);
      wireFilters();
      wireSocialVerifyUIInit();
      syncAll();
    })();
  

    // =========================
    // Reviews Center (listing-review / submission-review)
    // =========================
    async function listingReviewApi(action, payload){
      return fetch("/.netlify/functions/listing-review", {
        method:"POST",
        headers:{ "content-type":"application/json", ...getAuth() },
        body: JSON.stringify({ action, ...payload })
      }).then(r=>r.json());
    }

    async function submissionReviewApi(action, payload){
      return fetch("/.netlify/functions/submission-review", {
        method:"POST",
        headers:{ "content-type":"application/json", ...getAuth() },
        body: JSON.stringify({ action, ...payload })
      }).then(r=>r.json());
    }

    function money(v){
      const n = Number(v||0);
      if(!Number.isFinite(n)) return "-";
      return "$ " + n.toLocaleString("zh-TW");
    }

    function renderListingPending(items){
      const tb = $("#listingPendingTbody");
      if(!items || !items.length){
        tb.innerHTML = `<tr><td colspan="7" class="muted">目前沒有待審刊登</td></tr>`;
        return;
      }
      tb.innerHTML = items.map(x=>{
        const title = escapeHtml(x.title||"-");
        const budget = money(x.budget_total);
        const reward = `${money(x.reward_min)} ~ ${money(x.reward_max)}`;
        return `
          <tr>
            <td>${escapeHtml(x.submitted_at||"-")}</td>
            <td><code>${escapeHtml(x.listing_id||"-")}</code></td>
            <td><code>${escapeHtml(x.dealer_id||"-")}</code></td>
            <td>${title}</td>
            <td>${budget}</td>
            <td>${reward}</td>
            <td>
              <button class="btnMini" data-act="approve" data-id="${escapeHtml(x.listing_id||"")}"><i class="fas fa-check"></i> Approve</button>
              <button class="btnMini danger" data-act="reject" data-id="${escapeHtml(x.listing_id||"")}"><i class="fas fa-xmark"></i> Reject</button>
              <button class="btnMini ghost" data-act="open" data-id="${escapeHtml(x.listing_id||"")}"><i class="fas fa-eye"></i> 詳細</button>
            </td>
          </tr>
        `;
      }).join("");
    }

    function renderSubmissionPending(items){
      const tb = $("#submissionPendingTbody");
      if(!items || !items.length){
        tb.innerHTML = `<tr><td colspan="6" class="muted">目前沒有待審提交</td></tr>`;
        return;
      }
      tb.innerHTML = items.map(x=>{
        const proof = x.proof_url ? `<a href="${escapeHtml(x.proof_url)}" target="_blank" rel="noopener">開啟</a>` : "-";
        return `
          <tr>
            <td>${escapeHtml(x.submitted_at||"-")}</td>
            <td><code>${escapeHtml(x.submission_id||"-")}</code></td>
            <td><code>${escapeHtml(x.quest_id||"-")}</code></td>
            <td><code>${escapeHtml(x.user_id||"-")}</code></td>
            <td>${proof}</td>
            <td>
              <button class="btnMini" data-act="approve" data-id="${escapeHtml(x.submission_id||"")}"><i class="fas fa-check"></i> Approve</button>
              <button class="btnMini danger" data-act="reject" data-id="${escapeHtml(x.submission_id||"")}"><i class="fas fa-xmark"></i> Reject</button>
            </td>
          </tr>
        `;
      }).join("");
    }

    async function loadListingPending(){
      const tb = $("#listingPendingTbody");
      tb.innerHTML = `<tr><td colspan="7" class="muted">載入中…</td></tr>`;
      const res = await listingReviewApi("list_pending", {});
      if(!res || !res.ok){
        tb.innerHTML = `<tr><td colspan="7" class="muted">載入失敗：${escapeHtml(res?.error||"unknown")}</td></tr>`;
        return;
      }
      renderListingPending(res.items || []);
    }

    async function loadSubmissionPending(){
      const tb = $("#submissionPendingTbody");
      tb.innerHTML = `<tr><td colspan="6" class="muted">載入中…</td></tr>`;
      const res = await submissionReviewApi("list_pending", {});
      if(!res || !res.ok){
        tb.innerHTML = `<tr><td colspan="6" class="muted">載入失敗：${escapeHtml(res?.error||"unknown")}</td></tr>`;
        return;
      }
      renderSubmissionPending(res.items || []);
    }

    function wireReviewsCenter(){
      const btn1 = $("#btnReloadListingPending");
      const btn2 = $("#btnReloadSubmissionPending");
      btn1 && btn1.addEventListener("click", loadListingPending);
      btn2 && btn2.addEventListener("click", loadSubmissionPending);

      $("#listingPendingTbody")?.addEventListener("click", async (e)=>{
        const b = e.target.closest("button");
        if(!b) return;
        const act = b.dataset.act;
        const listing_id = b.dataset.id;
        if(!listing_id) return;

        if(act==="open"){
          showToast("提示", "目前後台僅提供快速審核；如需查看完整 car_info_json，請到 Google Sheets 的 dealer_listings 內查看。");
          return;
        }

        if(act==="approve"){
          b.disabled = true;
          const res = await listingReviewApi("approve_first", { listing_id });
          b.disabled = false;
          if(!res?.ok){ showToast("失敗", res?.error||"approve_failed"); return; }
          showToast("完成", `已 Approve：${listing_id}`);
          loadListingPending();
          return;
        }

        if(act==="reject"){
          const reason = prompt("請輸入 Reject 原因（會寫入 review_note / need_fix_reason）：", "");
          if(reason===null) return;
          b.disabled = true;
          const res = await listingReviewApi("reject", { listing_id, reason });
          b.disabled = false;
          if(!res?.ok){ showToast("失敗", res?.error||"reject_failed"); return; }
          showToast("完成", `已 Reject：${listing_id}`);
          loadListingPending();
          return;
        }
      });

      $("#submissionPendingTbody")?.addEventListener("click", async (e)=>{
        const b = e.target.closest("button");
        if(!b) return;
        const act = b.dataset.act;
        const submission_id = b.dataset.id;
        if(!submission_id) return;

        if(act==="approve"){
          const payout_amount = Number(prompt("請輸入 payout_amount（TWD 數字）：", "5000"));
          if(!Number.isFinite(payout_amount) || payout_amount<=0){
            showToast("取消", "payout_amount 不正確");
            return;
          }
          b.disabled = true;
          const res = await submissionReviewApi("approve", { submission_id, payout_amount });
          b.disabled = false;
          if(!res?.ok){ showToast("失敗", res?.error||"approve_failed"); return; }
          showToast("完成", `已 Approve：${submission_id}`);
          loadSubmissionPending();
          return;
        }

        if(act==="reject"){
          const reason = prompt("請輸入 Reject 原因（會寫入 review_reason）：", "");
          if(reason===null) return;
          b.disabled = true;
          const res = await submissionReviewApi("reject", { submission_id, reason });
          b.disabled = false;
          if(!res?.ok){ showToast("失敗", res?.error||"reject_failed"); return; }
          showToast("完成", `已 Reject：${submission_id}`);
          loadSubmissionPending();
          return;
        }
      });
    }

</script>
</body>
</html>
