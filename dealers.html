<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>車行交易者中心 - 星火廣告</title>

  <!-- Icons + Font -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f19;
      --card:rgba(17,24,42,.54);
      --card2:rgba(17,24,42,.36);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.72);
      --line:rgba(255,255,255,.12);
      --shadow:0 18px 60px rgba(0,0,0,.28);
      --radius:18px;
      --max:1100px;
      --grad:linear-gradient(135deg,#4fd1c5,#6c63ff,#ff8a5b);
      --grad2:linear-gradient(135deg,rgba(79,209,197,.18),rgba(108,99,255,.18),rgba(255,138,91,.18));
      --primary:#6c63ff;
      --danger:#ff4d6d;
      --success:#37d67a;
      --warn:#ffbd2e;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 10% 5%, rgba(108,99,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 90% 25%, rgba(255,138,91,.16), transparent 60%),
                  radial-gradient(800px 480px at 20% 90%, rgba(79,209,197,.14), transparent 60%),
                  var(--bg);
      color:var(--text);
      font-family:"Zen Maru Gothic", system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", sans-serif;
      overflow-x:hidden;
    }
    a{color:inherit; text-decoration:none}
    .container{max-width:var(--max); margin:0 auto; padding:0 18px}

    /* Navbar */
    .navbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(12px);
      background: rgba(11,15,25,.62);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .nav-container{
      max-width:var(--max);
      margin:0 auto;
      padding:12px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.5px}
    .brand img{width:34px; height:34px; border-radius:10px}
    .nav-links{display:flex; align-items:center; gap:12px; flex-wrap:wrap}
    .nav-link{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid transparent;
      color:rgba(255,255,255,.86);
      font-weight:900;
      transition:.2s;
      white-space:nowrap;
    }
    .nav-link:hover{background:rgba(255,255,255,.06); border-color:rgba(255,255,255,.10)}
    .nav-user{background:rgba(108,99,255,.12); border-color:rgba(108,99,255,.30)}
    .nav-logout{background:rgba(255,77,109,.10); border-color:rgba(255,77,109,.28)}
    .nav-admin{background:rgba(255,189,46,.10); border-color:rgba(255,189,46,.28)}
    .nav-sep{width:1px; height:26px; background:rgba(255,255,255,.14); margin:0 6px}
    .menu-btn{
      display:none;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      color:rgba(255,255,255,.92);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
    }

    /* Hero */
    .dashboard-header{padding:26px 0 10px}
    .hero-card{
      background: var(--grad2);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
      overflow:hidden;
      position:relative;
    }
    .hero-card:before{
      content:"";
      position:absolute; inset:-2px;
      background: var(--grad);
      opacity:.10;
      filter: blur(10px);
      z-index:0;
    }
    .hero-left,.hero-right{position:relative; z-index:1}
    .hero-kicker{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-weight:900;
      font-size:12px;
      color:rgba(255,255,255,.88);
    }
    .chip-strong{background: rgba(79,209,197,.16); border-color: rgba(79,209,197,.30)}
    .chip-success{background: rgba(55,214,122,.16)!important; border-color: rgba(55,214,122,.30)!important}
    .chip-danger{background: rgba(255,77,109,.14)!important; border-color: rgba(255,77,109,.30)!important}
    .chip-warn{background: rgba(255,189,46,.14)!important; border-color: rgba(255,189,46,.30)!important}
    .dot{width:8px; height:8px; border-radius:999px; background:rgba(255,255,255,.60)}
    .hero-title{margin:10px 0 6px; font-size:30px; letter-spacing:.2px}
    .hero-sub{margin:0; color:rgba(255,255,255,.78); line-height:1.6}
    .hero-actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    .btn{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:rgba(255,255,255,.92);
      font-weight:900;
      cursor:pointer;
      transition:.2s;
    }
    .btn:hover{filter:brightness(1.08)}
    .btn-primary{
      background: linear-gradient(135deg, rgba(79,209,197,.22), rgba(108,99,255,.26));
      border-color: rgba(108,99,255,.34);
    }
    .btn-ghost{background:rgba(255,255,255,.05)}
    .profile-card{
      background: rgba(11,15,25,.35);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 14px;
    }
    .profile-top{display:flex; gap:12px; align-items:center}
    .avatar{
      width:46px; height:46px; border-radius:16px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(79,209,197,.18);
      border: 1px solid rgba(79,209,197,.25);
      font-size:18px;
    }
    .profile-name{font-weight:900; font-size:16px}
    .profile-sub{color:rgba(255,255,255,.74); font-weight:800; font-size:13px; margin-top:2px}
    .profile-stats{
      display:grid; grid-template-columns:repeat(2,1fr);
      gap:10px;
      margin-top:12px;
    }
    .pstat{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding:10px 12px;
    }
    .pstat-label{color:rgba(255,255,255,.72); font-size:12px; font-weight:900}
    .pstat-value{font-size:18px; font-weight:900; margin-top:4px}
    .profile-actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}

    .stats-row{
      display:grid;
      grid-template-columns: repeat(4,1fr);
      gap:12px;
      margin-top:14px;
    }
    .stat-card{
      background: rgba(17,24,42,.42);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 12px;
      display:flex;
      gap:12px;
      align-items:center;
    }
    .stat-icon{
      width:44px; height:44px; border-radius:16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      display:flex; align-items:center; justify-content:center;
      font-size:18px;
    }
    .stat-label{color:rgba(255,255,255,.72); font-weight:900; font-size:12px}
    .stat-value{font-weight:900; font-size:18px; margin-top:3px}

    .section{padding:20px 0}
    .section-head{margin-bottom:10px}
    .section-title{margin:0; font-size:20px; font-weight:900}
    .section-sub{margin:6px 0 0; color:rgba(255,255,255,.74); font-weight:800; line-height:1.6}
    .card{
      background: var(--card);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .card-title{margin:0 0 8px; font-size:16px; font-weight:900}
    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:14px}

    /* Inputs / tables */
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:14px}
    .toolbar .left{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .field{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .input, .select{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
      min-height: 40px;
    }
    .input{min-width: 220px}
    .select{min-width: 160px}
    .table-wrap{overflow:auto;border-radius:16px;border:1px solid rgba(255,255,255,.10);background: rgba(255,255,255,.04)}
    table{width:100%;border-collapse:collapse;min-width:820px}
    th,td{padding:12px 14px;text-align:left;border-bottom:1px solid rgba(255,255,255,.08);font-size:14px}
    th{color: rgba(255,255,255,.78);font-weight:900}
    td{color: rgba(255,255,255,.90)}
    tr:hover td{background: rgba(255,255,255,.03)}
    .muted{color: rgba(255,255,255,.70)}
    .empty{
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 16px;
      color: rgba(255,255,255,.78);
      line-height: 1.6;
    }

    /* Toast */
    .toast-wrap{
      position:fixed; right:18px; bottom:18px;
      display:flex; flex-direction:column; gap:10px;
      z-index: 90;
      max-width: min(420px, calc(100vw - 36px));
    }
    .toast{
      display:flex; gap:10px; align-items:flex-start;
      padding:12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(11,15,25,.82);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      animation: pop .18s ease-out;
    }
    @keyframes pop{from{transform:translateY(8px); opacity:0}to{transform:translateY(0); opacity:1}}
    .toast-icon{width:34px; height:34px; border-radius:14px; display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12)}
    .toast-msg{font-weight:900; color:rgba(255,255,255,.92); line-height:1.5}
    .toast-close{
      margin-left:auto; background:transparent; border:none; color:rgba(255,255,255,.76);
      cursor:pointer; padding:6px 8px; border-radius:10px;
    }
    .toast-success .toast-icon{background: rgba(55,214,122,.14); border-color: rgba(55,214,122,.26)}
    .toast-error .toast-icon{background: rgba(255,77,109,.14); border-color: rgba(255,77,109,.26)}
    .toast-warn .toast-icon{background: rgba(255,189,46,.14); border-color: rgba(255,189,46,.26)}
    .toast-info .toast-icon{background: rgba(108,99,255,.14); border-color: rgba(108,99,255,.26)}

    /* Skeleton */
    .skeleton{
      position:relative;
      color:transparent!important;
      user-select:none;
      border-radius:10px;
      background: rgba(255,255,255,.06);
      overflow:hidden;
    }
    .skeleton:after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.14), transparent);
      transform: translateX(-100%);
      animation: shimmer 1.2s infinite;
    }
    @keyframes shimmer{to{transform:translateX(100%)}}
    .skeleton.mid{display:inline-block; min-width:80px}
    .skeleton.long{display:inline-block; min-width:220px}

    /* Responsive */
    @media (max-width: 980px){
      .hero-card{grid-template-columns:1fr}
      .stats-row{grid-template-columns:repeat(2,1fr)}
      .grid-2{grid-template-columns:1fr}
    }
    @media (max-width: 720px){
      .menu-btn{display:inline-flex}
      .nav-links{
        position:absolute;
        top:60px; right:18px; left:18px;
        padding:10px;
        border-radius:16px;
        background: rgba(11,15,25,.86);
        border:1px solid rgba(255,255,255,.10);
        box-shadow: var(--shadow);
        display:none;
      }
      .nav-links.open{display:flex; flex-direction:column; align-items:stretch}
      .nav-sep{display:none}
      .stats-row{grid-template-columns:1fr}
      table{min-width:760px}
    }
  </style>
</head>

<body>
  <nav class="navbar">
    <div class="nav-container">
      <a class="brand" href="index.html">
        <img src="./picture/logo.png" alt="星火廣告 Logo">
        <span>星火廣告</span>
      </a>

      <button class="menu-btn" id="menuBtn" type="button" aria-label="開啟選單" aria-expanded="false" aria-controls="navLinks">
        <i class="fas fa-ellipsis-vertical"></i>
      </button>

      <div class="nav-links" id="navLinks">
        <a href="#top" class="nav-link"><i class="fas fa-gauge-high"></i> 總覽</a>
        <a href="#listings" class="nav-link"><i class="fas fa-bullhorn"></i> 刊登</a>
        <a href="#transactions" class="nav-link"><i class="fas fa-receipt"></i> 成交</a>
        <a href="#billing" class="nav-link"><i class="fas fa-wallet"></i> 方案/帳務</a>

        <span class="nav-sep"></span>

        <a href="dashboard.html" class="nav-link"><i class="fas fa-house-user"></i> 會員中心</a>
        <a href="index.html" class="nav-link"><i class="fas fa-house"></i> 返回首頁</a>

        <a href="admin.html" class="nav-link nav-admin" id="adminLink" style="display:none">
          <i class="fas fa-crown"></i> 管理後台
        </a>

        <span class="nav-sep"></span>

        <a href="#" class="nav-link nav-user" id="navUser"><i class="fas fa-id-card"></i> <span id="navUsername">dealer</span></a>
        <a href="#" class="nav-link nav-logout" id="logoutBtn"><i class="fas fa-right-from-bracket"></i> 登出</a>
      </div>
    </div>
  </nav>

  <section class="dashboard-header" id="top">
    <div class="container">
      <div class="hero-card">
        <div class="hero-left">
          <div class="hero-kicker">
            <span class="chip chip-strong"><i class="fas fa-shop"></i> Dealer</span>
            <span class="chip" id="syncBadge"><span class="dot"></span><span id="syncText">尚未同步</span></span>
            <span class="chip" id="verifyChip" style="display:none"><i class="fas fa-shield"></i><span id="verifyText">未驗證</span></span>
          </div>

          <h1 class="hero-title">車行交易者中心</h1>
          <p class="hero-sub">管理車源刊登、成交回報、方案/帳務，一頁掌控。<span class="muted">（Admin 亦可進入）</span></p>

          <div class="hero-actions">
            <a class="btn btn-primary" href="#listings"><i class="fas fa-bullhorn"></i> 新增刊登</a>
            <a class="btn" href="#transactions"><i class="fas fa-receipt"></i> 查看成交</a>
            <a class="btn" href="#billing"><i class="fas fa-wallet"></i> 方案/帳務</a>
          </div>
        </div>

        <div class="hero-right">
          <div class="profile-card">
            <div class="profile-top">
              <div class="avatar"><i class="fas fa-shop"></i></div>
              <div class="profile-meta">
                <div class="profile-name"><span id="dealerName" class="skeleton mid">車行</span></div>
                <div class="profile-sub"><span id="dealerEmail" class="skeleton long">—</span></div>
              </div>
            </div>

            <div class="profile-stats">
              <div class="pstat"><div class="pstat-label">刊登中</div><div class="pstat-value"><span id="statLive" class="skeleton mid">0</span></div></div>
              <div class="pstat"><div class="pstat-label">待審核</div><div class="pstat-value"><span id="statReview" class="skeleton mid">0</span></div></div>
              <div class="pstat"><div class="pstat-label">本月成交</div><div class="pstat-value"><span id="statDeals" class="skeleton mid">0</span></div></div>
              <div class="pstat"><div class="pstat-label">本月費用</div><div class="pstat-value"><span id="statSpend" class="skeleton mid">0</span></div></div>
            </div>

            <div class="profile-actions">
              <button class="btn btn-ghost" id="refreshBtn" type="button"><i class="fas fa-rotate"></i> 重新同步</button>
              <a class="btn btn-ghost" href="dashboard.html"><i class="fas fa-house-user"></i> 會員中心</a>
            </div>
          </div>
        </div>
      </div>

      <div class="stats-row">
        <div class="stat-card"><div class="stat-icon"><i class="fas fa-eye"></i></div><div class="stat-body"><div class="stat-label">今日瀏覽</div><div class="stat-value"><span id="todayViews" class="skeleton mid">0</span></div></div></div>
        <div class="stat-card"><div class="stat-icon"><i class="fas fa-message"></i></div><div class="stat-body"><div class="stat-label">今日詢問</div><div class="stat-value"><span id="todayLeads" class="skeleton mid">0</span></div></div></div>
        <div class="stat-card"><div class="stat-icon"><i class="fas fa-file-circle-exclamation"></i></div><div class="stat-body"><div class="stat-label">待補件</div><div class="stat-value"><span id="needFix" class="skeleton mid">0</span></div></div></div>
        <div class="stat-card"><div class="stat-icon"><i class="fas fa-circle-check"></i></div><div class="stat-body"><div class="stat-label">本月成交</div><div class="stat-value"><span id="monthDeals" class="skeleton mid">0</span></div></div></div>
      </div>
    </div>
  </section>

  <section class="section" id="listings">
    <div class="container">
      <div class="section-head">
        <h2 class="section-title"><i class="fas fa-bullhorn"></i> 車源刊登管理</h2>
        <p class="section-sub">新增/編輯刊登、上架下架、補件修正（UI 已備妥，後端可後續串接）。</p>
      </div>

      <div class="grid-2">
        <div class="card">
          <h3 class="card-title"><i class="fas fa-circle-plus"></i> 快速新增刊登（規劃）</h3>

          <div class="field">
            <input class="input" id="vBrand" placeholder="品牌/車系（例：Toyota Altis）" />
            <input class="input" id="vYear" placeholder="年份（例：2019）" />
          </div>

          <div style="height:10px"></div>

          <div class="field">
            <input class="input" id="vPrice" placeholder="售價（例：39.8萬）" />
            <input class="input" id="vMileage" placeholder="里程（例：8.6萬 km）" />
          </div>

          <div style="height:10px"></div>

          <div class="field">
            <select class="select" id="vStatus">
              <option value="draft">草稿</option>
              <option value="review">送審</option>
              <option value="live">上架</option>
              <option value="off">下架</option>
            </select>

            <select class="select" id="vPlan">
              <option value="basic">方案：Basic</option>
              <option value="plus">方案：Plus</option>
              <option value="pro">方案：Pro</option>
            </select>
          </div>

          <div style="height:12px"></div>

          <button class="btn btn-primary" id="btnCreateListing" type="button">
            <i class="fas fa-upload"></i> 送出（先做介面）
          </button>

          <div style="height:10px"></div>
          <div class="muted">提示：車輛資訊需真實（年份/里程/事故等），後續可在協議中強制。</div>
        </div>

        <div class="card">
          <h3 class="card-title"><i class="fas fa-list"></i> 我的刊登（待串接）</h3>
          <div class="toolbar">
            <div class="left">
              <input class="input" id="listingSearch" placeholder="搜尋 車系 / 編號 / 狀態" />
              <select class="select" id="listingFilter">
                <option value="">全部狀態</option>
                <option value="live">上架</option>
                <option value="review">送審</option>
                <option value="draft">草稿</option>
                <option value="off">下架</option>
              </select>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="width:160px">listing_id</th>
                  <th style="width:220px">車系</th>
                  <th style="width:120px">狀態</th>
                  <th style="width:140px">方案</th>
                  <th style="width:140px">更新</th>
                  <th style="width:220px">操作</th>
                </tr>
              </thead>
              <tbody id="listingsTbody">
                <tr>
                  <td colspan="6">
                    <div class="empty">
                      <div><b>尚未載入刊登資料</b></div>
                      <div class="muted">後端串接完成後，這裡會顯示你的車源列表。</div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

        </div>
      </div>
    </div>
  </section>

  <section class="section" id="transactions">
    <div class="container">
      <div class="section-head">
        <h2 class="section-title"><i class="fas fa-receipt"></i> 成交/交易管理</h2>
        <p class="section-sub">成交回報、媒合來源（推廣夥伴/平台）、費用與分潤記錄。</p>
      </div>

      <div class="card">
        <div class="toolbar">
          <div class="left">
            <input class="input" id="dealSearch" placeholder="搜尋 車輛 / buyer / deal_id" />
            <select class="select" id="dealStatusFilter">
              <option value="">全部狀態</option>
              <option value="pending">待確認</option>
              <option value="confirmed">已確認</option>
              <option value="rejected">已退回</option>
            </select>
          </div>
          <div class="right">
            <button class="btn btn-primary" id="btnReportDeal" type="button">
              <i class="fas fa-flag-checkered"></i> 回報成交（規劃）
            </button>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:160px">deal_id</th>
                <th style="width:240px">車輛</th>
                <th style="width:160px">媒合來源</th>
                <th style="width:140px">狀態</th>
                <th style="width:160px">費用</th>
                <th style="width:220px">操作</th>
              </tr>
            </thead>
            <tbody id="dealsTbody">
              <tr>
                <td colspan="6">
                  <div class="empty">
                    <div><b>尚未載入成交資料</b></div>
                    <div class="muted">後端串接後可顯示：成交時間、金額、分潤、付款狀態。</div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </section>

  <section class="section" id="billing">
    <div class="container">
      <div class="section-head">
        <h2 class="section-title"><i class="fas fa-wallet"></i> 方案/帳務</h2>
        <p class="section-sub">目前方案、帳單、付款狀態與升級（UI 預留）。</p>
      </div>

      <div class="grid-2">
        <div class="card">
          <h3 class="card-title"><i class="fas fa-gem"></i> 目前方案</h3>
          <div class="empty" id="planBox">
            <div><b>尚未載入方案</b></div>
            <div class="muted">串接後顯示：方案等級、到期日、可刊登數、曝光加成等。</div>
          </div>
          <div style="height:12px"></div>
          <button class="btn btn-primary" id="btnUpgrade" type="button"><i class="fas fa-arrow-up-right-dots"></i> 升級方案（規劃）</button>
        </div>

        <div class="card">
          <h3 class="card-title"><i class="fas fa-file-invoice-dollar"></i> 帳單紀錄</h3>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="width:160px">invoice_id</th>
                  <th style="width:180px">期間</th>
                  <th style="width:140px">金額</th>
                  <th style="width:140px">狀態</th>
                  <th style="width:220px">操作</th>
                </tr>
              </thead>
              <tbody id="invoicesTbody">
                <tr>
                  <td colspan="5">
                    <div class="empty">
                      <div><b>尚未載入帳單</b></div>
                      <div class="muted">串接後可提供下載發票/收據與付款憑證。</div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </section>

  <div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

  <script>
    function requireLogin(){
      const token = localStorage.getItem('xinghuo_token');
      const u = JSON.parse(localStorage.getItem('xinghuo_user') || 'null');
      if (!token || !u) { location.href = './login.html'; return null; }
      return { token, user: u };
    }
    function guardDealerOrAdmin(user){
      const role = (user && user.role) ? String(user.role).toLowerCase() : '';
      if (role !== 'dealer' && role !== 'admin') location.href = './dashboard.html';
    }

    const $ = (sel) => document.querySelector(sel);
    const escapeHtml = (s) => String(s ?? '')
      .replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;').replaceAll("'", '&#039;');

    function showToast(message, type='info'){
      const wrap = $('#toastWrap'); if(!wrap) return;
      const iconMap = { success:'fa-circle-check', error:'fa-triangle-exclamation', warn:'fa-circle-exclamation', info:'fa-circle-info' };
      const el = document.createElement('div');
      el.className = 'toast ' + (type ? 'toast-' + type : '');
      el.innerHTML = `
        <div class="toast-icon"><i class="fas ${iconMap[type] || 'fa-circle-info'}"></i></div>
        <div class="toast-body"><div class="toast-msg">${escapeHtml(message)}</div></div>
        <button class="toast-close" aria-label="關閉"><i class="fas fa-xmark"></i></button>
      `;
      wrap.appendChild(el);
      const close = () => el.remove();
      el.querySelector('.toast-close')?.addEventListener('click', close);
      setTimeout(close, 4200);
    }

    function setSyncBadge(state){
      const badge = $('#syncBadge'); const text = $('#syncText');
      if(!badge || !text) return;
      badge.classList.remove('chip-success','chip-warn','chip-danger');
      if(state === 'syncing'){ text.textContent = '同步中'; badge.classList.add('chip-warn'); }
      else if(state === 'ok'){ text.textContent = '已同步'; badge.classList.add('chip-success'); }
      else if(state === 'fail'){ text.textContent = '失敗'; badge.classList.add('chip-danger'); }
      else { text.textContent = '尚未同步'; }
    }

    function setSkeleton(on){
      ['#dealerName','#dealerEmail','#statLive','#statReview','#statDeals','#statSpend','#todayViews','#todayLeads','#needFix','#monthDeals']
        .forEach(id => { const el = $(id); if(!el) return; on ? el.classList.add('skeleton') : el.classList.remove('skeleton'); });
    }

    function logout(){
      localStorage.removeItem('xinghuo_token');
      localStorage.removeItem('xinghuo_user');
      localStorage.removeItem('xinghuo_my_quests');
      location.href = './index.html';
    }
    $('#logoutBtn')?.addEventListener('click', (e)=>{ e.preventDefault(); logout(); });

    (function initMenu(){
      const btn = $('#menuBtn'); const links = $('#navLinks');
      if(!btn || !links) return;
      btn.addEventListener('click', () => {
        const open = links.classList.toggle('open');
        btn.setAttribute('aria-expanded', open ? 'true' : 'false');
      });
      links.querySelectorAll('a.nav-link').forEach(a => {
        a.addEventListener('click', () => { links.classList.remove('open'); btn.setAttribute('aria-expanded','false'); });
      });
    })();

    async function fetchDealerSnapshot(token){
      const res = await fetch('/.netlify/functions/dealer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify({ action: 'snapshot' })
      });
      if(!res.ok){
        const t = await res.text().catch(()=> '');
        throw new Error('dealer api ' + res.status + ': ' + (t || res.statusText));
      }
      return await res.json();
    }

    function applySnapshotUI(snapshot){
      const s = snapshot?.stats || {};
      const set = (id, val) => { const el = $(id); if(el) el.textContent = String(val ?? 0); };
      set('#statLive', s.live); set('#statReview', s.review); set('#statDeals', s.deals); set('#statSpend', s.spend);
      set('#todayViews', s.todayViews); set('#todayLeads', s.todayLeads); set('#needFix', s.needFix); set('#monthDeals', s.monthDeals);

      const verify = (snapshot?.dealer?.verify_status || '').toLowerCase();
      const chip = $('#verifyChip'); const vText = $('#verifyText');
      if(chip && vText && verify){
        chip.style.display = '';
        chip.classList.remove('chip-success','chip-warn','chip-danger');
        if(verify === 'verified'){ chip.classList.add('chip-success'); vText.textContent = '已通過'; }
        else if(verify === 'need_fix'){ chip.classList.add('chip-warn'); vText.textContent = '補件中'; }
        else if(verify === 'rejected'){ chip.classList.add('chip-danger'); vText.textContent = '已拒絕'; }
        else { chip.classList.add('chip-warn'); vText.textContent = '未審核'; }
      }
    }

    async function syncAll(){
      const auth = requireLogin(); if(!auth) return;
      guardDealerOrAdmin(auth.user);

      $('#navUsername').textContent = auth.user.username || auth.user.name || 'dealer';
      const role = String(auth.user.role || '').toLowerCase();
      const adminLink = $('#adminLink');
      if(adminLink) adminLink.style.display = (role === 'admin') ? '' : 'none';

      $('#dealerName').textContent = auth.user.name || auth.user.username || '車行';
      $('#dealerEmail').textContent = auth.user.email || '-';

      setSkeleton(true);
      setSyncBadge('syncing');

      try{
        const snap = await fetchDealerSnapshot(auth.token);
        if(snap?.dealer?.name) $('#dealerName').textContent = snap.dealer.name;
        if(snap?.dealer?.email) $('#dealerEmail').textContent = snap.dealer.email;
        applySnapshotUI(snap);
        setSyncBadge('ok');
        showToast('同步完成', 'success');
      } catch (err){
        setSyncBadge('fail');
        applySnapshotUI({ stats: { live:0, review:0, deals:0, spend:0, todayViews:0, todayLeads:0, needFix:0, monthDeals:0 }, dealer: { verify_status: '' } });
        showToast('尚未串接後端資料（可先使用介面）', 'warn');
      } finally{
        setSkeleton(false);
      }
    }

    $('#refreshBtn')?.addEventListener('click', syncAll);
    $('#btnCreateListing')?.addEventListener('click', ()=>showToast('此功能為 UI 預留，後端串接後即可使用。','info'));
    $('#btnReportDeal')?.addEventListener('click', ()=>showToast('此功能為 UI 預留，後端串接後即可使用。','info'));
    $('#btnUpgrade')?.addEventListener('click', ()=>showToast('此功能為 UI 預留，後端串接後即可使用。','info'));

    function wireFilters(){
      function filterRows(tbodySel, q, extra){
        const tbody = $(tbodySel); if(!tbody) return;
        const rows = Array.from(tbody.querySelectorAll('tr') || []);
        rows.forEach(r => {
          const text = (r.textContent || '').toLowerCase();
          let ok = !q || text.includes(q);
          if(ok && extra) ok = extra(text);
          r.style.display = ok ? '' : 'none';
        });
      }

      $('#listingSearch')?.addEventListener('input', () => {
        const q = ($('#listingSearch')?.value || '').trim().toLowerCase();
        const st = ($('#listingFilter')?.value || '').trim().toLowerCase();
        filterRows('#listingsTbody', q, st ? (text => text.includes(st)) : null);
      });
      $('#listingFilter')?.addEventListener('change', () => {
        const q = ($('#listingSearch')?.value || '').trim().toLowerCase();
        const st = ($('#listingFilter')?.value || '').trim().toLowerCase();
        filterRows('#listingsTbody', q, st ? (text => text.includes(st)) : null);
      });

      $('#dealSearch')?.addEventListener('input', () => {
        const q = ($('#dealSearch')?.value || '').trim().toLowerCase();
        const st = ($('#dealStatusFilter')?.value || '').trim().toLowerCase();
        filterRows('#dealsTbody', q, st ? (text => text.includes(st)) : null);
      });
      $('#dealStatusFilter')?.addEventListener('change', () => {
        const q = ($('#dealSearch')?.value || '').trim().toLowerCase();
        const st = ($('#dealStatusFilter')?.value || '').trim().toLowerCase();
        filterRows('#dealsTbody', q, st ? (text => text.includes(st)) : null);
      });
    }

    (function init(){
      const auth = requireLogin(); if(!auth) return;
      guardDealerOrAdmin(auth.user);
      wireFilters();
      syncAll();
    })();
  </script>
</body>
</html>
