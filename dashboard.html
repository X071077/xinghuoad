<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æœƒå“¡å„€è¡¨æ¿ - æ˜Ÿç«å»£å‘Š</title>

  <!-- Icons + Font -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f19;
      --card:rgba(17,24,42,.86);
      --text:#ffffff;
      --muted:#ffffff;
      --line:rgba(255,255,255,.12);
      --accent:#32e0c4;
      --accent2:#6ea8ff;
      --danger:#ff5c7a;
      --gold:#FFD700;
      --radius:18px;
      --shadow:0 18px 60px rgba(0,0,0,.35);
      --font:"Zen Maru Gothic", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial;
    }

    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      font-family:var(--font);
      background:
        radial-gradient(1100px 500px at 20% -10%, rgba(50,224,196,.16), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(110,168,255,.16), transparent 55%),
        var(--bg);
      color:var(--text);
      font-size:24px;
    }

    .container{width:min(1100px, 92%); margin:0 auto;}
    .section{padding:44px 0;}
    .glass{
      background: var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }

    /* Navbar */
    .navbar{
      position:fixed; top:0; left:0; right:0; z-index:50;
      background: rgba(15, 23, 42, 0.75);
      border-bottom: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
    }
    .nav-container{
      width:min(1200px, 92%);
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 0;
      gap:16px;
      position:relative;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      text-decoration:none; color:var(--text);
      font-weight:800;
    }
    .brand img{
      width:56px; height:56px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      padding:7px;
      object-fit:contain;
      box-shadow: 0 10px 30px rgba(50,224,196,.14);
    }
    .nav-links{
      display:flex; flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
    }
    .nav-link{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 14px;
      border-radius:14px;
      color:var(--text);
      text-decoration:none;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      transition: transform .2s ease, border-color .2s ease, background .2s ease;
      font-size:20px;
      white-space:nowrap;
    }
    .nav-link:hover{
      transform: translateY(-2px);
      border-color: rgba(50,224,196,.45);
      background: rgba(50,224,196,.10);
    }
    .nav-link.danger{
      border-color: rgba(255,92,122,.35);
      background: rgba(255,92,122,.10);
    }
    .nav-link.danger:hover{
      border-color: rgba(255,92,122,.55);
      background: rgba(255,92,122,.18);
    }

    .menu-btn{
      display:none;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--text);
      border-radius:14px;
      padding:10px 14px;
      cursor:pointer;
      font-size:20px;
      line-height:1;
      transition: transform .2s ease, border-color .2s ease, background .2s ease;
    }
    .menu-btn:hover{
      transform: translateY(-2px);
      border-color: rgba(50,224,196,.45);
      background: rgba(50,224,196,.10);
    }

    /* Header */
    .dashboard-header{
      margin-top:92px;
      padding:54px 0 34px;
      position:relative;
      overflow:hidden;
    }
    .dashboard-header::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(900px 360px at 15% 20%, rgba(255,215,0,.10), transparent 60%),
        radial-gradient(900px 420px at 90% 30%, rgba(157,78,221,.12), transparent 55%),
        radial-gradient(900px 520px at 60% 110%, rgba(50,224,196,.10), transparent 60%);
      pointer-events:none;
    }
    .header-inner{
      position:relative;
      text-align:center;
    }
    .welcome-title{
      margin:0 0 10px;
      font-size:44px;
      font-weight:900;
      text-shadow: 2px 2px 6px rgba(0,0,0,.45);
    }
    .welcome-subtitle{
      margin:0 0 18px;
      opacity:.95;
      font-size:22px;
    }
    .level-badge{
      display:inline-flex;
      align-items:center;
      gap:12px;
      padding:10px 18px;
      border-radius:999px;
      border:1px solid rgba(255,215,0,.45);
      background: rgba(0,0,0,.22);
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      flex-wrap:wrap;
      justify-content:center;
    }
    .level-number{
      font-size:28px;
      font-weight:900;
      color:var(--gold);
    }
    .badge-sep{opacity:.6}

    /* Quick Profile Card */
    .profile-row{
      margin-top:24px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:18px;
      align-items:stretch;
    }
    .profile-card{
      padding:22px;
      text-align:left;
    }
    .profile-title{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .profile-title h3{
      margin:0;
      font-size:26px;
      font-weight:900;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size:18px;
      opacity:.95;
      white-space:nowrap;
    }
    .kv{
      display:grid;
      grid-template-columns: 160px 1fr;
      row-gap:10px;
      column-gap:10px;
      font-size:20px;
      line-height:1.6;
    }
    .kv .k{opacity:.85}
    .kv .v{font-weight:800; word-break:break-word}
    .actions{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:14px;
    }

    /* Buttons */
    .btn{
      border:0;
      cursor:pointer;
      border-radius:18px;
      padding:16px 18px;
      font-size:22px;
      font-weight:900;
      color:var(--text);
      background: linear-gradient(135deg, rgba(50,224,196,.95), rgba(110,168,255,.95));
      box-shadow: 0 10px 30px rgba(50,224,196,.14);
      text-shadow: 0 1px 2px rgba(0,0,0,.35);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .btn:hover{transform: translateY(-2px); box-shadow: 0 14px 38px rgba(50,224,196,.22);}
    .btn.secondary{
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
      box-shadow: none;
    }
    .btn.secondary:hover{border-color: rgba(50,224,196,.45);}

    /* XP */
    .xp-container{margin-top:18px;}
    .xp-label{
      display:flex; justify-content:space-between; gap:10px;
      font-weight:800;
      margin-bottom:10px;
      font-size:20px;
    }
    .xp-bar{
      height:26px;
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
    }
    .xp-fill{
      height:100%;
      width: 0%;
      border-radius:999px;
      background: linear-gradient(90deg, #06C755, #32e0c4, #6ea8ff, #9d4edd);
      transition: width 900ms cubic-bezier(0.34, 1.56, 0.64, 1);
      position:relative;
      overflow:hidden;
    }
    .xp-fill::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.28), transparent);
      animation: xpShine 2s infinite;
    }
    @keyframes xpShine { 0%{transform:translateX(-100%)} 100%{transform:translateX(100%)} }

    /* Stats */
    .section-title{
      margin:0 0 18px;
      font-size:34px;
      font-weight:900;
      text-align:center;
    }
    .stats-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap:18px;
      margin-top:18px;
    }
    .stat-card{
      padding:22px;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(135deg, rgba(17,24,42,.86) 0%, rgba(45,55,72,.70) 100%);
      box-shadow: 0 10px 30px rgba(0,0,0,.28);
      transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease;
      position:relative;
      overflow:hidden;
    }
    .stat-card::before{
      content:"";
      position:absolute; top:0; left:0; right:0;
      height:4px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      opacity:.9;
    }
    .stat-card:hover{
      transform: translateY(-6px);
      box-shadow: 0 16px 44px rgba(0,0,0,.38);
      border-color: rgba(50,224,196,.28);
    }
    .stat-icon{font-size:34px; margin-bottom:10px;}
    .stat-value{font-size:44px; font-weight:900; margin:6px 0 4px;}
    .stat-label{opacity:.9; font-weight:700;}

    /* Quests */
    .quest-hall{padding:34px 0;}
    .quest-wrap{padding:28px;}
    .quest-card{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(135deg, rgba(45,55,72,.72) 0%, rgba(30,41,59,.85) 100%);
      padding:20px;
      margin-bottom:14px;
      transition: transform .2s ease, border-color .2s ease, box-shadow .2s ease;
      position:relative;
      overflow:hidden;
    }
    .quest-card:hover{
      transform: translateX(8px);
      border-color: rgba(110,168,255,.28);
      box-shadow: 0 14px 34px rgba(0,0,0,.34);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:6px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      margin-bottom:10px;
    }
    .pill.green{border-color: rgba(6,199,85,.35)}
    .pill.orange{border-color: rgba(243,156,18,.40)}
    .pill.red{border-color: rgba(231,76,60,.45)}
    .pill.blue{border-color: rgba(110,168,255,.45)}
    .quest-row{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:18px;
      flex-wrap:wrap;
    }
    .quest-row h3{margin:0 0 10px; font-size:26px;}
    .quest-desc{opacity:.92; line-height:1.7; margin:0 0 10px;}
    .quest-meta{display:flex; gap:14px; flex-wrap:wrap; opacity:.92; font-size:18px;}
    .quest-side{min-width:240px; text-align:right;}
    .quest-reward{color:var(--gold); font-weight:900; font-size:34px; margin-bottom:10px;}

    .quest-photos{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .quest-photos img{
      width:120px;
      height:90px;
      object-fit:cover;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
    }

    /* My quests */
    .my-quests{
      margin-top:18px;
      padding:18px;
      border-radius:18px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.04);
    }
    .my-quests h4{margin:0 0 10px; font-size:22px;}
    .my-quest-item{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      margin-bottom:10px;
    }
    .my-quest-item:last-child{margin-bottom:0}
    .my-quest-item .name{font-weight:900}
    .my-quest-item .mini{opacity:.9; font-size:18px; line-height:1.6}
    .my-quest-actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center;}
    .btnMini{
      border-radius:14px;
      padding:10px 12px;
      font-size:18px;
      font-weight:900;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      white-space:nowrap;
    }
    .btnMini:hover{border-color: rgba(50,224,196,.45);}
    .btnMini.danger{border-color: rgba(255,92,122,.35); background: rgba(255,92,122,.10);}
    .btnMini.danger:hover{border-color: rgba(255,92,122,.55);}
    .btnMini.primary{
      border-color: rgba(50,224,196,.35);
      background: rgba(50,224,196,.16);
    }

    .submit-panel{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }
    .submit-panel input[type="text"], .submit-panel input[type="file"]{
      width:100%;
      margin-top:10px;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--text);
      font-size:18px;
    }
    .submit-panel .hint{
      font-size:16px;
      opacity:.9;
      margin-top:8px;
      line-height:1.6;
    }

    /* Tools */
    .toolbox{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap:18px;
      margin-top:18px;
    }
    .tool-card{padding:22px;}
    .tool-card h3{margin:0 0 10px; font-size:26px;}
    .codebox{
      padding:14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      word-break:break-all;
      font-size:18px;
    }

    /* Toast */
    .toast{
      position: fixed;
      right: 18px;
      bottom: 18px;
      max-width: min(520px, calc(100vw - 36px));
      padding: 14px 16px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(17,24,42,.92);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      display:none;
      z-index: 99;
      font-size:20px;
      line-height:1.5;
      white-space:pre-line;
    }
    .toast.ok{border-color: rgba(50,224,196,.35);}
    .toast.error{border-color: rgba(255,92,122,.35); background: rgba(255,92,122,.10);}

    /* Footer */
    footer{
      margin-top:40px;
      padding:34px 0;
      border-top:1px solid rgba(255,255,255,.10);
      opacity:.95;
    }
    .footer-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:18px;
      margin-bottom:14px;
    }
    .footer-grid h3{margin:0 0 10px; font-size:22px;}
    .footer-link{color:var(--text); text-decoration:underline; text-underline-offset:3px; display:inline-block; margin:6px 0;}
    .footer-bottom{opacity:.9; font-size:18px;}

    /* âœ… Responsive + dropdown menu (mobile) */
    @media (max-width: 900px){
      .profile-row{grid-template-columns: 1fr; }
      .quest-side{text-align:left}
      .footer-grid{grid-template-columns: 1fr}
      .menu-btn{ display:inline-flex; align-items:center; justify-content:center; }
      .nav-links{
        position:absolute;
        top: calc(100% + 10px);
        left: 0;
        right: 0;
        display:none;
        flex-direction:column;
        align-items:stretch;
        justify-content:flex-start;
        gap:10px;
        padding:12px;
        border-radius:16px;
        border:1px solid rgba(255,255,255,.12);
        background: rgba(15, 23, 42, 0.92);
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
      }
      .nav-links.open{ display:flex; }
      .nav-link{ width:100%; justify-content:flex-start; }
    }

    /* ===== Loading skeleton (é¿å…é–ƒçˆ) ===== */
    .is-loading .skeleton{
      position: relative;
      color: transparent !important;
      user-select: none;
    }
    .is-loading .skeleton::before{
      content:"";
      display:block;
      height: 1em;
      border-radius: 12px;
      background: rgba(255,255,255,.10);
    }
    .is-loading .skeleton.wide::before{ width: 90%; }
    .is-loading .skeleton.mid::before{ width: 65%; }
    .is-loading .skeleton.narrow::before{ width: 40%; }
    .is-loading .skeleton::after{
      content:"";
      position:absolute; inset:0;
      border-radius: 12px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
      transform: translateX(-100%);
      animation: sk 1.1s infinite;
    }
    @keyframes sk { 100% { transform: translateX(100%); } }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-container">
      <a class="brand" href="index.html">
        <img src="./picture/logo.png" alt="æ˜Ÿç«å»£å‘Š Logo">
        <span>æ˜Ÿç«å»£å‘Š</span>
      </a>

      <button class="menu-btn" id="menuBtn" type="button"
        aria-label="é–‹å•Ÿé¸å–®" aria-expanded="false" aria-controls="navLinks">
        <i class="fas fa-ellipsis-vertical"></i>
      </button>

      <div class="nav-links" id="navLinks">
        <a href="#top" class="nav-link"><i class="fas fa-home"></i> å…¬æœƒå¤§å»³</a>
        <a href="#quests" class="nav-link"><i class="fas fa-tasks"></i> ä»»å‹™å¤§å»³</a>
        <a href="#tools" class="nav-link"><i class="fas fa-tools"></i> å†’éšªå·¥å…·</a>
        <a href="index.html" class="nav-link"><i class="fas fa-house"></i> è¿”å›é¦–é </a>
        <a href="#" class="nav-link danger" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> ç™»å‡º</a>
      </div>
    </div>
  </nav>

  <!-- Header -->
  <section class="dashboard-header" id="top">
    <div class="container header-inner">
      <h1 class="welcome-title">ğŸ° æ­¡è¿å›ä¾†ï¼Œ<span id="userName">å†’éšªè€…</span>ï¼</h1>
      <p class="welcome-subtitle">æ˜Ÿç«å»£å‘Šæœƒå“¡ä¸­å¿ƒï½œä½ çš„æ¨å»£å†’éšªåŸºåœ°</p>

      <div class="level-badge" aria-label="æœƒå“¡ç‹€æ…‹">
        <span class="level-number">Lv. <span id="userLevel" class="skeleton narrow">0</span></span>
        <span id="userRole">å†’éšªè€…</span>
        <span class="badge-sep">|</span>
        <span><i class="fas fa-coins" style="color:#FFD700;"></i> <span id="totalEarned" class="skeleton mid">0</span> é‡‘å¹£</span>
      </div>

      <div class="profile-row">
        <div class="glass profile-card">
          <div class="profile-title">
            <h3>ğŸ‘¤ æœƒå“¡è³‡æ–™</h3>
            <!-- âœ… é›²ç«¯åŒæ­¥ç‹€æ…‹ Badge -->
            <span class="chip" id="syncBadge"><i class="fas fa-cloud"></i> åŒæ­¥ä¸­â€¦</span>
          </div>

          <div class="kv">
            <div class="k">ä½¿ç”¨è€…åç¨±</div><div class="v" id="kvUsername">-</div>
            <div class="k">å§“å</div><div class="v" id="kvName" class="skeleton mid">(æœªå¡«)</div>
            <div class="k">Email</div><div class="v" id="kvEmail" class="skeleton wide">(æœªå¡«)</div>
          </div>

          <div class="actions">
            <button class="btn secondary" id="copyRefBtn"><i class="fas fa-copy"></i> è¤‡è£½æ¨å»£é€£çµ</button>
            <button class="btn secondary" id="scrollQuestBtn"><i class="fas fa-flag"></i> çœ‹ä»»å‹™</button>
          </div>
        </div>

        <div class="glass profile-card">
          <div class="profile-title">
            <h3>âš¡ ç¶“é©—å€¼</h3>
            <span class="chip"><i class="fas fa-bolt"></i> æˆé•·ä¸­</span>
          </div>

          <div class="xp-container">
            <div class="xp-label">
              <span>ç¶“é©—å€¼</span>
              <span><span id="currentXP" class="skeleton mid">0</span> / <span id="nextLevelXP" class="skeleton mid">100</span> XP</span>
            </div>
            <div class="xp-bar"><div class="xp-fill" id="xpFill"></div></div>
          </div>

          <div style="margin-top:14px; opacity:.95; font-size:18px; line-height:1.6">
            âœ… æ–°è¨»å†Šç¬¬ä¸€æ¬¡ç™»å…¥ï¼šè‡ªå‹•å»ºç«‹å…¨ 0 åˆå§‹æ•¸æ“šï¼ˆLv.0ã€0 é‡‘å¹£ã€0/100 XPã€æ”¶ç›Š/ä»»å‹™/æ´»èºçš†ç‚º 0ï¼‰ã€‚
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Stats -->
  <section class="section">
    <div class="container">
      <h2 class="section-title">âš¡ å†’éšªè€…ç‹€æ…‹</h2>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">ğŸ’°</div>
          <div class="stat-value skeleton mid" id="todayEarnings">$ 0</div>
          <div class="stat-label">ä»Šæ—¥æ”¶ç›Š</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">ğŸ“ˆ</div>
          <div class="stat-value skeleton mid" id="monthEarnings">$ 0</div>
          <div class="stat-label">æœ¬æœˆç´¯è¨ˆ</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">âœ…</div>
          <div class="stat-value skeleton narrow" id="completedQuests">0</div>
          <div class="stat-label">å·²å®Œæˆä»»å‹™</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">â±ï¸</div>
          <div class="stat-value skeleton narrow" id="activeDays">0</div>
          <div class="stat-label">æ´»èºå¤©æ•¸</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Quests -->
  <section class="quest-hall" id="quests">
    <div class="container">
      <div class="glass quest-wrap">
        <h2 class="section-title" style="margin-bottom:10px;">ğŸ“‹ ä»»å‹™å¤§å»³</h2>
        <div style="text-align:center; opacity:.95; font-size:18px; margin-bottom:18px;">
          é»ã€Œæ¥å—ä»»å‹™ã€æœƒç«‹å³ä½”ç”¨åé¡ï¼›å¯åœ¨ä¸‹æ–¹ã€Œæˆ‘çš„ä»»å‹™ã€æ”¾æ£„æˆ–æäº¤å›å‚³ï¼ˆæˆªåœ– + é€£çµï¼‰ã€‚
        </div>

        <!-- âœ… é€™è£¡æ”¹æˆï¼šå¾ tasks-list å‹•æ…‹è¼‰å…¥ -->
        <div id="questList">
          <div class="quest-card">
            <span class="pill blue">è¼‰å…¥ä¸­</span>
            <div class="quest-row">
              <div>
                <h3 class="skeleton wide">ä»»å‹™è¼‰å…¥ä¸­â€¦</h3>
                <p class="quest-desc skeleton wide">è«‹ç¨å€™</p>
                <div class="quest-meta">
                  <span class="skeleton mid">-</span>
                </div>
              </div>
              <div class="quest-side">
                <div class="quest-reward skeleton narrow">$ -</div>
                <button class="btn" disabled>âš”ï¸ æ¥å—ä»»å‹™</button>
              </div>
            </div>
          </div>
        </div>

        <!-- âœ… æˆ‘çš„ä»»å‹™ï¼šæ”¹æˆçœŸå¯¦ claim ç‹€æ…‹ -->
        <div class="my-quests" id="myQuestsBox">
          <h4>ğŸ§¾ æˆ‘çš„ä»»å‹™ï¼ˆé€²è¡Œä¸­ï¼‰</h4>
          <div id="myQuestsList" style="opacity:.95; font-size:18px;">
            è®€å–ä¸­â€¦
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Tools -->
  <section class="section" id="tools">
    <div class="container">
      <h2 class="section-title">ğŸ› ï¸ å†’éšªå·¥å…·</h2>

      <div class="toolbox">
        <div class="glass tool-card">
          <h3><i class="fas fa-link"></i> æ¨å»£é€£çµ</h3>
          <p style="opacity:.92; margin-top:0; line-height:1.7;">
            ä½ çš„å°ˆå±¬æ¨å»£é€£çµï¼ˆå›ºå®šä¸è®Šï¼‰ï¼Œåˆ†äº«å³å¯è¿½è¹¤æˆæ•ˆã€‚
          </p>
          <div class="codebox" id="refLinkBox">-</div>
          <div style="margin-top:14px;">
            <button class="btn" id="copyRefBtn2"><i class="fas fa-copy"></i> è¤‡è£½é€£çµ</button>
          </div>
        </div>

        <div class="glass tool-card">
          <h3><i class="fas fa-wallet"></i> çé‡‘æé ˜ï¼ˆç¤ºç¯„ï¼‰</h3>
          <p style="opacity:.92; margin-top:0; line-height:1.7;">
            é€™ä¸€å¡Šä¸‹ä¸€æ­¥å¯æ¥çœŸå¯¦é‡‘é¡èˆ‡æé ˜ç”³è«‹ã€‚ç¾åœ¨å…ˆç¤ºç¯„ UIã€‚
          </p>
          <div class="codebox">å¯æé ˜é‡‘é¡ï¼š<b style="color:#FFD700;">$ 3,250</b><br>æœ€ä½æé ˜ï¼š$ 500</div>
          <div style="margin-top:14px;">
            <button class="btn" id="withdrawBtn"><i class="fas fa-money-check-alt"></i> ç”³è«‹æé ˜</button>
          </div>
        </div>

        <div class="glass tool-card">
          <h3><i class="fas fa-chart-line"></i> æ•¸æ“šå ±è¡¨ï¼ˆç¤ºç¯„ï¼‰</h3>
          <p style="opacity:.92; margin-top:0; line-height:1.7;">
            ä¸‹ä¸€æ­¥å¯æŠŠ dashboard sheet çš„ stats åšæˆçœŸå¯¦å ±è¡¨ã€‚
          </p>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn secondary" id="weeklyBtn"><i class="fas fa-calendar-alt"></i> æœ¬é€±å ±è¡¨</button>
            <button class="btn secondary" id="chartBtn"><i class="fas fa-chart-bar"></i> åˆ†æåœ–è¡¨</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="footer-grid">
        <div>
          <h3>å¿«é€Ÿé€£çµ</h3>
          <a href="index.html" class="footer-link">ç¶²ç«™é¦–é </a><br>
          <a href="#top" class="footer-link">å…¬æœƒå¤§å»³</a><br>
          <a href="#quests" class="footer-link">ä»»å‹™å¤§å»³</a>
        </div>
        <div>
          <h3>æ”¯æ´ä¸­å¿ƒ</h3>
          <div style="opacity:.92; font-size:18px; line-height:1.8;">
            <div><i class="fas fa-question-circle"></i> ä»»å‹™å•é¡Œè«®è©¢</div>
            <div><i class="fab fa-line"></i> å®˜æ–¹å®¢æœï¼š<b>@206zsrzq</b></div>
            <div style="margin-top:10px;">æœ¬æ—¥ç™»å…¥ï¼š<span id="loginCount">1,248</span> ä½å†’éšªè€…</div>
          </div>
        </div>
      </div>
      <div class="footer-bottom">
        Â© 2025 æ˜Ÿç«å»£å‘Š. ç‰ˆæ¬Šæ‰€æœ‰ã€‚
      </div>
    </div>
  </footer>

  <div class="toast" id="toast"></div>

  <script>
    // ===== helpers =====
    function toast(text, type){
      const el = document.getElementById('toast');
      el.className = 'toast ' + (type || '');
      el.textContent = text;
      el.style.display = 'block';
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => { el.style.display = 'none'; }, 2600);
    }

    function safeParse(json, fallback){
      try { return JSON.parse(json); } catch(e){ return fallback; }
    }

    function requireLogin(){
      const token = localStorage.getItem('xinghuo_token');
      const userRaw = localStorage.getItem('xinghuo_user');
      const user = safeParse(userRaw, null);

      if(!token || !user){
        location.href = './login.html';
        return null;
      }
      return { token, user };
    }

    function setText(id, text){
      const el = document.getElementById(id);
      if(el) el.textContent = text;
    }

    function setHTML(id, html){
      const el = document.getElementById(id);
      if(el) el.innerHTML = html;
    }

    // âœ… Skeleton æ§åˆ¶ï¼ˆé¿å…é–ƒçˆï¼‰
    function setLoading(on){
      document.body.classList.toggle('is-loading', !!on);
    }

    // âœ… é›²ç«¯åŒæ­¥ Badge
    function setSyncBadge(state){
      const el = document.getElementById('syncBadge');
      if(!el) return;
      if(state === 'ok'){
        el.innerHTML = '<i class="fas fa-circle-check"></i> å·²åŒæ­¥';
      }else if(state === 'error'){
        el.innerHTML = '<i class="fas fa-triangle-exclamation"></i> åŒæ­¥å¤±æ•—';
      }else{
        el.innerHTML = '<i class="fas fa-cloud"></i> åŒæ­¥ä¸­â€¦';
      }
    }

    // ===== referral link =====
    function buildRefLink(user){
      const uid = user?.user_id || user?.username || 'unknown';
      return `https://xinghuoad.xyz/?ref=${encodeURIComponent(uid)}`;
    }

    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        toast('âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'ok');
      }catch(e){
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        toast('âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'ok');
      }
    }

    // ===== Cloud API (dashboard sheet) =====
    async function cloudDashboard(action, token, data){
      const res = await fetch('/.netlify/functions/dashboard', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ action, ...(data ? { data } : {}) })
      });
      return await res.json();
    }

    // ===== Cloud API (users profile: name/email) =====
    async function cloudProfile(token){
      const res = await fetch('/.netlify/functions/user-profile', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({})
      });
      return await res.json();
    }

    function applyStats(stats){
      const s = stats || {};
      const level = Number(s.level) || 0;
      const xp = Number(s.xp) || 0;
      const nextLevelXP = Number(s.nextLevelXP) || 100;

      const totalEarned = Number(s.totalEarned) || 0;
      const todayEarnings = Number(s.todayEarnings) || 0;
      const monthEarnings = Number(s.monthEarnings) || 0;
      const completedQuests = Number(s.completedQuests) || 0;
      const activeDays = Number(s.activeDays) || 0;

      setText('userLevel', String(level));
      setText('totalEarned', totalEarned.toLocaleString());

      setText('currentXP', xp.toLocaleString());
      setText('nextLevelXP', nextLevelXP.toLocaleString());

      const xpPercent = Math.max(0, Math.min(100, (xp / Math.max(1, nextLevelXP)) * 100));
      const fill = document.getElementById('xpFill');
      if(fill) fill.style.width = xpPercent.toFixed(1) + '%';

      setText('todayEarnings', '$ ' + todayEarnings.toLocaleString());
      setText('monthEarnings', '$ ' + monthEarnings.toLocaleString());
      setText('completedQuests', String(completedQuests));
      setText('activeDays', String(activeDays));
    }

    // ===== withdraw demo =====
    function withdrawFunds(){
      const available = 3250;
      if(available < 500){
        toast(`æé ˜é‡‘é¡ä¸è¶³ï¼ˆç›®å‰ $${available}ï¼Œæœ€ä½ $500ï¼‰`, 'error');
        return;
      }
      const amountStr = prompt(`è«‹è¼¸å…¥æé ˜é‡‘é¡ï¼ˆæœ€ä½ $500ï¼Œæœ€é«˜ $${available}ï¼‰ï¼š`, String(available));
      if(!amountStr) return;

      const amount = Number(amountStr);
      if(!Number.isFinite(amount) || amount < 500 || amount > available){
        toast('âŒ é‡‘é¡è¼¸å…¥éŒ¯èª¤ï¼Œè«‹ç¢ºèªç¯„åœ', 'error');
        return;
      }
      toast(`âœ… å·²æäº¤æé ˜ç”³è«‹ï¼š$${amount}\nï¼ˆç¤ºç¯„æµç¨‹ï¼Œä¸‹ä¸€æ­¥å¯æ¥çœŸå¯¦ç”³è«‹ï¼‰`, 'ok');
    }

    // ===== logout (cloud save -> clear localStorage -> go index) =====
    async function logout(){
      const ok = confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ');
      if(!ok) return;

      const session = window.__session;
      if(session?.token){
        try{
          setSyncBadge('syncing');

          const payload = {
            my_quests: safeParse(localStorage.getItem('xinghuo_my_quests'), []),
            stats: {
              level: Number(document.getElementById('userLevel')?.textContent || 0),
              xp: Number(String(document.getElementById('currentXP')?.textContent || '0').replace(/,/g,'')),
              nextLevelXP: Number(String(document.getElementById('nextLevelXP')?.textContent || '100').replace(/,/g,'')),
              totalEarned: Number(String(document.getElementById('totalEarned')?.textContent || '0').replace(/,/g,'')),
              todayEarnings: Number(String(document.getElementById('todayEarnings')?.textContent || '0').replace(/[^\d]/g,'')) || 0,
              monthEarnings: Number(String(document.getElementById('monthEarnings')?.textContent || '0').replace(/[^\d]/g,'')) || 0,
              completedQuests: Number(String(document.getElementById('completedQuests')?.textContent || '0').replace(/,/g,'')) || 0,
              activeDays: Number(String(document.getElementById('activeDays')?.textContent || '0').replace(/,/g,'')) || 0,
            }
          };

          await cloudDashboard('save', session.token, payload);
          toast('â˜ï¸ å·²åŒæ­¥é›²ç«¯ï¼Œæº–å‚™ç™»å‡ºâ€¦', 'ok');
          setSyncBadge('ok');
        }catch(e){
          toast('âš ï¸ é›²ç«¯åŒæ­¥å¤±æ•—ï¼Œä½†ä»æœƒç™»å‡º\nï¼ˆä¸‹æ¬¡ç™»å…¥å¯èƒ½è®€åˆ°èˆŠè³‡æ–™ï¼‰', 'error');
          setSyncBadge('error');
        }
      }

      // âœ… ä¾ä½ æ—¢å®šè¦æ ¼ï¼šç™»å‡ºæ¸… 3 å€‹ key
      localStorage.removeItem('xinghuo_token');
      localStorage.removeItem('xinghuo_user');
      localStorage.removeItem('xinghuo_my_quests');

      setTimeout(() => { location.href = './index.html'; }, 450);
    }

    // âœ… Mobile dropdown menu behavior
    const menuBtn = document.getElementById('menuBtn');
    const navLinks = document.getElementById('navLinks');

    function closeMenu(){
      if(!menuBtn || !navLinks) return;
      navLinks.classList.remove('open');
      menuBtn.setAttribute('aria-expanded', 'false');
    }

    if(menuBtn && navLinks){
      menuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const open = navLinks.classList.toggle('open');
        menuBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
      });

      navLinks.addEventListener('click', (e) => e.stopPropagation());
      document.addEventListener('click', () => closeMenu());
      document.addEventListener('keydown', (e) => { if(e.key === 'Escape') closeMenu(); });
      navLinks.querySelectorAll('a').forEach(a => a.addEventListener('click', closeMenu));
      window.addEventListener('resize', () => { if(window.innerWidth > 900) closeMenu(); });
    }

    // ===== init =====
    document.addEventListener('DOMContentLoaded', async () => {
      const session = requireLogin();
      if(!session) return;
      window.__session = session;

      const { user, token } = session;

      // å…ˆç”¨ localStorage çš„ username ç«‹å³é¡¯ç¤º
      setText('userName', user?.username || 'å†’éšªè€…');
      setText('kvUsername', user?.username || '-');

      // å…ˆé€²å…¥ loading ç‹€æ…‹ï¼ˆéª¨æ¶ + badgeï¼‰
      setLoading(true);
      setSyncBadge('syncing');

      // Referral linkï¼ˆé€™å€‹ä¸éœ€è¦ç­‰é›²ç«¯ï¼‰
      const refLink = buildRefLink(user);
      setText('refLinkBox', refLink);

      // Buttons
      document.getElementById('logoutBtn')?.addEventListener('click', (e) => { e.preventDefault(); logout(); });
      document.getElementById('withdrawBtn')?.addEventListener('click', withdrawFunds);

      const copyFn = () => copyToClipboard(refLink);
      document.getElementById('copyRefBtn')?.addEventListener('click', copyFn);
      document.getElementById('copyRefBtn2')?.addEventListener('click', copyFn);

      document.getElementById('scrollQuestBtn')?.addEventListener('click', () => {
        document.getElementById('quests')?.scrollIntoView({ behavior:'smooth', block:'start' });
      });

      document.getElementById('weeklyBtn')?.addEventListener('click', () => toast('ğŸ“… æœ¬é€±å ±è¡¨ï¼ˆç¤ºç¯„ï¼‰\nä¸‹ä¸€æ­¥å¯æ¥çœŸå¯¦è³‡æ–™', 'ok'));
      document.getElementById('chartBtn')?.addEventListener('click', () => toast('ğŸ“Š åˆ†æåœ–è¡¨ï¼ˆç¤ºç¯„ï¼‰\nä¸‹ä¸€æ­¥å¯åŠ å…¥åœ–è¡¨/å ±è¡¨é ', 'ok'));

      // âœ… åŒæ­¥è®€å–ï¼šdashboard è³‡æ–™ + users profile(name/email)
      let okDashboard = false;
      let okProfile = false;

      try{
        const [rDash, rProfile] = await Promise.allSettled([
          cloudDashboard('get', token),
          cloudProfile(token),
        ]);

        // dashboard data
        if(rDash.status === 'fulfilled' && rDash.value?.ok){
          okDashboard = true;
          const data = rDash.value.data || {};
          applyStats(data.stats || {});
          const myQuests = Array.isArray(data.my_quests) ? data.my_quests : [];
          localStorage.setItem('xinghuo_my_quests', JSON.stringify(myQuests));
        }else{
          applyStats({ level:0,xp:0,nextLevelXP:100,totalEarned:0,todayEarnings:0,monthEarnings:0,completedQuests:0,activeDays:0 });
        }

        // profile(name/email) from users sheet
        if(rProfile.status === 'fulfilled' && rProfile.value?.ok){
          okProfile = true;
          const u2 = rProfile.value.user || {};
          setText('kvName', u2.name ? u2.name : '(æœªå¡«)');
          setText('kvEmail', u2.email ? u2.email : '(æœªå¡«)');

          // æ›´æ–° localStorage çš„ userï¼ˆè®“å…¶ä»–é é¢ä¹Ÿèƒ½ç”¨åˆ°ï¼‰
          const merged = { ...user, ...u2 };
          localStorage.setItem('xinghuo_user', JSON.stringify(merged));
        }else{
          setText('kvName', user?.name ? user.name : '(æœªå¡«)');
          setText('kvEmail', user?.email ? user.email : '(æœªå¡«)');
        }

      }catch(e){
        applyStats({ level:0,xp:0,nextLevelXP:100,totalEarned:0,todayEarnings:0,monthEarnings:0,completedQuests:0,activeDays:0 });
        setText('kvName', user?.name ? user.name : '(æœªå¡«)');
        setText('kvEmail', user?.email ? user.email : '(æœªå¡«)');
      }finally{
        setLoading(false);
        setSyncBadge((okDashboard && okProfile) ? 'ok' : 'error');
      }

      // âœ… ä»»å‹™ç³»çµ±ï¼šè¼‰å…¥ä»»å‹™å¤§å»³ + æˆ‘çš„ä»»å‹™
      try{
        await window.TaskUI.init(token);
      }catch(e){
        toast('âš ï¸ ä»»å‹™è¼‰å…¥å¤±æ•—ï¼š' + (e?.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
      }

      // Simulated login count
      setInterval(() => {
        const el = document.getElementById('loginCount');
        if(!el) return;
        const current = parseInt(String(el.textContent).replace(/,/g,''), 10) || 1248;
        const change = Math.floor(Math.random() * 10) - 3;
        const next = Math.max(1200, current + change);
        el.textContent = next.toLocaleString();
      }, 30000);
    });
  </script>

  <!-- âœ… ä»»å‹™ç³»çµ±æ¨¡çµ„ï¼ˆä¿ç•™åŸé¢¨æ ¼ã€åªæ›¿æ›ä»»å‹™å€å…§å®¹ï¼‰ -->
  <script type="module">
    import { uploadImage } from "./assets/js/uploader.js";

    window.TaskUI = (() => {
      function getToken(){ return localStorage.getItem('xinghuo_token') || ""; }

      async function apiGet(path, token){
        const r = await fetch(path, { headers: { Authorization: "Bearer " + token } });
        const j = await r.json().catch(()=>({}));
        if(!r.ok || !j.ok) throw new Error(j.error || "Request failed");
        return j;
      }
      async function apiPost(path, token, body){
        const r = await fetch(path, {
          method: "POST",
          headers: { "Content-Type":"application/json", Authorization: "Bearer " + token },
          body: JSON.stringify(body || {})
        });
        const j = await r.json().catch(()=>({}));
        if(!r.ok || !j.ok) throw new Error(j.error || "Request failed");
        return j;
      }

      async function loadPublicConfig(){
        const r = await fetch("/.netlify/functions/public-config");
        const j = await r.json().catch(()=>({}));
        if(!r.ok || !j.ok) throw new Error(j.error || "public-config failed");
        window.SUPABASE_URL = j.supabaseUrl;
        window.SUPABASE_ANON_KEY = j.supabaseAnonKey;
      }

      function publicUrl(bucketPath){
        const s = String(bucketPath||"").trim();
        if(!s) return "";
        const parts = s.split("/");
        const bucket = parts.shift();
        const path = parts.join("/");
        return `${window.SUPABASE_URL}/storage/v1/object/public/${bucket}/${path}`;
      }

      function pillByRemain(remaining){
        if(remaining === -1) return { cls:"green", text:"ç„¡ä¸Šé™" };
        if(Number(remaining) <= 0) return { cls:"red", text:"å·²é¡æ»¿" };
        if(Number(remaining) <= 5) return { cls:"orange", text:"åé¡ç·Šå¼µ" };
        return { cls:"green", text:"å¯æ¥å–" };
      }

      function fmtRemainText(t){
        if(t.remaining === -1) return "ç„¡ä¸Šé™";
        return String(t.remaining);
      }

      function escapeHtml(s){
        return String(s||"")
          .replace(/&/g,"&amp;")
          .replace(/</g,"&lt;")
          .replace(/>/g,"&gt;")
          .replace(/"/g,"&quot;")
          .replace(/'/g,"&#039;");
      }

      function claimStatusLabel(st){
        if(st === "ACTIVE") return "â³ é€²è¡Œä¸­";
        if(st === "SUBMITTED") return "ğŸ•’ å¾…å¯©æ ¸";
        if(st === "APPROVED") return "âœ… å·²é€šé";
        if(st === "REJECTED") return "âŒ å·²é€€å›";
        if(st === "ABANDONED") return "ğŸš« å·²æ”¾æ£„";
        return st || "-";
      }

      async function renderQuestHall(token){
        const box = document.getElementById("questList");
        if(!box) return;

        // skeleton
        box.innerHTML = `
          <div class="quest-card">
            <span class="pill blue">è¼‰å…¥ä¸­</span>
            <div class="quest-row">
              <div>
                <h3 class="skeleton wide">ä»»å‹™è¼‰å…¥ä¸­â€¦</h3>
                <p class="quest-desc skeleton wide">è«‹ç¨å€™</p>
              </div>
              <div class="quest-side">
                <div class="quest-reward skeleton narrow">$ -</div>
                <button class="btn" disabled>âš”ï¸ æ¥å—ä»»å‹™</button>
              </div>
            </div>
          </div>
        `;

        const j = await apiGet("/.netlify/functions/tasks-list", token);
        const tasks = Array.isArray(j.tasks) ? j.tasks : [];

        if(!tasks.length){
          box.innerHTML = `
            <div class="quest-card">
              <span class="pill orange">ç›®å‰æ²’æœ‰ä»»å‹™</span>
              <div class="quest-row">
                <div>
                  <h3>æš«æ™‚æ²’æœ‰å¯æ¥å–ä»»å‹™</h3>
                  <p class="quest-desc">è«‹ç¨å¾Œå†å›ä¾†çœ‹çœ‹ã€‚</p>
                </div>
              </div>
            </div>
          `;
          return;
        }

        box.innerHTML = tasks.map(t => {
          const p = pillByRemain(t.remaining);
          const photos = (t.photo_paths||[]).slice(0,3).map(pp => `<img src="${publicUrl(pp)}" alt="ä»»å‹™åœ–ç‰‡">`).join("");
          const title = t.title ? escapeHtml(t.title) : "ğŸš— è»Šè¼›æ¨å»£ä»»å‹™";
          const remain = fmtRemainText(t);

          return `
            <div class="quest-card" data-task="${escapeHtml(t.task_id)}">
              <span class="pill ${p.cls}"><i class="fas fa-flag"></i> ${p.text}</span>
              <div class="quest-row">
                <div>
                  <h3>${title}</h3>
                  <p class="quest-desc" style="white-space:pre-wrap;">${escapeHtml(t.vehicle_text || "")}</p>
                  <div class="quest-meta">
                    <span><i class="far fa-clock"></i> å¤©æ•¸ï¼š${Number(t.duration_days)||0} å¤©</span>
                    <span><i class="fas fa-users"></i> å‰©é¤˜åé¡ï¼š${remain}</span>
                  </div>
                  ${photos ? `<div class="quest-photos">${photos}</div>` : ``}
                </div>
                <div class="quest-side">
                  <div class="quest-reward">$ ${Number(t.budget_plan||0).toLocaleString()}</div>
                  <button class="btn" data-accept="${escapeHtml(t.task_id)}" ${t.remaining===0 ? "disabled" : ""}>âš”ï¸ æ¥å—ä»»å‹™</button>
                </div>
              </div>
            </div>
          `;
        }).join("");

        // bind accept
        box.querySelectorAll("[data-accept]").forEach(btn => {
          btn.addEventListener("click", async () => {
            const task_id = btn.getAttribute("data-accept");
            const ok = confirm("ç¢ºå®šè¦æ¥å—æ­¤ä»»å‹™å—ï¼Ÿ\n\næ¥å—å¾Œæœƒä½”ç”¨åé¡ï¼Œä¸¦é¡¯ç¤ºåœ¨ã€Œæˆ‘çš„ä»»å‹™ã€ã€‚");
            if(!ok) return;

            btn.disabled = true;
            try{
              await apiPost("/.netlify/functions/tasks-claim", token, { task_id });
              toast("âœ… ä»»å‹™å·²æ¥å—ï¼Œå·²åŠ å…¥ã€Œæˆ‘çš„ä»»å‹™ã€", "ok");
              await renderMyTasks(token);
              // é‡æ–°è¼‰å…¥ä»»å‹™å¤§å»³ï¼ˆæ›´æ–°å‰©é¤˜åé¡ï¼‰
              await renderQuestHall(token);
              document.getElementById('myQuestsBox')?.scrollIntoView({ behavior:'smooth', block:'start' });
            }catch(e){
              toast("âŒ æ¥å—å¤±æ•—ï¼š" + (e?.message || "æœªçŸ¥éŒ¯èª¤"), "error");
              btn.disabled = false;
            }
          });
        });
      }

      async function renderMyTasks(token){
        const box = document.getElementById("myQuestsList");
        if(!box) return;

        box.innerHTML = "è®€å–ä¸­â€¦";

        const j = await apiGet("/.netlify/functions/tasks-my", token);
        const items = Array.isArray(j.items) ? j.items : [];

        if(!items.length){
          box.innerHTML = "ç›®å‰æ²’æœ‰ä»»å‹™ã€‚å»ä¸Šé¢æ¥å—ä¸€å€‹ä»»å‹™å§ï¼";
          return;
        }

        box.innerHTML = items.map(it => {
          const c = it.claim || {};
          const t = it.task || {};
          const s = it.submission || null;

          const st = String(c.status || "");
          const title = t.title ? escapeHtml(t.title) : "ğŸš— è»Šè¼›æ¨å»£ä»»å‹™";
          const desc = escapeHtml((t.vehicle_text||"")).slice(0, 140);
          const statusText = claimStatusLabel(st);

          const showAbandon = st === "ACTIVE";
          const showSubmit = st === "ACTIVE";
          const showSubmitted = st === "SUBMITTED";
          const showApproved = st === "APPROVED";
          const showRejected = st === "REJECTED";

          const shareLink = s?.share_link ? escapeHtml(s.share_link) : "";
          const shareImg = s?.share_screenshot_path ? publicUrl(s.share_screenshot_path) : "";

          return `
            <div class="my-quest-item" data-claim="${escapeHtml(c.claim_id)}">
              <div style="min-width: 260px;">
                <div class="name">${title}</div>
                <div class="mini">
                  ç‹€æ…‹ï¼š<b>${statusText}</b><br>
                  ä»»å‹™ï¼š${desc}${(t.vehicle_text && t.vehicle_text.length > 140) ? "..." : ""}<br>
                  claim_idï¼š<span style="opacity:.9">${escapeHtml(c.claim_id || "")}</span>
                </div>
                ${shareLink ? `<div class="mini" style="margin-top:8px;">è½‰ç™¼é€£çµï¼š<a href="${shareLink}" target="_blank" style="color:#9bd3ff">${shareLink}</a></div>` : ``}
                ${shareImg ? `<div class="mini" style="margin-top:8px;">å›å‚³æˆªåœ–ï¼š<br><img src="${shareImg}" style="max-width:340px; border-radius:14px; border:1px solid rgba(255,255,255,.12); margin-top:8px;"></div>` : ``}
              </div>

              <div class="my-quest-actions">
                ${showAbandon ? `<button class="btnMini danger" data-abandon="${escapeHtml(c.claim_id)}"><i class="fas fa-ban"></i> æ”¾æ£„</button>` : ``}
                ${showSubmit ? `<button class="btnMini primary" data-open-submit="${escapeHtml(c.claim_id)}"><i class="fas fa-upload"></i> æäº¤å›å‚³</button>` : ``}
                ${showSubmitted ? `<span class="chip"><i class="fas fa-hourglass-half"></i> ç­‰å¾…å¯©æ ¸</span>` : ``}
                ${showApproved ? `<span class="chip"><i class="fas fa-circle-check"></i> å·²é€šé</span>` : ``}
                ${showRejected ? `<span class="chip"><i class="fas fa-triangle-exclamation"></i> å·²é€€å›</span>` : ``}
              </div>

              <div class="submit-panel" id="panel_${escapeHtml(c.claim_id)}" style="display:none; width:100%;">
                <div style="font-weight:900; font-size:18px;">ğŸ“® æäº¤å›å‚³</div>
                <div class="hint">1) å¡«è½‰ç™¼é€£çµ 2) ä¸Šå‚³ã€Œè½‰ç™¼æˆªåœ–ã€(å¿…å¡«) 3) ä¸Šå‚³ã€Œç€è¦½é‡æˆªåœ–ã€(é¸å¡«ï¼Œåƒ…ç®¡ç†å“¡å¯çœ‹)</div>

                <input type="text" id="link_${escapeHtml(c.claim_id)}" placeholder="è½‰ç™¼é€£çµï¼ˆå¿…å¡«ï¼‰" value="${shareLink ? shareLink : ""}">
                <input type="file" id="share_${escapeHtml(c.claim_id)}" accept="image/*">
                <input type="file" id="ins_${escapeHtml(c.claim_id)}" accept="image/*">

                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
                  <button class="btnMini primary" data-submit="${escapeHtml(c.claim_id)}"><i class="fas fa-paper-plane"></i> é€å‡º</button>
                  <button class="btnMini" data-close-submit="${escapeHtml(c.claim_id)}">æ”¶èµ·</button>
                </div>
              </div>
            </div>
          `;
        }).join("");

        // bind abandon
        box.querySelectorAll("[data-abandon]").forEach(btn => {
          btn.addEventListener("click", async () => {
            const claim_id = btn.getAttribute("data-abandon");
            const ok = confirm("ç¢ºå®šè¦æ”¾æ£„æ­¤ä»»å‹™å—ï¼Ÿ\n\næ”¾æ£„å¾Œåé¡æœƒé‡‹æ”¾ï¼Œä¸”æ­¤ä»»å‹™æœƒæ¨™è¨˜ç‚ºå·²æ”¾æ£„ã€‚");
            if(!ok) return;

            btn.disabled = true;
            try{
              await apiPost("/.netlify/functions/tasks-abandon", token, { claim_id });
              toast("å·²æ”¾æ£„ä»»å‹™", "ok");
              await renderMyTasks(token);
              await renderQuestHall(token);
            }catch(e){
              toast("âŒ æ”¾æ£„å¤±æ•—ï¼š" + (e?.message || "æœªçŸ¥éŒ¯èª¤"), "error");
              btn.disabled = false;
            }
          });
        });

        // open/close submit panel
        box.querySelectorAll("[data-open-submit]").forEach(btn => {
          btn.addEventListener("click", () => {
            const claim_id = btn.getAttribute("data-open-submit");
            const panel = document.getElementById("panel_" + claim_id);
            if(panel) panel.style.display = "block";
          });
        });
        box.querySelectorAll("[data-close-submit]").forEach(btn => {
          btn.addEventListener("click", () => {
            const claim_id = btn.getAttribute("data-close-submit");
            const panel = document.getElementById("panel_" + claim_id);
            if(panel) panel.style.display = "none";
          });
        });

        // bind submit
        box.querySelectorAll("[data-submit]").forEach(btn => {
          btn.addEventListener("click", async () => {
            const claim_id = btn.getAttribute("data-submit");
            const linkEl = document.getElementById("link_" + claim_id);
            const shareEl = document.getElementById("share_" + claim_id);
            const insEl = document.getElementById("ins_" + claim_id);

            const share_link = String(linkEl?.value || "").trim();
            const shareFile = shareEl?.files?.[0] || null;
            const insFile = insEl?.files?.[0] || null;

            if(!share_link){
              toast("è«‹å¡«å¯«è½‰ç™¼é€£çµ", "error");
              return;
            }
            if(!shareFile){
              toast("è«‹ä¸Šå‚³è½‰ç™¼æˆªåœ–ï¼ˆå¿…å¡«ï¼‰", "error");
              return;
            }

            btn.disabled = true;
            try{
              toast("ä¸Šå‚³ä¸­â€¦", "ok");

              // public-assetsï¼šè½‰ç™¼æˆªåœ–
              const share_screenshot_path = await uploadImage({
                bucket: "public-assets",
                prefix: "proof",
                id: claim_id,
                file: shareFile
              });

              // admin-onlyï¼šç€è¦½é‡æˆªåœ–ï¼ˆå¯ç©ºï¼‰
              let insights_screenshot_path = "";
              if(insFile){
                insights_screenshot_path = await uploadImage({
                  bucket: "admin-only",
                  prefix: "proof",
                  id: claim_id,
                  file: insFile
                });
              }

              await apiPost("/.netlify/functions/tasks-submit", token, {
                claim_id,
                share_link,
                share_screenshot_path,
                insights_screenshot_path
              });

              toast("âœ… å·²æäº¤ï¼Œç­‰å¾…å¯©æ ¸", "ok");
              await renderMyTasks(token);
            }catch(e){
              toast("âŒ æäº¤å¤±æ•—ï¼š" + (e?.message || "æœªçŸ¥éŒ¯èª¤"), "error");
              btn.disabled = false;
            }
          });
        });
      }

      async function init(token){
        await loadPublicConfig(); // å¿…é ˆï¼šæä¾› uploader.js éœ€è¦çš„ window.SUPABASE_*
        await renderQuestHall(token);
        await renderMyTasks(token);
      }

      return { init };
    })();
  </script>
</body>
</html>
