<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>星火廣告｜會員註冊</title>

  <!-- Zen Maru Gothic -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --card:rgba(255,255,255,.06);
      --text:rgba(255,255,255,.94);
      --muted:rgba(255,255,255,.72);
      --muted2:rgba(255,255,255,.58);
      --brand:#4db8ff;
      --brand2:#9d4edd;
      --good:#15e38a;
      --bad:#ff4d6d;

      --radius:22px;
      --radius2:16px;

      --shadow: 0 24px 90px rgba(0,0,0,.55);
    }

    /* ✅ 你指定：字體 125% */
    html{ font-size:125%; }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      font-family:"Zen Maru Gothic", system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px;
      position:relative;
      overflow-x:hidden;

      /* ✅ 背景底圖 */
      background: url("picture/P1.png") center / cover no-repeat fixed;
    }

    /* ✅ 霧面：同底圖 + blur 疊上去 */
    body::before{
      content:"";
      position:fixed;
      inset:-24px;
      background: url("picture/P1.png") center / cover no-repeat;
      filter: blur(14px);
      transform: scale(1.06);
      opacity: .78;
      z-index:-2;
      pointer-events:none;
    }

    /* ✅ 暗化提升可讀性 */
    body::after{
      content:"";
      position:fixed;
      inset:0;
      background: rgba(7,10,18,.56);
      z-index:-1;
      pointer-events:none;
    }

    .wrap{ width:min(860px, 100%); }

    .card{
      position:relative;
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* 霓虹細邊光 */
    .card::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius:var(--radius);
      pointer-events:none;
      background: linear-gradient(135deg, rgba(77,184,255,.22), rgba(157,78,221,.18));
      mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      padding:1px;
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity:.55;
    }

    .header{
      padding:26px 26px 18px;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }

    /* ✅ Logo：contain + 內距，不裁切 */
    .logo{
      width:46px;
      height:46px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:8px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .logo img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      filter: drop-shadow(0 6px 16px rgba(0,0,0,.35));
    }

    .titles{ min-width:0; }
    .h1{
      margin:0;
      font-weight:900;
      letter-spacing:.5px;
      font-size:1.22rem;
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sub{
      margin:.18rem 0 0;
      color:var(--muted);
      font-weight:800;
      font-size:.92rem;
    }

    .body{ padding:22px 26px 26px; }

    /* ✅ Step：兩塊同寬 + 只顯示標題 */
    .steps{
      display:flex;
      align-items:stretch;
      gap:10px;
      margin:0 0 16px;
    }
    .step{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      position:relative;
      overflow:hidden;
    }
    .step.active{
      border-color: rgba(77,184,255,.30);
      box-shadow: 0 0 0 1px rgba(77,184,255,.10), 0 18px 50px rgba(77,184,255,.10);
    }
    .step.done{
      border-color: rgba(21,227,138,.30);
      box-shadow: 0 0 0 1px rgba(21,227,138,.10), 0 18px 50px rgba(21,227,138,.08);
    }
    .step::before{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(135deg, rgba(77,184,255,.10), rgba(157,78,221,.08));
      opacity:0;
      transition: opacity .25s ease;
      pointer-events:none;
    }
    .step.active::before{ opacity:.75; }

    .badge{
      width:28px;height:28px;border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:rgba(255,255,255,.88);
      flex:0 0 auto;
      font-size:.92rem;
    }
    .step.done .badge{
      border-color: rgba(21,227,138,.35);
      background: rgba(21,227,138,.10);
      color:#eafff3;
    }
    .stepTitle{
      font-weight:900;
      font-size:.96rem;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    @media (max-width: 720px){
      .steps{ flex-direction:column; }
    }

    /* 狀態列 */
    .status{
      display:none;
      margin: 14px 0 0;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      font-weight:900;
      line-height:1.6;
      gap:10px;
      align-items:flex-start;
    }
    .status.show{ display:flex; }
    .status.ok{
      border-color: rgba(21,227,138,.28);
      background: rgba(21,227,138,.08);
      color:#eafff3;
    }
    .status.bad{
      border-color: rgba(255,77,109,.30);
      background: rgba(255,77,109,.08);
      color:#ffeef2;
    }
    .status .ico{
      width:22px;height:22px;border-radius:8px;
      display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      flex:0 0 auto;
      margin-top:2px;
    }

    /* 區塊容器 */
    .section{
      margin-top:16px;
      padding:16px;
      border-radius:var(--radius2);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
    }

    .grid{ display:grid; gap:12px; }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 560px){
      .row2{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      font-weight:900;
      margin:0 0 8px;
      color:rgba(255,255,255,.92);
      font-size:.92rem;
    }

    .field{
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius:14px;
      padding:10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      transition: border-color .18s ease, box-shadow .18s ease, transform .18s ease;
      min-height:52px;
    }
    .field:focus-within{
      border-color: rgba(77,184,255,.38);
      box-shadow: 0 0 0 1px rgba(77,184,255,.14), 0 18px 55px rgba(77,184,255,.10);
      transform: translateY(-1px);
    }

    input{
      width:100%;
      border:0;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:1rem;
      font-weight:800;
      letter-spacing:.2px;
    }
    input::placeholder{
      color: rgba(255,255,255,.48);
      font-weight:700;
    }

    .btn{
      border:0;
      cursor:pointer;
      border-radius:14px;
      padding:12px 16px;
      font-weight:900;
      font-size:.95rem;
      color:#fff;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 14px 38px rgba(77,184,255,.16);
      transition: transform .15s ease, filter .15s ease, box-shadow .15s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
      min-height:52px;
      width:100%;
    }
    .btn:hover{ transform: translateY(-2px); filter: brightness(1.06); box-shadow: 0 18px 46px rgba(77,184,255,.18); }
    .btn:active{ transform: translateY(0); }

    .btnGhost{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: none;
      width:auto;
    }

    /* ✅ Email 同行按鈕：稍微放大 */
    .btnInline{
      padding:12px 18px;
      border-radius:12px;
      font-size:.96rem;
      min-height:46px;
      white-space:nowrap;
    }

    .btn:disabled,
    .btnGhost:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none !important;
      filter:none !important;
    }

    .spinner{
      width:16px; height:16px;
      border:2px solid rgba(255,255,255,.35);
      border-top-color:#fff;
      border-radius:50%;
      animation: spin .8s linear infinite;
      display:none;
    }
    .btn.loading .spinner,
    .btnGhost.loading .spinner{ display:inline-block; }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .eye{
      cursor:pointer;
      font-weight:900;
      color: rgba(255,255,255,.86);
      user-select:none;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
    }

    /* ✅ OTP：單一 input（隱藏字），用 6 格顯示層精準置中 */
    .otpField{
      position:relative;
      width:100%;
    }

    /* 真正輸入用 input（可貼上/可退格/可輸入） */
    .otpInput{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      border:0;
      outline:0;
      background:transparent;
      color:transparent;     /* 不顯示原文字（避免 1 0 1 0 1 0 問題） */
      caret-color:transparent;
      font-size:1rem;
      font-weight:800;
      letter-spacing:0;
    }

    /* 顯示層：6 格 */
    .otpBoxes{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:10px;
      width:100%;
      align-items:center;
    }

    .otpBox{
      height:40px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.22); /* ✅ 更清楚 */
      background: rgba(255,255,255,.045);     /* ✅ 更實一點 */
      box-shadow: inset 0 -10px 22px rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:1.02rem;
      color:rgba(255,255,255,.92);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      transition: border-color .18s ease, box-shadow .18s ease, background .18s ease, transform .18s ease;
      user-select:none;
    }

    /* active 格（下一個要輸入的位置） */
    .otpBox.active{
      border-color: rgba(77,184,255,.55);
      box-shadow:
        0 0 0 1px rgba(77,184,255,.18),
        0 18px 55px rgba(77,184,255,.10),
        inset 0 -10px 22px rgba(0,0,0,.18);
      background: rgba(77,184,255,.06);
      transform: translateY(-1px);
    }

    /* 已填格：稍微更亮 */
    .otpBox.filled{
      border-color: rgba(255,255,255,.30);
      background: rgba(255,255,255,.06);
    }

    /* OTP 行：驗證碼 : 驗證 = 2 : 1 */
    .otpRow{
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap:12px;
      align-items:stretch;
    }

    /* 讓 OTP 的格子高度跟 field 視覺一致 */
    .otpFieldWrap{
      min-height:52px;
      padding:6px 6px; /* 讓格子有呼吸空間 */
    }
    .otpFieldWrap .otpBox{ height:40px; }

    @media (max-width: 460px){
      /* 非常小的螢幕保護一下（仍保持 2:1，但 gap 縮小） */
      .otpRow{ gap:10px; }
      .otpBoxes{ gap:8px; }
      .otpBox{ border-radius:10px; height:38px; font-size:.98rem; }
      .btn{ font-size:.92rem; }
    }

    .metaRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-top:8px;
      color:var(--muted2);
      font-weight:800;
      font-size:.85rem;
    }

    .verifiedTag{
      display:none;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(21,227,138,.30);
      background: rgba(21,227,138,.10);
      color:#eafff3;
      font-weight:900;
      font-size:.86rem;
      white-space:nowrap;
    }
    .verifiedTag.show{ display:flex; }

    .actions{
      display:grid;
      gap:10px;
      margin-top:14px;
    }

    .fine{
      margin-top:14px;
      color: rgba(255,255,255,.62);
      font-weight:800;
      font-size:.86rem;
      line-height:1.6;
    }

    a{ color:#fff; text-decoration:none; font-weight:900; }
    a:hover{ text-decoration:underline; }

    .fadeSlide{ animation: fadeSlide .22s ease both; }
    @keyframes fadeSlide{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform: translateY(0); }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="brand">
          <div class="logo" aria-hidden="true">
            <img src="picture/logo.png" alt="星火廣告 Logo">
          </div>
          <div class="titles">
            <p class="h1">星火廣告</p>
            <p class="sub">會員註冊</p>
          </div>
        </div>
      </div>

      <div class="body">
        <!-- Steps -->
        <div class="steps">
          <div class="step active" id="step1Box">
            <div class="badge" id="step1Badge">1</div>
            <div class="stepTitle">email驗證</div>
          </div>
          <div class="step" id="step2Box">
            <div class="badge" id="step2Badge">2</div>
            <div class="stepTitle">建立帳號</div>
          </div>
        </div>

        <!-- Status -->
        <div class="status" id="status">
          <div class="ico" id="statusIco">i</div>
          <div id="statusText"></div>
        </div>

        <!-- Step 1 -->
        <div class="section fadeSlide" id="step1">
          <div style="display:flex; align-items:center; justify-content:flex-end; margin-bottom:10px;">
            <div class="verifiedTag" id="verifiedTag">已驗證</div>
          </div>

          <div class="grid">
            <!-- Email + Send (同一行) -->
            <div>
              <label for="email">Email</label>
              <div class="field">
                <input id="email" type="email" placeholder="例如：name@gmail.com" autocomplete="email" required>
                <button type="button" class="btnGhost btnInline" id="sendCodeBtn">
                  <span class="spinner" aria-hidden="true"></span>
                  <span id="sendCodeText">發送驗證碼</span>
                </button>
              </div>
              <div class="metaRow">
                <div id="cooldownHint" style="display:none;">可再次發送：<span id="cooldown">60</span>s</div>
                <div>驗證碼有效 10 分鐘</div>
              </div>
            </div>

            <!-- ✅ OTP：驗證碼(2) + 驗證(1) -->
            <div>
              <label for="otpInput">驗證碼</label>

              <div class="otpRow">
                <!-- 左：驗證碼 -->
                <div class="field otpFieldWrap" id="otpWrap" role="group" aria-label="驗證碼輸入">
                  <div class="otpField">
                    <!-- 真正輸入用的 input（隱藏文字） -->
                    <input
                      id="otpInput"
                      class="otpInput"
                      inputmode="numeric"
                      autocomplete="one-time-code"
                      maxlength="6"
                      aria-label="請輸入 6 位數驗證碼"
                    />

                    <!-- 顯示層：6 格 -->
                    <div class="otpBoxes" aria-hidden="true" id="otpBoxes">
                      <div class="otpBox" data-i="0"></div>
                      <div class="otpBox" data-i="1"></div>
                      <div class="otpBox" data-i="2"></div>
                      <div class="otpBox" data-i="3"></div>
                      <div class="otpBox" data-i="4"></div>
                      <div class="otpBox" data-i="5"></div>
                    </div>
                  </div>
                </div>

                <!-- 右：驗證 -->
                <button type="button" class="btn" id="verifyBtn" disabled>
                  <span class="spinner" aria-hidden="true"></span>
                  驗證
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 2 -->
        <div class="section" id="step2" style="display:none;">
          <form id="signupForm" class="grid" autocomplete="on">
            <div>
              <label for="name">姓名</label>
              <div class="field">
                <input id="name" name="name" placeholder="例如：王小明" autocomplete="name" required>
              </div>
            </div>

            <div class="row2">
              <div>
                <label for="username">帳號（username）</label>
                <div class="field">
                  <input id="username" name="username" minlength="3" placeholder="至少 3 個字" autocomplete="username" required>
                </div>
              </div>

              <div>
                <label for="password">密碼</label>
                <div class="field">
                  <input id="password" name="password" type="password" minlength="6"
                         placeholder="至少 6 個字" autocomplete="new-password" required>
                  <span class="eye" id="togglePw">顯示</span>
                </div>
              </div>
            </div>

            <div class="actions">
              <button type="submit" class="btn" id="signupBtn">
                <span class="spinner" aria-hidden="true"></span>
                完成註冊
              </button>
              <button type="button" class="btn btnGhost" onclick="location.href='login.html'">
                前往登入
              </button>
            </div>

            <div class="fine">
              註冊即代表你同意平台規則與使用條款（內容以站內公告為準）。
            </div>
          </form>
        </div>

      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const statusEl = $("status");
    const statusText = $("statusText");
    const statusIco = $("statusIco");

    const step1Box = $("step1Box");
    const step2Box = $("step2Box");
    const step1Badge = $("step1Badge");
    const step2Badge = $("step2Badge");

    const step1 = $("step1");
    const step2 = $("step2");

    const emailEl = $("email");

    const sendCodeBtn = $("sendCodeBtn");
    const sendCodeText = $("sendCodeText");
    const cooldownHint = $("cooldownHint");
    const cooldownEl = $("cooldown");

    const verifyBtn = $("verifyBtn");
    const verifiedTag = $("verifiedTag");

    const otpInput = $("otpInput");
    const otpBoxesWrap = $("otpBoxes");
    const otpWrap = $("otpWrap");
    const otpBoxes = Array.from(otpBoxesWrap.querySelectorAll(".otpBox"));

    const togglePw = $("togglePw");
    const pw = $("password");

    let isVerified = false;

    function showStatus(type, text){
      statusEl.className = "status show " + type;
      statusIco.textContent = type === "ok" ? "✓" : "!";
      statusText.textContent = text;
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
    function clearStatus(){
      statusEl.className = "status";
      statusText.textContent = "";
      statusIco.textContent = "i";
    }

    function setLoading(btn, loading){
      if(loading) btn.classList.add("loading");
      else btn.classList.remove("loading");
      btn.disabled = !!loading;
    }

    function isValidEmail(email){
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email||"").trim());
    }

    function toStep(n){
      if(n === 1){
        step1Box.classList.add("active");
        step2Box.classList.remove("active");
        step1.style.display = "block";
        step2.style.display = "none";
        step1.classList.add("fadeSlide");
        setTimeout(()=>step1.classList.remove("fadeSlide"), 250);
      }else{
        step1Box.classList.remove("active");
        step2Box.classList.add("active");
        step1.style.display = "none";
        step2.style.display = "block";
        step2.classList.add("fadeSlide");
        setTimeout(()=>step2.classList.remove("fadeSlide"), 250);
      }
    }

    function markVerified(){
      isVerified = true;

      step1Box.classList.remove("active");
      step1Box.classList.add("done");
      step1Badge.textContent = "✓";

      step2Box.classList.add("active");

      verifiedTag.classList.add("show");

      emailEl.readOnly = true;
      emailEl.style.opacity = ".92";
      sendCodeBtn.disabled = true;

      // 鎖 OTP
      otpInput.disabled = true;
      verifyBtn.disabled = true;

      toStep(2);
      showStatus("ok", "Email 驗證成功，請完成帳號資料後送出註冊。");
    }

    // 密碼顯示/隱藏
    togglePw?.addEventListener("click", () => {
      const now = pw.type === "password" ? "text" : "password";
      pw.type = now;
      togglePw.textContent = (now === "password") ? "顯示" : "隱藏";
    });

    // ---------- OTP 顯示層邏輯 ----------
    function getOtpDigits(){
      return String(otpInput.value || "").replace(/\D/g, "").slice(0, 6);
    }

    function paintOtp(){
      const digits = getOtpDigits();
      // 同步回 input（防止輸入非數字）
      otpInput.value = digits;

      otpBoxes.forEach((box, i) => {
        const ch = digits[i] || "";
        box.textContent = ch;
        box.classList.toggle("filled", !!ch);
        box.classList.remove("active");
      });

      // active 格：下一個要輸入的位置（滿 6 碼則停在最後一格）
      const idx = Math.min(digits.length, 5);
      otpBoxes[idx].classList.add("active");

      refreshVerifyState();
    }

    function refreshVerifyState(){
      const emailOk = isValidEmail(emailEl.value.trim().toLowerCase());
      const codeOk = /^\d{6}$/.test(getOtpDigits());
      verifyBtn.disabled = !(emailOk && codeOk) || isVerified;
    }

    // 點任何位置都 focus input
    otpWrap.addEventListener("click", () => {
      if(!isVerified && !otpInput.disabled) otpInput.focus();
    });

    // 支援點某一格也 focus
    otpBoxesWrap.addEventListener("click", () => {
      if(!isVerified && !otpInput.disabled) otpInput.focus();
    });

    otpInput.addEventListener("input", paintOtp);
    otpInput.addEventListener("keydown", (e) => {
      // 讓 backspace 行為更自然（其實原生已可用，但我們確保只留數字）
      if(e.key === " "){
        e.preventDefault();
      }
    });

    // 允許貼上（原生即可，input 事件會處理）
    otpInput.addEventListener("paste", () => {
      setTimeout(paintOtp, 0);
    });

    emailEl.addEventListener("input", refreshVerifyState);

    // init OTP
    paintOtp();

    // ---------- Cooldown ----------
    let cooldownTimer = null;
    function startCooldown(sec){
      let left = sec;
      cooldownEl.textContent = left;
      cooldownHint.style.display = "block";
      sendCodeBtn.disabled = true;

      cooldownTimer && clearInterval(cooldownTimer);
      cooldownTimer = setInterval(() => {
        left -= 1;
        cooldownEl.textContent = Math.max(0, left);
        if(left <= 0){
          clearInterval(cooldownTimer);
          cooldownTimer = null;
          cooldownHint.style.display = "none";
          if(!isVerified) sendCodeBtn.disabled = false;
          sendCodeText.textContent = "重新發送";
        }
      }, 1000);
    }

    // ---------- Send OTP ----------
    sendCodeBtn.addEventListener("click", async () => {
      clearStatus();
      const email = emailEl.value.trim().toLowerCase();

      if(!isValidEmail(email)){
        showStatus("bad", "Email 格式不正確");
        return;
      }

      try{
        setLoading(sendCodeBtn, true);
        sendCodeText.textContent = "發送中...";

        const res = await fetch("/.netlify/functions/otp-send", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ email })
        });

        const data = await res.json().catch(()=>({}));
        if(!res.ok){
          showStatus("bad", "發送失敗：" + (data.error || data.message || ("HTTP " + res.status)));
          return;
        }

        showStatus("ok", "已發送驗證碼，請到信箱查看。");
        sendCodeText.textContent = "已發送";
        startCooldown(60);
        otpInput.focus();

      }catch(err){
        showStatus("bad", "發送失敗：" + String(err?.message || err));
      }finally{
        setLoading(sendCodeBtn, false);
      }
    });

    // ---------- Verify OTP ----------
    verifyBtn.addEventListener("click", async () => {
      clearStatus();

      const email = emailEl.value.trim().toLowerCase();
      const code = getOtpDigits();

      if(!isValidEmail(email)){
        showStatus("bad", "Email 格式不正確");
        return;
      }
      if(!/^\d{6}$/.test(code)){
        showStatus("bad", "驗證碼請輸入 6 位數字");
        return;
      }

      try{
        setLoading(verifyBtn, true);

        const res = await fetch("/.netlify/functions/otp-verify", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ email, code })
        });

        const data = await res.json().catch(()=>({}));
        if(!res.ok){
          const reason = data.error || data.message || ("HTTP " + res.status);
          showStatus("bad", "驗證失敗：" + reason);
          return;
        }

        markVerified();

      }catch(err){
        showStatus("bad", "驗證失敗：" + String(err?.message || err));
      }finally{
        setLoading(verifyBtn, false);
      }
    });

    // ---------- Register (Step 2) ----------
    $("signupForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      clearStatus();

      if(!isVerified){
        showStatus("bad", "請先完成 Email 驗證。");
        toStep(1);
        return;
      }

      const name = $("name").value.trim();
      const username = $("username").value.trim();
      const password = $("password").value;
      const email = emailEl.value.trim().toLowerCase();

      if(username.length < 3){
        showStatus("bad", "帳號至少 3 個字");
        return;
      }
      if(password.length < 6){
        showStatus("bad", "密碼至少 6 個字");
        return;
      }
      if(!isValidEmail(email)){
        showStatus("bad", "Email 格式不正確");
        toStep(1);
        return;
      }

      const signupBtn = $("signupBtn");

      try{
        setLoading(signupBtn, true);

        const rRes = await fetch("/.netlify/functions/auth", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({
            action: "register",
            name,
            username,
            password,
            email
          })
        });

        const rData = await rRes.json().catch(()=>({}));
        if(!rRes.ok){
          showStatus("bad", "註冊失敗：" + (rData.error || rData.message || ("HTTP " + rRes.status)));
          return;
        }

        showStatus("ok", "註冊成功，即將跳轉登入頁...");
        setTimeout(() => location.href = "login.html", 700);

      }catch(err){
        showStatus("bad", "註冊失敗：" + String(err?.message || err));
      }finally{
        setLoading(signupBtn, false);
      }
    });

    // init verify state
    refreshVerifyState();
  </script>
</body>
</html>
